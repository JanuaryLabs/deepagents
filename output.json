{
  "configHash": "1d308ac83fe9150224529a0e831cb795",
  "points": {
    "personas": {
      "committed": false,
      "entries": [
        {
          "inputHash": "94a63a451f1a2204a927f8eb05439d1b",
          "output": [
            {
              "role": "Financial Analyst",
              "perspective": "As a financial analyst, I focus on revenue streams, profit margins, and customer spending patterns. I ask questions like: What is the total sales per month? Which customers generate the highest revenue? What are the top-selling tracks and genres? I care about aggregated totals, growth trends, and variance from budget. I prefer results in numeric tables with clear headings, and I value speed but not at the expense of accuracy. Domain concerns include accurate tax calculations and currency conversions.",
              "styles": ["formal", "interrogative"]
            },
            {
              "role": "Customer Support Rep",
              "perspective": "I need quick access to customer records, invoice status, and contact details. Typical queries: Who is customer X? What invoices are pending? Which track was purchased? I want concise, bullet‑style answers with minimal fluff. Speed is paramount; I rarely need aggregated reports. I also need to see the support representative linked to a customer to route tickets appropriately.",
              "styles": ["imperative", "concise"]
            },
            {
              "role": "Sales Manager",
              "perspective": "I oversee sales performance across artists, albums, and regions. I ask: Which artist drives the most sales? How do sales split by genre? What is the commission owed to sales reps? I rely on detailed dashboards, charts, and drill‑down tables. Accuracy and completeness are critical because they inform budgeting and commission calculations. I prefer data presented with clear totals, subtotals, and percentages.",
              "styles": ["formal", "descriptive"]
            },
            {
              "role": "Playlist Curator",
              "perspective": "I manage user playlists, adding and removing tracks, and analyze playlist popularity. I query: Which tracks appear most frequently? What is the composition of a playlist? Which genres dominate my top playlists? I like list‑style outputs, sometimes with track durations and composers. I value thoroughness over speed, as I want to curate high‑quality playlists.",
              "styles": ["colloquial", "descriptive"]
            },
            {
              "role": "Database Administrator",
              "perspective": "I maintain the database schema, enforce integrity, optimize queries, and monitor performance. I ask: Are all foreign keys correctly indexed? What is the execution time of complex joins? Are there any orphaned records? I need detailed technical information, error logs, and suggestions for schema changes. Accuracy and completeness are non‑negotiable, and I prefer formal, command‑style requests.",
              "styles": ["formal", "imperative"]
            }
          ]
        }
      ]
    },
    "basePairs": {
      "committed": true,
      "entries": [
        {
          "inputHash": "28db0e031bb1742a5572ea719dd05207",
          "output": [
            {
              "question": "What is the total revenue from all invoices?",
              "sql": "SELECT SUM(Total) AS TotalRevenue FROM Invoice;",
              "success": true
            },
            {
              "question": "How many customers are in our database?",
              "sql": "SELECT COUNT(*) AS total_customers FROM Customer;",
              "success": true
            },
            {
              "question": "How many invoices have been issued?",
              "sql": "SELECT COUNT(*) AS InvoiceCount FROM Invoice;",
              "success": true
            },
            {
              "question": "How many tracks are available in the catalog?",
              "sql": "SELECT COUNT(*) AS track_count FROM Track;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "69378936830c41406282080488f4b774",
          "output": [
            {
              "question": "Which customers had the highest total invoice amount in the last calendar quarter, and how much did each spend?",
              "sql": "WITH\n  current_date AS (SELECT date('now') AS today),\n  current_year_month AS (SELECT strftime('%Y', today) AS yr, strftime('%m', today) AS mon FROM current_date),\n  current_quarter_start AS (\n    SELECT date(yr || '-' ||\n      CASE\n        WHEN mon BETWEEN '01' AND '03' THEN '01'\n        WHEN mon BETWEEN '04' AND '06' THEN '04'\n        WHEN mon BETWEEN '07' AND '09' THEN '07'\n        ELSE '10'\n      END || '-01') AS start_date\n    FROM current_year_month\n  ),\n  last_quarter_start AS (\n    SELECT date(start_date, '-3 months') AS start_date\n    FROM current_quarter_start\n  ),\n  last_quarter_end AS (\n    SELECT date(start_date, '+3 months', '-1 day') AS end_date\n    FROM last_quarter_start\n  )\nSELECT c.CustomerId,\n       c.FirstName || ' ' || c.LastName AS CustomerName,\n       SUM(i.Total) AS TotalSpent\nFROM Invoice i\nJOIN Customer c ON i.CustomerId = c.CustomerId\nCROSS JOIN last_quarter_start lqs\nCROSS JOIN last_quarter_end lqe\nWHERE i.InvoiceDate BETWEEN lqs.start_date AND lqe.end_date\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nORDER BY TotalSpent DESC;",
              "success": true
            },
            {
              "question": "Among all artists, who generated the most revenue from track sales last year, and what were their total earnings?",
              "sql": "SELECT a.Name AS Artist,\n       ROUND(SUM(il.UnitPrice * il.Quantity), 2) AS TotalEarnings\nFROM Invoice i\nJOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Album al ON t.AlbumId = al.AlbumId\nJOIN Artist a ON al.ArtistId = a.ArtistId\nWHERE i.InvoiceDate >= date('now', '-1 year')\n  AND i.InvoiceDate < date('now')\nGROUP BY a.ArtistId, a.Name\nORDER BY TotalEarnings DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "Which music genres showed the greatest month‑to‑month revenue increase from January to February 2023, and what was the percentage growth?",
              "sql": "WITH jan AS (\n  SELECT g.GenreId, g.Name AS GenreName,\n         SUM(il.UnitPrice * il.Quantity) AS JanRevenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE i.InvoiceDate >= '2023-01-01' AND i.InvoiceDate < '2023-02-01'\n  GROUP BY g.GenreId, g.Name\n),\nfeb AS (\n  SELECT g.GenreId, g.Name AS GenreName,\n         SUM(il.UnitPrice * il.Quantity) AS FebRevenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE i.InvoiceDate >= '2023-02-01' AND i.InvoiceDate < '2023-03-01'\n  GROUP BY g.GenreId, g.Name\n)\nSELECT f.GenreName,\n       ((f.FebRevenue - j.JanRevenue) / j.JanRevenue) * 100 AS GrowthPercent\nFROM feb f\nJOIN jan j ON f.GenreId = j.GenreId\nWHERE j.JanRevenue > 0\nORDER BY GrowthPercent DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "For each country, how many invoices were issued and what was the average invoice total, and which country had the largest average?",
              "sql": "WITH country_stats AS (\n  SELECT\n    BillingCountry AS country,\n    COUNT(*) AS invoice_count,\n    AVG(Total) AS avg_total\n  FROM Invoice\n  GROUP BY BillingCountry\n)\nSELECT\n  country,\n  invoice_count,\n  avg_total,\n  CASE WHEN avg_total = (SELECT MAX(avg_total) FROM country_stats) THEN 1 ELSE 0 END AS is_max\nFROM country_stats\nORDER BY country;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "4eb07d55217c0b3062e7c0da34815b92",
          "output": [
            {
              "question": "For each month of 2023, which country had the largest percentage increase in total revenue compared to the same month in 2022, and what was that percentage?",
              "sql": "WITH revenue AS (\n  SELECT\n    strftime('%Y', i.InvoiceDate) AS year,\n    strftime('%m', i.InvoiceDate) AS month,\n    c.Country,\n    SUM(i.Total) AS total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE strftime('%Y', i.InvoiceDate) IN ('2022','2023')\n  GROUP BY year, month, c.Country\n),\npercent_change AS (\n  SELECT\n    r1.month,\n    r1.Country,\n    r1.total AS total_2023,\n    r2.total AS total_2022,\n    CASE\n      WHEN r2.total IS NULL OR r2.total = 0 THEN NULL\n      ELSE ((r1.total - r2.total) / r2.total) * 100\n    END AS pct_increase\n  FROM revenue r1\n  JOIN revenue r2\n    ON r1.year = '2023'\n   AND r2.year = '2022'\n   AND r1.month = r2.month\n   AND r1.Country = r2.Country\n)\nSELECT\n  month,\n  Country,\n  ROUND(pct_increase, 2) AS pct_increase\nFROM (\n  SELECT\n    month,\n    Country,\n    pct_increase,\n    ROW_NUMBER() OVER (PARTITION BY month ORDER BY pct_increase DESC) AS rn\n  FROM percent_change\n) t\nWHERE rn = 1\nORDER BY month;",
              "success": true
            },
            {
              "question": "Which customers have consistently increased their total spend month over month for the last 12 months, and what was their average month‑over‑month growth rate?",
              "sql": "WITH RECURSIVE calendar(month_start) AS (\n  SELECT date('now', 'start of month', '-11 months')\n  UNION ALL\n  SELECT date(month_start, '+1 month')\n  FROM calendar\n  WHERE month_start < date('now', 'start of month', '+0 month')\n),\nmonth_totals AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(i.Total) AS month_total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE i.InvoiceDate >= date('now', 'start of month', '-11 months')\n    AND i.InvoiceDate < date('now', 'start of month', '+1 month')\n  GROUP BY c.CustomerId, month\n),\ncustomer_months AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    strftime('%Y-%m', cal.month_start) AS month,\n    COALESCE(mt.month_total, 0) AS month_total\n  FROM Customer c\n  CROSS JOIN calendar cal\n  LEFT JOIN month_totals mt\n    ON mt.CustomerId = c.CustomerId\n    AND mt.month = strftime('%Y-%m', cal.month_start)\n),\ngrowth AS (\n  SELECT\n    cm.CustomerId,\n    cm.FirstName,\n    cm.LastName,\n    cm.month,\n    cm.month_total,\n    LAG(cm.month_total) OVER (PARTITION BY cm.CustomerId ORDER BY cm.month) AS prev_total,\n    CASE\n      WHEN LAG(cm.month_total) OVER (PARTITION BY cm.CustomerId ORDER BY cm.month) IS NULL THEN NULL\n      WHEN LAG(cm.month_total) OVER (PARTITION BY cm.CustomerId ORDER BY cm.month) = 0 THEN NULL\n      ELSE (cm.month_total - LAG(cm.month_total) OVER (PARTITION BY cm.CustomerId ORDER BY cm.month)) / LAG(cm.month_total) OVER (PARTITION BY cm.CustomerId ORDER BY cm.month)\n    END AS growth_rate\n  FROM customer_months cm\n),\nfiltered AS (\n  SELECT\n    g.CustomerId,\n    g.FirstName,\n    g.LastName,\n    COUNT(*) AS month_count,\n    SUM(CASE WHEN g.prev_total IS NOT NULL AND g.growth_rate > 0 THEN 1 ELSE 0 END) AS positive_growth_count,\n    AVG(g.growth_rate) AS avg_growth_rate\n  FROM growth g\n  GROUP BY g.CustomerId, g.FirstName, g.LastName\n  HAVING month_count = 12\n    AND positive_growth_count = 11\n)\nSELECT\n  CustomerId,\n  FirstName,\n  LastName,\n  avg_growth_rate\nFROM filtered\nORDER BY avg_growth_rate DESC;",
              "success": true
            },
            {
              "question": "For every genre, what is the average unit price of its tracks, how many of those tracks have been sold, what total revenue those sales generated, and how does this year’s revenue compare to the previous year’s revenue for that genre?",
              "sql": "SELECT\n  g.Name AS Genre,\n  ROUND(AVG(t.UnitPrice), 2) AS AvgUnitPrice,\n  SUM(il.Quantity) AS TracksSold,\n  ROUND(SUM(il.UnitPrice * il.Quantity), 2) AS TotalRevenue,\n  ROUND(\n    SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now') THEN il.UnitPrice * il.Quantity ELSE 0 END),\n    2\n  ) AS RevenueCurrentYear,\n  ROUND(\n    SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now', '-1 year') THEN il.UnitPrice * il.Quantity ELSE 0 END),\n    2\n  ) AS RevenuePreviousYear,\n  ROUND(\n    SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now') THEN il.UnitPrice * il.Quantity ELSE 0 END) -\n    SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now', '-1 year') THEN il.UnitPrice * il.Quantity ELSE 0 END),\n    2\n  ) AS RevenueChange,\n  ROUND(\n    CASE\n      WHEN SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now', '-1 year') THEN il.UnitPrice * il.Quantity ELSE 0 END) <> 0\n      THEN (\n        SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now') THEN il.UnitPrice * il.Quantity ELSE 0 END) -\n        SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now', '-1 year') THEN il.UnitPrice * il.Quantity ELSE 0 END)\n      ) / SUM(CASE WHEN strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now', '-1 year') THEN il.UnitPrice * il.Quantity ELSE 0 END) * 100\n      ELSE NULL\n    END,\n    2\n  ) AS RevenueChangePct\nFROM Genre g\nLEFT JOIN Track t ON t.GenreId = g.GenreId\nLEFT JOIN InvoiceLine il ON il.TrackId = t.TrackId\nLEFT JOIN Invoice i ON i.InvoiceId = il.InvoiceId\nGROUP BY g.GenreId, g.Name\nORDER BY g.Name;",
              "success": true
            },
            {
              "question": "Among employees who serve as support representatives, which ones have the highest average monthly invoice value per customer they support, considering only customers who have made at least two purchases in the last six months, and how does that average compare to the overall average across all employees?",
              "sql": "WITH recent_invoices AS (\n    SELECT InvoiceId, CustomerId, InvoiceDate, Total\n    FROM Invoice\n    WHERE InvoiceDate >= date('now', '-6 months')\n),\ncustomer_counts AS (\n    SELECT CustomerId, COUNT(*) AS invoice_count\n    FROM recent_invoices\n    GROUP BY CustomerId\n    HAVING invoice_count >= 2\n),\ncustomer_totals AS (\n    SELECT ci.CustomerId, SUM(ci.Total) AS total_last_6_months\n    FROM recent_invoices ci\n    JOIN customer_counts cc ON ci.CustomerId = cc.CustomerId\n    GROUP BY ci.CustomerId\n),\nrep_customer_totals AS (\n    SELECT c.SupportRepId, ct.CustomerId, ct.total_last_6_months\n    FROM Customer c\n    JOIN customer_totals ct ON c.CustomerId = ct.CustomerId\n    WHERE c.SupportRepId IS NOT NULL\n),\nrep_stats AS (\n    SELECT r.SupportRepId,\n           AVG(r.total_last_6_months / 6.0) AS avg_monthly_per_customer\n    FROM rep_customer_totals r\n    GROUP BY r.SupportRepId\n),\noverall_avg AS (\n    SELECT AVG(avg_monthly_per_customer) AS overall_avg\n    FROM rep_stats\n),\nmax_avg AS (\n    SELECT MAX(avg_monthly_per_customer) AS max_avg\n    FROM rep_stats\n)\nSELECT e.EmployeeId,\n       e.LastName,\n       e.FirstName,\n       rs.avg_monthly_per_customer,\n       oa.overall_avg\nFROM rep_stats rs\nJOIN Employee e ON rs.SupportRepId = e.EmployeeId\nJOIN overall_avg oa\nJOIN max_avg ma ON rs.avg_monthly_per_customer = ma.max_avg;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "daa3201746f04ae1cb46ab09d1ed56b2",
          "output": [
            {
              "question": "What is the running total of total invoice amounts per month for the last two years, and how does each month’s total compare to the previous month in terms of growth percentage?",
              "sql": "WITH monthly_totals AS (\n  SELECT\n    strftime('%Y-%m', InvoiceDate) AS month,\n    SUM(Total) AS month_total\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-2 years')\n  GROUP BY month\n  ORDER BY month\n),\nrunning AS (\n  SELECT\n    month,\n    month_total,\n    SUM(month_total) OVER (ORDER BY month) AS running_total,\n    LAG(month_total) OVER (ORDER BY month) AS prev_month_total\n  FROM monthly_totals\n)\nSELECT\n  month,\n  month_total,\n  running_total,\n  CASE\n    WHEN prev_month_total IS NULL OR prev_month_total = 0 THEN NULL\n    ELSE ROUND((month_total - prev_month_total) / prev_month_total * 100, 2)\n  END AS growth_percent\nFROM running\nORDER BY month;",
              "success": true
            },
            {
              "question": "Rank customers within each country by their total spend, and show the top 5 customers per country along with the percentage of that country’s total revenue they represent.",
              "sql": "WITH customer_spend AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName || ' ' || c.LastName AS CustomerName,\n    c.Country,\n    SUM(i.Total) AS TotalSpend\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  GROUP BY c.CustomerId, c.FirstName, c.LastName, c.Country\n),\ncountry_totals AS (\n  SELECT\n    Country,\n    SUM(TotalSpend) AS CountryTotalRevenue\n  FROM customer_spend\n  GROUP BY Country\n),\nranked AS (\n  SELECT\n    cs.Country,\n    cs.CustomerId,\n    cs.CustomerName,\n    cs.TotalSpend,\n    ct.CountryTotalRevenue,\n    (cs.TotalSpend / ct.CountryTotalRevenue) * 100 AS Percentage,\n    RANK() OVER (PARTITION BY cs.Country ORDER BY cs.TotalSpend DESC) AS rnk\n  FROM customer_spend cs\n  JOIN country_totals ct ON cs.Country = ct.Country\n)\nSELECT\n  Country,\n  CustomerId,\n  CustomerName,\n  TotalSpend,\n  CountryTotalRevenue,\n  Percentage\nFROM ranked\nWHERE rnk <= 5\nORDER BY Country, rnk;",
              "success": true
            },
            {
              "question": "Calculate the moving average of monthly invoice totals over the past six months for each genre, and identify genres where the current month’s average is at least fifteen percent higher than that genre’s overall average.",
              "sql": "WITH monthly_totals AS (\n  SELECT\n    g.GenreId,\n    g.Name AS GenreName,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(il.UnitPrice * il.Quantity) AS total\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY g.GenreId, month\n),\nmoving_avg AS (\n  SELECT\n    GenreId,\n    GenreName,\n    month,\n    total,\n    AVG(total) OVER (PARTITION BY GenreId ORDER BY month\n                     ROWS BETWEEN 5 PRECEDING AND CURRENT ROW) AS moving_avg_6m\n  FROM monthly_totals\n),\noverall_avg AS (\n  SELECT\n    GenreId,\n    AVG(total) AS overall_avg\n  FROM monthly_totals\n  GROUP BY GenreId\n),\ncurrent_month AS (\n  SELECT MAX(month) AS current_month FROM monthly_totals\n)\nSELECT\n  ma.GenreName,\n  ma.month AS current_month,\n  ma.moving_avg_6m AS current_month_moving_avg,\n  oa.overall_avg\nFROM moving_avg ma\nJOIN overall_avg oa ON ma.GenreId = oa.GenreId\nJOIN current_month cm ON ma.month = cm.current_month\nWHERE ma.moving_avg_6m >= 1.15 * oa.overall_avg;",
              "success": true
            },
            {
              "question": "Determine the trend of track sales by comparing the quantity sold in the current quarter versus the previous quarter, and rank tracks by the percentage change, highlighting tracks with a decline greater than thirty percent.",
              "sql": "WITH current_quarter AS (\n  SELECT CAST(strftime('%Y', date('now')) AS INTEGER) AS year,\n         ((CAST(strftime('%m', date('now')) AS INTEGER)-1)/3)+1 AS quarter\n),\nprevious_quarter AS (\n  SELECT CASE WHEN cq.quarter > 1 THEN cq.year ELSE cq.year - 1 END AS year,\n         CASE WHEN cq.quarter > 1 THEN cq.quarter - 1 ELSE 4 END AS quarter\n  FROM current_quarter cq\n),\nsales AS (\n  SELECT il.TrackId,\n         t.Name AS TrackName,\n         CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) AS year,\n         ((CAST(strftime('%m', i.InvoiceDate) AS INTEGER)-1)/3)+1 AS quarter,\n         SUM(il.Quantity) AS quantity\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  GROUP BY il.TrackId, t.Name, year, quarter\n),\ncurrent_sales AS (\n  SELECT TrackId, TrackName, quantity AS current_qty\n  FROM sales\n  JOIN current_quarter cq ON sales.year = cq.year AND sales.quarter = cq.quarter\n),\nprevious_sales AS (\n  SELECT TrackId, quantity AS previous_qty\n  FROM sales\n  JOIN previous_quarter pq ON sales.year = pq.year AND sales.quarter = pq.quarter\n),\ncombined AS (\n  SELECT cs.TrackId,\n         cs.TrackName,\n         cs.current_qty,\n         COALESCE(ps.previous_qty, 0) AS previous_qty\n  FROM current_sales cs\n  LEFT JOIN previous_sales ps ON cs.TrackId = ps.TrackId\n),\nresult AS (\n  SELECT TrackId,\n         TrackName,\n         current_qty,\n         previous_qty,\n         CASE\n           WHEN previous_qty = 0 THEN NULL\n           ELSE ((current_qty - previous_qty) * 100.0 / previous_qty)\n         END AS percent_change,\n         CASE\n           WHEN ((current_qty - previous_qty) * 100.0 / previous_qty) < -30 THEN 1 ELSE 0\n         END AS decline_over_30\n  FROM combined\n)\nSELECT TrackName,\n       current_qty,\n       previous_qty,\n       percent_change,\n       decline_over_30,\n       RANK() OVER (ORDER BY percent_change DESC) AS rank\nFROM result\nORDER BY percent_change DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "349dc428dad0054e52862b915d4a839f",
          "output": [
            {
              "question": "Who is customer 42?",
              "sql": "SELECT FirstName, LastName, Email, Company, Address, City, State, Country, PostalCode, Phone, Fax, SupportRepId FROM Customer WHERE CustomerId = 42;",
              "success": true
            },
            {
              "question": "Which invoices have a total greater than $0?",
              "sql": "SELECT InvoiceId, CustomerId, InvoiceDate, Total FROM Invoice WHERE Total > 0;",
              "success": true
            },
            {
              "question": "Which tracks have been sold?",
              "sql": "SELECT DISTINCT t.TrackId, t.Name\nFROM Track t\nJOIN InvoiceLine il ON t.TrackId = il.TrackId\nORDER BY t.Name;",
              "success": true
            },
            {
              "question": "Which support representative is assigned to customer 42?",
              "sql": "SELECT e.EmployeeId, e.FirstName, e.LastName\nFROM Customer c\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nWHERE c.CustomerId = 42;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "437959a61dcef3a611e2341db69570b6",
          "output": [
            {
              "question": "Which customers are assigned to the support representative with last name 'Smith' and have placed invoices totaling more than $200 in the last year?",
              "sql": "SELECT c.CustomerId, c.FirstName, c.LastName, c.Email\nFROM Customer c\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nJOIN Invoice i ON c.CustomerId = i.CustomerId\nWHERE e.LastName = 'Smith'\n  AND i.InvoiceDate >= date('now', '-1 year')\nGROUP BY c.CustomerId, c.FirstName, c.LastName, c.Email\nHAVING SUM(i.Total) > 200;",
              "success": true
            },
            {
              "question": "What tracks have been sold in invoices where the customer lives in California and the support rep works in the same state?",
              "sql": "SELECT DISTINCT t.Name\nFROM Track t\nJOIN InvoiceLine il ON t.TrackId = il.TrackId\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Customer c ON i.CustomerId = c.CustomerId\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nWHERE c.State = 'California'\n  AND e.State = c.State\nORDER BY t.Name;",
              "success": true
            },
            {
              "question": "Which media types have tracks that have never been purchased in any invoice line?",
              "sql": "SELECT DISTINCT mt.Name\nFROM MediaType mt\nJOIN Track t ON t.MediaTypeId = mt.MediaTypeId\nLEFT JOIN InvoiceLine il ON il.TrackId = t.TrackId\nWHERE il.InvoiceLineId IS NULL;",
              "success": true
            },
            {
              "question": "Which genres have an average track price above $1.50 and have sold more than 10 tracks in the past six months?",
              "sql": "SELECT g.Name\nFROM Genre g\nJOIN Track t ON t.GenreId = g.GenreId\nJOIN InvoiceLine il ON il.TrackId = t.TrackId\nJOIN Invoice i ON i.InvoiceId = il.InvoiceId\nWHERE i.InvoiceDate >= date('now', '-6 months')\nGROUP BY g.GenreId, g.Name\nHAVING AVG(t.UnitPrice) > 1.50 AND SUM(il.Quantity) > 10;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "8bb658e3698263706e1eee4d04011f9d",
          "output": [
            {
              "question": "Which customers from California spent more than the average invoice total for the past year, and how many invoices have they issued?",
              "sql": "WITH avg_invoice AS (\n    SELECT AVG(Total) AS avg_total\n    FROM Invoice\n    WHERE InvoiceDate >= date('now', '-1 year')\n)\nSELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    SUM(i.Total) AS total_spent,\n    COUNT(i.InvoiceId) AS invoice_count\nFROM Customer c\nJOIN Invoice i ON c.CustomerId = i.CustomerId\nWHERE c.State = 'California'\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nHAVING SUM(i.Total) > (SELECT avg_total FROM avg_invoice)\nORDER BY total_spent DESC;",
              "success": true
            },
            {
              "question": "What is each support representative’s month-over-month change in total sales, and which representative had the biggest increase in the last two months?",
              "sql": "WITH monthly_sales AS (\n  SELECT\n    c.SupportRepId,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(i.Total) AS total_sales\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  GROUP BY c.SupportRepId, month\n),\nsales_change AS (\n  SELECT\n    ms.SupportRepId,\n    ms.month,\n    ms.total_sales,\n    ms.total_sales - LAG(ms.total_sales) OVER (PARTITION BY ms.SupportRepId ORDER BY ms.month) AS change\n  FROM monthly_sales ms\n),\nmax_change AS (\n  SELECT\n    sc.SupportRepId,\n    sc.change\n  FROM sales_change sc\n  WHERE sc.month = (SELECT MAX(month) FROM monthly_sales)\n  ORDER BY sc.change DESC\n  LIMIT 1\n)\nSELECT\n  e.EmployeeId,\n  e.FirstName || ' ' || e.LastName AS rep_name,\n  sc.month,\n  sc.total_sales,\n  sc.change,\n  CASE WHEN sc.SupportRepId = mc.SupportRepId THEN 1 ELSE 0 END AS biggest_increase_last_month\nFROM sales_change sc\nJOIN Employee e ON sc.SupportRepId = e.EmployeeId\nLEFT JOIN max_change mc ON sc.SupportRepId = mc.SupportRepId\nORDER BY sc.SupportRepId, sc.month;",
              "success": true
            },
            {
              "question": "Which tracks were bought by customers who have never had an invoice total over $100 in the last year, and what is the total revenue generated for each of those tracks?",
              "sql": "WITH eligible_customers AS (\n  SELECT CustomerId\n  FROM Customer\n  WHERE NOT EXISTS (\n    SELECT 1\n    FROM Invoice i\n    WHERE i.CustomerId = Customer.CustomerId\n      AND i.InvoiceDate >= date('now', '-1 year')\n      AND i.Total > 100\n  )\n)\nSELECT t.Name AS TrackName,\n       SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM InvoiceLine il\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nWHERE i.CustomerId IN (SELECT CustomerId FROM eligible_customers)\nGROUP BY t.TrackId, t.Name\nORDER BY TotalRevenue DESC;",
              "success": true
            },
            {
              "question": "Which support representatives handled more invoices per month than the average across all representatives in the last six months, and how does their average invoice total compare to the overall average?",
              "sql": "WITH invoices_last6 AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total,\n         c.SupportRepId\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE i.InvoiceDate >= date('now', '-6 months')\n),\nrep_stats AS (\n  SELECT\n    e.EmployeeId,\n    e.FirstName || ' ' || e.LastName AS RepName,\n    COUNT(DISTINCT il.InvoiceId) AS TotalInvoices,\n    AVG(il.Total) AS AvgInvoiceTotal\n  FROM invoices_last6 il\n  JOIN Employee e ON il.SupportRepId = e.EmployeeId\n  GROUP BY e.EmployeeId\n),\noverall_stats AS (\n  SELECT\n    COUNT(DISTINCT il.InvoiceId) AS TotalInvoices,\n    AVG(il.Total) AS AvgInvoiceTotal,\n    COUNT(DISTINCT il.SupportRepId) AS NumReps\n  FROM invoices_last6 il\n)\nSELECT\n  rs.RepName,\n  rs.TotalInvoices / 6.0 AS AvgInvoicesPerMonth,\n  rs.AvgInvoiceTotal,\n  os.AvgInvoiceTotal AS OverallAvgInvoiceTotal,\n  rs.AvgInvoiceTotal - os.AvgInvoiceTotal AS AvgInvoiceTotalDiff\nFROM rep_stats rs\nCROSS JOIN overall_stats os\nWHERE rs.TotalInvoices / 6.0 > (os.TotalInvoices / (os.NumReps * 6.0));",
              "success": true
            }
          ]
        },
        {
          "inputHash": "b36b4a9386827e78962f5cac200ff1f7",
          "output": [
            {
              "question": "Rank customers in each state by their total invoice amount for the current year, showing the top 5 in each state and the margin between each customer's total and the top spender in that state.",
              "sql": "WITH yearly_totals AS (\n  SELECT\n    c.CustomerId,\n    c.State,\n    SUM(i.Total) AS total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now')\n  GROUP BY c.CustomerId, c.State\n),\nranked AS (\n  SELECT\n    CustomerId,\n    State,\n    total,\n    RANK() OVER (PARTITION BY State ORDER BY total DESC) AS rnk,\n    MAX(total) OVER (PARTITION BY State) AS top_total\n  FROM yearly_totals\n)\nSELECT\n  State,\n  CustomerId,\n  total,\n  rnk,\n  top_total - total AS margin\nFROM ranked\nWHERE rnk <= 5\nORDER BY State, rnk;",
              "success": true
            },
            {
              "question": "Show the running total of invoice totals for each customer over time, and highlight any points where the running total crosses $5,000.",
              "sql": "WITH Running AS (\n  SELECT\n    i.CustomerId,\n    i.InvoiceDate,\n    SUM(i.Total) OVER (PARTITION BY i.CustomerId ORDER BY i.InvoiceDate\n                       ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal\n  FROM Invoice i\n)\nSELECT\n  r.CustomerId,\n  c.FirstName,\n  c.LastName,\n  r.InvoiceDate,\n  r.RunningTotal,\n  CASE WHEN r.RunningTotal > 5000\n           AND COALESCE(LAG(r.RunningTotal) OVER (PARTITION BY r.CustomerId ORDER BY r.InvoiceDate),0) <= 5000\n       THEN 1 ELSE 0 END AS Crossed5000\nFROM Running r\nJOIN Customer c ON r.CustomerId = c.CustomerId\nORDER BY r.CustomerId, r.InvoiceDate;",
              "success": true
            },
            {
              "question": "For each customer, list the most recent invoice, the number of tracks purchased in that invoice, the average unit price of those tracks, and the support representative's name, ordered by the invoice date descending.",
              "sql": "WITH recent_invoices AS (\n  SELECT i.InvoiceId,\n         i.CustomerId,\n         i.InvoiceDate,\n         i.Total,\n         c.SupportRepId,\n         ROW_NUMBER() OVER (PARTITION BY i.CustomerId ORDER BY i.InvoiceDate DESC) AS rn\n  FROM Invoice i\n  JOIN Customer c ON c.CustomerId = i.CustomerId\n)\nSELECT r.CustomerId,\n       c.FirstName || ' ' || c.LastName AS CustomerName,\n       r.InvoiceId,\n       r.InvoiceDate,\n       r.Total,\n       COUNT(il.InvoiceLineId) AS TrackCount,\n       AVG(il.UnitPrice) AS AvgUnitPrice,\n       e.FirstName || ' ' || e.LastName AS SupportRepName\nFROM recent_invoices r\nJOIN Customer c ON c.CustomerId = r.CustomerId\nJOIN InvoiceLine il ON il.InvoiceId = r.InvoiceId\nJOIN Employee e ON e.EmployeeId = r.SupportRepId\nWHERE r.rn = 1\nGROUP BY r.InvoiceId, r.InvoiceDate, r.Total, r.SupportRepId, r.CustomerId, c.FirstName, c.LastName, e.FirstName, e.LastName\nORDER BY r.InvoiceDate DESC;",
              "success": false
            },
            {
              "question": "Identify customers who have had an invoice in the last 60 days that contains tracks from a genre with a higher average price than the genre's overall average, and calculate how many days have passed since that invoice.",
              "sql": "WITH overall_avg AS (\n  SELECT AVG(UnitPrice) AS avg_price FROM Track\n),\ngenre_avg AS (\n  SELECT GenreId, AVG(UnitPrice) AS avg_price\n  FROM Track\n  GROUP BY GenreId\n),\neligible_genres AS (\n  SELECT g.GenreId\n  FROM genre_avg g\n  JOIN overall_avg o ON 1=1\n  WHERE g.avg_price > o.avg_price\n),\neligible_invoices AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  WHERE i.InvoiceDate >= date('now', '-60 days')\n    AND t.GenreId IN (SELECT GenreId FROM eligible_genres)\n),\nlatest_invoice_per_customer AS (\n  SELECT CustomerId, MAX(InvoiceDate) AS latest_date\n  FROM eligible_invoices\n  GROUP BY CustomerId\n)\nSELECT c.CustomerId, c.FirstName, c.LastName,\n       CAST(julianday('now') - julianday(l.latest_date) AS INTEGER) AS days_since_invoice\nFROM latest_invoice_per_customer l\nJOIN Customer c ON l.CustomerId = c.CustomerId;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "35a069a71beef1e0a1c504b111bf1b9b",
          "output": [
            {
              "question": "How many customers are in the database?",
              "sql": "SELECT COUNT(*) AS customer_count FROM Customer;",
              "success": true
            },
            {
              "question": "What is the total revenue from all invoices?",
              "sql": "SELECT SUM(Total) AS TotalRevenue FROM Invoice;",
              "success": true
            },
            {
              "question": "How many artists are represented in our catalog?",
              "sql": "SELECT COUNT(*) AS ArtistCount FROM Artist;",
              "success": true
            },
            {
              "question": "What is the total number of tracks we have?",
              "sql": "SELECT COUNT(*) AS total_tracks FROM Track;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "b9e17f094b240e94aedbc553c0b5ab55",
          "output": [
            {
              "question": "Which artist has generated the highest total sales revenue across all invoices?",
              "sql": "SELECT a.Name AS ArtistName,\n       SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM Artist a\nJOIN Album al ON a.ArtistId = al.ArtistId\nJOIN Track t ON al.AlbumId = t.AlbumId\nJOIN InvoiceLine il ON t.TrackId = il.TrackId\nGROUP BY a.ArtistId, a.Name\nORDER BY TotalRevenue DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "How are sales distributed across different music genres, expressed as total revenue and percentage of overall sales?",
              "sql": "SELECT g.Name AS Genre, SUM(il.UnitPrice * il.Quantity) AS TotalRevenue, ROUND(100.0 * SUM(il.UnitPrice * il.Quantity) / (SELECT SUM(UnitPrice * Quantity) FROM InvoiceLine), 2) AS Percentage FROM InvoiceLine il JOIN Track t ON il.TrackId = t.TrackId JOIN Genre g ON t.GenreId = g.GenreId GROUP BY g.Name ORDER BY TotalRevenue DESC;",
              "success": true
            },
            {
              "question": "What is the total commission owed to each sales representative if they receive 10% of the total invoices for the customers they support?",
              "sql": "SELECT e.EmployeeId,\n       e.FirstName,\n       e.LastName,\n       COALESCE(SUM(i.Total),0) * 0.10 AS Commission\nFROM Employee e\nLEFT JOIN Customer c ON c.SupportRepId = e.EmployeeId\nLEFT JOIN Invoice i ON i.CustomerId = c.CustomerId\nGROUP BY e.EmployeeId, e.FirstName, e.LastName;",
              "success": true
            },
            {
              "question": "Which albums sold more than 500 copies in the last 12 months, and what were the total units sold?",
              "sql": "SELECT a.Title, SUM(il.Quantity) AS TotalUnitsSold\nFROM Invoice i\nJOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Album a ON t.AlbumId = a.AlbumId\nWHERE i.InvoiceDate >= date('now', '-12 months')\nGROUP BY a.AlbumId, a.Title\nHAVING SUM(il.Quantity) > 500\nORDER BY TotalUnitsSold DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "c0fc8d7a8e801cdc8e0db4151c37a447",
          "output": [
            {
              "question": "Which artist has generated the highest total revenue from invoices in the last fiscal year, broken down by month, and how does that compare to the previous year’s monthly totals?",
              "sql": "WITH revenue AS (\n  SELECT\n    a.ArtistId,\n    a.Name AS ArtistName,\n    strftime('%Y-%m', i.InvoiceDate) AS year_month,\n    SUM(il.UnitPrice * il.Quantity) AS revenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  GROUP BY a.ArtistId, year_month\n),\nlast_year AS (\n  SELECT\n    ArtistId,\n    ArtistName,\n    substr(year_month, 1, 7) AS month,\n    SUM(revenue) AS total_revenue\n  FROM revenue\n  WHERE substr(year_month, 1, 4) = strftime('%Y', date('now', '-1 year'))\n  GROUP BY ArtistId, month\n),\nprev_year AS (\n  SELECT\n    ArtistId,\n    ArtistName,\n    substr(year_month, 1, 7) AS month,\n    SUM(revenue) AS total_revenue\n  FROM revenue\n  WHERE substr(year_month, 1, 4) = strftime('%Y', date('now', '-2 year'))\n  GROUP BY ArtistId, month\n),\nmax_artist AS (\n  SELECT ArtistId, ArtistName\n  FROM last_year\n  GROUP BY ArtistId, ArtistName\n  ORDER BY SUM(total_revenue) DESC\n  LIMIT 1\n)\nSELECT\n  ma.ArtistName,\n  ly.month,\n  ly.total_revenue AS revenue_last_year,\n  py.total_revenue AS revenue_prev_year\nFROM last_year ly\nLEFT JOIN prev_year py ON ly.ArtistId = py.ArtistId AND ly.month = py.month\nJOIN max_artist ma ON ly.ArtistId = ma.ArtistId\nORDER BY ly.month;",
              "success": true
            },
            {
              "question": "What is the total sales revenue per genre for each quarter of the current year, and which genre had the largest year‑over‑year growth in revenue?",
              "sql": "WITH revenue AS (\n  SELECT\n    g.Name AS Genre,\n    strftime('%Y', i.InvoiceDate) AS Year,\n    ((strftime('%m', i.InvoiceDate)-1)/3 + 1) AS Quarter,\n    SUM(il.UnitPrice * il.Quantity) AS Revenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY g.Name, Year, Quarter\n),\ncurrent_year_revenue AS (\n  SELECT Genre, Quarter, Revenue\n  FROM revenue\n  WHERE Year = strftime('%Y', 'now')\n),\nprevious_year_revenue AS (\n  SELECT Genre, Revenue AS PrevRevenue\n  FROM revenue\n  WHERE Year = strftime('%Y', 'now') - 1\n),\ngrowth AS (\n  SELECT\n    c.Genre,\n    c.Quarter,\n    c.Revenue,\n    COALESCE(p.PrevRevenue, 0) AS PrevRevenue,\n    CASE WHEN p.PrevRevenue IS NULL OR p.PrevRevenue = 0 THEN NULL\n         ELSE (c.Revenue - p.PrevRevenue) / p.PrevRevenue\n    END AS YoYGrowth\n  FROM current_year_revenue c\n  LEFT JOIN previous_year_revenue p ON c.Genre = p.Genre\n)\nSELECT Genre, Quarter, Revenue, YoYGrowth\nFROM growth\nORDER BY Genre, Quarter;\n\n-- Genre with largest year‑over‑year growth\nWITH total_revenue AS (\n  SELECT\n    g.Name AS Genre,\n    strftime('%Y', i.InvoiceDate) AS Year,\n    SUM(il.UnitPrice * il.Quantity) AS Revenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY g.Name, Year\n),\ncurrent_year_total AS (\n  SELECT Genre, Revenue\n  FROM total_revenue\n  WHERE Year = strftime('%Y', 'now')\n),\nprevious_year_total AS (\n  SELECT Genre, Revenue\n  FROM total_revenue\n  WHERE Year = strftime('%Y', 'now') - 1\n),\ngrowth_total AS (\n  SELECT\n    c.Genre,\n    c.Revenue AS CurrentRevenue,\n    p.Revenue AS PrevRevenue,\n    CASE WHEN p.Revenue IS NULL OR p.Revenue = 0 THEN NULL\n         ELSE (c.Revenue - p.Revenue) / p.Revenue\n    END AS YoYGrowth\n  FROM current_year_total c\n  LEFT JOIN previous_year_total p ON c.Genre = p.Genre\n)\nSELECT Genre, YoYGrowth\nFROM growth_total\nORDER BY YoYGrowth DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "How many customers in each state have spent more than $500 in the past year, and what is the average commission paid to their assigned sales representative based on a 10% commission rate?",
              "sql": "WITH customer_spending AS (\n  SELECT c.CustomerId,\n         c.State,\n         SUM(i.Total) AS total_spent\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE i.InvoiceDate >= datetime('now', '-1 year')\n  GROUP BY c.CustomerId, c.State\n)\nSELECT\n  cs.State,\n  COUNT(*) AS customer_count,\n  ROUND(AVG(cs.total_spent * 0.10), 2) AS avg_commission\nFROM customer_spending cs\nWHERE cs.total_spent > 500\nGROUP BY cs.State\nORDER BY cs.State;",
              "success": true
            },
            {
              "question": "Which playlists contain tracks that together exceed 10,000 seconds of total playtime, and what percentage of the total track count in those playlists does each playlist represent?",
              "sql": "SELECT\n    p.Name AS PlaylistName,\n    ROUND(SUM(t.Milliseconds) / 1000.0, 2) AS TotalSeconds,\n    COUNT(*) AS TrackCount,\n    ROUND(100.0 * COUNT(*) / (SELECT COUNT(*) FROM PlaylistTrack), 2) AS PercentOfTotal\nFROM\n    Playlist p\nJOIN\n    PlaylistTrack pt ON p.PlaylistId = pt.PlaylistId\nJOIN\n    Track t ON pt.TrackId = t.TrackId\nGROUP BY\n    p.PlaylistId, p.Name\nHAVING\n    SUM(t.Milliseconds) > 10000000;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "8c1c0f2bfe1eb187f79c8a4821b0ea84",
          "output": [
            {
              "question": "What is the running total of sales for each artist, broken down by month, and which artist has the highest cumulative sales at each month?",
              "sql": "WITH monthly_sales AS (\n  SELECT\n    a.ArtistId,\n    a.Name AS ArtistName,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(il.UnitPrice * il.Quantity) AS monthly_sales\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  GROUP BY a.ArtistId, month\n),\nrunning_totals AS (\n  SELECT\n    ArtistId,\n    ArtistName,\n    month,\n    monthly_sales,\n    SUM(monthly_sales) OVER (PARTITION BY ArtistId ORDER BY month) AS cumulative_sales\n  FROM monthly_sales\n),\ntop_artists AS (\n  SELECT\n    month,\n    ArtistName,\n    cumulative_sales,\n    RANK() OVER (PARTITION BY month ORDER BY cumulative_sales DESC) AS rnk\n  FROM running_totals\n)\nSELECT\n  month,\n  ArtistName,\n  cumulative_sales\nFROM running_totals\nORDER BY month, ArtistName;\n\nSELECT\n  month,\n  ArtistName,\n  cumulative_sales\nFROM top_artists\nWHERE rnk = 1\nORDER BY month;",
              "success": true
            },
            {
              "question": "Rank the albums within each artist by total revenue and show the percentage that each album contributes to that artist's overall sales, including the running subtotal for the top 3 albums.",
              "sql": "WITH AlbumRevenue AS (\n  SELECT\n    a.ArtistId,\n    a.AlbumId,\n    a.Title AS AlbumTitle,\n    SUM(il.UnitPrice * il.Quantity) AS AlbumRevenue\n  FROM Album a\n  JOIN Track t ON t.AlbumId = a.AlbumId\n  JOIN InvoiceLine il ON il.TrackId = t.TrackId\n  GROUP BY a.ArtistId, a.AlbumId, a.Title\n),\nArtistTotals AS (\n  SELECT\n    ArtistId,\n    SUM(AlbumRevenue) AS ArtistTotalRevenue\n  FROM AlbumRevenue\n  GROUP BY ArtistId\n),\nRankedAlbums AS (\n  SELECT\n    ar.ArtistId,\n    ar.AlbumId,\n    ar.AlbumTitle,\n    ar.AlbumRevenue,\n    at.ArtistTotalRevenue,\n    ROW_NUMBER() OVER (PARTITION BY ar.ArtistId ORDER BY ar.AlbumRevenue DESC) AS AlbumRank,\n    (ar.AlbumRevenue * 100.0 / at.ArtistTotalRevenue) AS AlbumPercent\n  FROM AlbumRevenue ar\n  JOIN ArtistTotals at ON at.ArtistId = ar.ArtistId\n)\nSELECT\n  ra.ArtistId,\n  ra.AlbumId,\n  ra.AlbumTitle,\n  ra.AlbumRevenue,\n  ra.ArtistTotalRevenue,\n  ra.AlbumPercent,\n  ra.AlbumRank,\n  CASE\n    WHEN ra.AlbumRank <= 3 THEN SUM(ra.AlbumRevenue) OVER (PARTITION BY ra.ArtistId ORDER BY ra.AlbumRevenue DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\n    ELSE NULL\n  END AS RunningSubtotalTop3\nFROM RankedAlbums ra\nORDER BY ra.ArtistId, ra.AlbumRank;",
              "success": true
            },
            {
              "question": "For each customer region (state), what is the 3‑month moving average of total invoice amounts, and which region shows the largest upward trend over the last quarter?",
              "sql": "-- 1. 3‑month moving average of total invoice amounts per state\nWITH monthly_totals AS (\n  SELECT\n    c.State,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(i.Total) AS month_total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  GROUP BY c.State, month\n),\nmoving_avg AS (\n  SELECT\n    State,\n    month,\n    month_total,\n    AVG(month_total) OVER (PARTITION BY State ORDER BY month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg\n  FROM monthly_totals\n)\nSELECT\n  State,\n  month,\n  moving_avg\nFROM moving_avg\nORDER BY State, month;\n\n-- 2. State with the largest upward trend over the last quarter\nWITH monthly_totals AS (\n  SELECT\n    c.State,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(i.Total) AS month_total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  GROUP BY c.State, month\n),\nmoving_avg AS (\n  SELECT\n    State,\n    month,\n    month_total,\n    AVG(month_total) OVER (PARTITION BY State ORDER BY month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg\n  FROM monthly_totals\n),\ntrend AS (\n  SELECT\n    State,\n    month,\n    moving_avg,\n    moving_avg - LAG(moving_avg, 3) OVER (PARTITION BY State ORDER BY month) AS trend_diff\n  FROM moving_avg\n),\nlast_month AS (\n  SELECT\n    State,\n    MAX(month) AS last_month\n  FROM moving_avg\n  GROUP BY State\n),\nlast_trend AS (\n  SELECT\n    t.State,\n    t.month,\n    t.moving_avg,\n    t.trend_diff\n  FROM trend t\n  JOIN last_month lm ON t.State = lm.State AND t.month = lm.last_month\n)\nSELECT\n  lt.State AS region,\n  lt.trend_diff AS upward_trend\nFROM last_trend lt\nORDER BY lt.trend_diff DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "Calculate the commission owed to each sales representative by summing the total invoice amounts for customers they support, and then rank the reps by commission amount, showing the month‑over‑month change using lag/lead comparisons.",
              "sql": "WITH rep_comm AS ( SELECT e.EmployeeId AS SupportRepId, e.FirstName || ' ' || e.LastName AS RepName, strftime('%Y-%m', i.InvoiceDate) AS Month, SUM(i.Total) AS Commission FROM Invoice i JOIN Customer c ON i.CustomerId = c.CustomerId JOIN Employee e ON c.SupportRepId = e.EmployeeId GROUP BY e.EmployeeId, Month ), ranked AS ( SELECT SupportRepId, RepName, Month, Commission, RANK() OVER (PARTITION BY Month ORDER BY Commission DESC) AS Rank, Commission - LAG(Commission) OVER (PARTITION BY SupportRepId ORDER BY Month) AS Change FROM rep_comm ) SELECT * FROM ranked ORDER BY Month, Rank;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "68977aa022b2ab9a97becbcbd841a1e5",
          "output": [
            {
              "question": "How many times does each track appear in all playlists?",
              "sql": "SELECT t.TrackId, t.Name, COUNT(*) AS PlayCount\nFROM Track t\nJOIN PlaylistTrack pt ON t.TrackId = pt.TrackId\nGROUP BY t.TrackId, t.Name\nORDER BY PlayCount DESC;",
              "success": true
            },
            {
              "question": "How many tracks are in the playlist with ID 5?",
              "sql": "SELECT COUNT(*) AS track_count FROM PlaylistTrack WHERE PlaylistId = 5;",
              "success": true
            },
            {
              "question": "How many playlists contain the track with ID 10?",
              "sql": "SELECT COUNT(DISTINCT PlaylistId) AS PlaylistCount FROM PlaylistTrack WHERE TrackId = 10;",
              "success": true
            },
            {
              "question": "How many playlists are there in total?",
              "sql": "SELECT COUNT(*) AS total_playlists FROM Playlist;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "93013a5c2d2a1134dff14c238a735e1f",
          "output": [
            {
              "question": "Which tracks appear in at least five different playlists, and what are their average duration and total number of playlist appearances?",
              "sql": "SELECT t.Name,\n       t.Milliseconds AS DurationMs,\n       COUNT(DISTINCT pt.PlaylistId) AS PlaylistAppearances\nFROM Track t\nJOIN PlaylistTrack pt ON t.TrackId = pt.TrackId\nGROUP BY t.TrackId, t.Name, t.Milliseconds\nHAVING COUNT(DISTINCT pt.PlaylistId) >= 5\nORDER BY PlaylistAppearances DESC;",
              "success": true
            },
            {
              "question": "What are the three playlists with the most tracks, and for each of those playlists, list all tracks along with their composers and durations?",
              "sql": "SELECT p.Name AS PlaylistName, t.Name AS TrackName, t.Composer, t.Milliseconds\nFROM Playlist p\nJOIN PlaylistTrack pt ON p.PlaylistId = pt.PlaylistId\nJOIN Track t ON pt.TrackId = t.TrackId\nWHERE p.PlaylistId IN (\n    SELECT PlaylistId\n    FROM PlaylistTrack\n    GROUP BY PlaylistId\n    ORDER BY COUNT(*) DESC\n    LIMIT 3\n)\nORDER BY p.PlaylistId, t.Name;",
              "success": true
            },
            {
              "question": "Which genres are most represented in playlists that contain more than twenty tracks, and how many tracks from each of those genres appear?",
              "sql": "WITH big_playlists AS (\n    SELECT PlaylistId\n    FROM PlaylistTrack\n    GROUP BY PlaylistId\n    HAVING COUNT(*) > 20\n)\nSELECT g.Name AS Genre, COUNT(*) AS TrackCount\nFROM big_playlists bp\nJOIN PlaylistTrack pt ON bp.PlaylistId = pt.PlaylistId\nJOIN Track t ON pt.TrackId = t.TrackId\nJOIN Genre g ON t.GenreId = g.GenreId\nGROUP BY g.Name\nORDER BY TrackCount DESC;",
              "success": true
            },
            {
              "question": "Which tracks have never been added to any playlist, and what album do they belong to?",
              "sql": "SELECT t.Name AS TrackName, a.Title AS AlbumTitle\nFROM Track t\nLEFT JOIN PlaylistTrack pt ON t.TrackId = pt.TrackId\nLEFT JOIN Album a ON t.AlbumId = a.AlbumId\nWHERE pt.TrackId IS NULL\nORDER BY t.Name;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "c1d770833fc3919f19ac49831fbb1ec9",
          "output": [
            {
              "question": "Which tracks appear in the greatest number of user playlists, and how does each track's average duration compare to the overall average track length in the catalog?",
              "sql": "WITH pc AS (\n  SELECT pt.TrackId, COUNT(DISTINCT pt.PlaylistId) AS playlist_count\n  FROM PlaylistTrack pt\n  GROUP BY pt.TrackId\n),\nmax_pc AS (\n  SELECT MAX(playlist_count) AS max_count FROM pc\n),\navg_tbl AS (\n  SELECT AVG(Milliseconds) AS avg_ms FROM Track\n)\nSELECT\n  t.Name AS track_name,\n  t.TrackId,\n  t.Milliseconds,\n  pc.playlist_count,\n  avg_tbl.avg_ms,\n  t.Milliseconds - avg_tbl.avg_ms AS diff_ms,\n  t.Milliseconds * 1.0 / avg_tbl.avg_ms AS ratio\nFROM pc\nJOIN Track t ON t.TrackId = pc.TrackId\nCROSS JOIN avg_tbl\nWHERE pc.playlist_count = (SELECT max_count FROM max_pc)\nORDER BY pc.playlist_count DESC, t.Name;",
              "success": true
            },
            {
              "question": "In the ten playlists with the most tracks, what are the dominant music genres, and what proportion of the total tracks in those playlists does each genre account for?",
              "sql": "WITH top_playlists AS (\n  SELECT pt.PlaylistId\n  FROM PlaylistTrack pt\n  GROUP BY pt.PlaylistId\n  ORDER BY COUNT(*) DESC\n  LIMIT 10\n),\nplaylist_tracks AS (\n  SELECT pt.PlaylistId, pt.TrackId\n  FROM PlaylistTrack pt\n  WHERE pt.PlaylistId IN (SELECT PlaylistId FROM top_playlists)\n)\nSELECT g.Name AS Genre,\n       COUNT(*) AS TrackCount,\n       ROUND(COUNT(*) * 1.0 / (SELECT COUNT(*) FROM playlist_tracks), 4) AS Proportion\nFROM playlist_tracks pt\nJOIN Track t ON pt.TrackId = t.TrackId\nJOIN Genre g ON t.GenreId = g.GenreId\nGROUP BY g.GenreId, g.Name\nORDER BY TrackCount DESC;",
              "success": true
            },
            {
              "question": "For every month in the past year, how much total revenue was generated from invoices that include tracks belonging to playlists that feature the 'Jazz' genre, and which month showed the largest month‑over‑month increase in that revenue?",
              "sql": "WITH jazz_tracks AS (\n  SELECT DISTINCT pt.TrackId\n  FROM PlaylistTrack pt\n  JOIN Track t ON pt.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE g.Name = 'Jazz'\n),\njazz_invoices AS (\n  SELECT DISTINCT il.InvoiceId\n  FROM InvoiceLine il\n  WHERE il.TrackId IN (SELECT TrackId FROM jazz_tracks)\n),\nrevenue_by_month AS (\n  SELECT strftime('%Y-%m', i.InvoiceDate) AS month,\n         SUM(i.Total) AS revenue\n  FROM Invoice i\n  WHERE i.InvoiceId IN (SELECT InvoiceId FROM jazz_invoices)\n    AND i.InvoiceDate >= date('now', '-12 months', 'start of month')\n    AND i.InvoiceDate < date('now', 'start of month', '+1 month')\n  GROUP BY month\n),\nmonths AS (\n  SELECT date('now', '-12 months', 'start of month') AS month_start\n  UNION ALL\n  SELECT date(month_start, '+1 month')\n  FROM months\n  WHERE month_start < date('now', 'start of month')\n),\nmonth_labels AS (\n  SELECT strftime('%Y-%m', month_start) AS month\n  FROM months\n),\nrevenue_month AS (\n  SELECT ml.month,\n         COALESCE(r.revenue, 0) AS revenue\n  FROM month_labels ml\n  LEFT JOIN revenue_by_month r ON ml.month = r.month\n),\nrevenue_with_increase AS (\n  SELECT month,\n         revenue,\n         revenue - LAG(revenue) OVER (ORDER BY month) AS increase\n  FROM revenue_month\n)\nSELECT month,\n       revenue,\n       COALESCE(increase, 0) AS increase,\n       CASE WHEN COALESCE(increase, 0) = MAX(COALESCE(increase, 0)) OVER () THEN 1 ELSE 0 END AS is_max_increase\nFROM revenue_with_increase\nORDER BY month;",
              "success": true
            },
            {
              "question": "Which tracks list the most composers, and for each of those tracks, how many distinct albums feature each of those composers across the entire store?",
              "sql": "WITH RECURSIVE\n  split_composers AS (\n    SELECT\n      TrackId,\n      TRIM(SUBSTR(Composer, 1, INSTR(Composer, ',')-1)) AS composer,\n      CASE WHEN INSTR(Composer, ',') > 0 THEN SUBSTR(Composer, INSTR(Composer, ',')+1) ELSE NULL END AS rest\n    FROM Track\n    WHERE Composer IS NOT NULL\n    UNION ALL\n    SELECT\n      TrackId,\n      TRIM(SUBSTR(rest, 1, INSTR(rest, ',')-1)),\n      CASE WHEN INSTR(rest, ',') > 0 THEN SUBSTR(rest, INSTR(rest, ',')+1) ELSE NULL END\n    FROM split_composers\n    WHERE rest IS NOT NULL\n  ),\n  composer_counts AS (\n    SELECT TrackId, COUNT(*) AS composer_count\n    FROM split_composers\n    GROUP BY TrackId\n  ),\n  max_composer_count AS (\n    SELECT MAX(composer_count) AS max_count FROM composer_counts\n  ),\n  tracks_with_max AS (\n    SELECT t.TrackId, t.Name AS track_name, sc.composer\n    FROM split_composers sc\n    JOIN composer_counts cc ON sc.TrackId = cc.TrackId\n    JOIN max_composer_count mcc ON cc.composer_count = mcc.max_count\n    JOIN Track t ON sc.TrackId = t.TrackId\n  ),\n  album_counts_per_composer AS (\n    SELECT sc.composer, COUNT(DISTINCT a.AlbumId) AS album_count\n    FROM split_composers sc\n    JOIN Track t ON sc.TrackId = t.TrackId\n    JOIN Album a ON t.AlbumId = a.AlbumId\n    GROUP BY sc.composer\n  )\nSELECT\n  twm.track_name,\n  twm.composer,\n  ac.album_count\nFROM tracks_with_max twm\nJOIN album_counts_per_composer ac ON twm.composer = ac.composer\nORDER BY twm.track_name, twm.composer;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "64b7441e79cad513898e527f3d2b16e8",
          "output": [
            {
              "question": "Which tracks are most frequently added to playlists, and how many times does each appear across all playlists?",
              "sql": "SELECT t.Name, COUNT(*) AS play_count\nFROM PlaylistTrack pt\nJOIN Track t ON pt.TrackId = t.TrackId\nGROUP BY t.TrackId, t.Name\nORDER BY play_count DESC;",
              "success": true
            },
            {
              "question": "Across the playlists that contain the largest number of tracks, what is the average duration of tracks in each genre, and which genre has the longest average track time?",
              "sql": "WITH playlist_counts AS (\n    SELECT PlaylistId, COUNT(*) AS track_count\n    FROM PlaylistTrack\n    GROUP BY PlaylistId\n),\nmax_count AS (\n    SELECT MAX(track_count) AS max_tracks\n    FROM playlist_counts\n),\ntop_playlists AS (\n    SELECT pc.PlaylistId\n    FROM playlist_counts pc\n    JOIN max_count mc ON pc.track_count = mc.max_tracks\n),\ntrack_genre AS (\n    SELECT pt.PlaylistId,\n           t.GenreId,\n           g.Name AS GenreName,\n           t.Milliseconds\n    FROM PlaylistTrack pt\n    JOIN Track t ON pt.TrackId = t.TrackId\n    JOIN Genre g ON t.GenreId = g.GenreId\n    WHERE pt.PlaylistId IN (SELECT PlaylistId FROM top_playlists)\n)\nSELECT GenreName,\n       AVG(Milliseconds) AS avg_duration_ms,\n       CASE WHEN RANK() OVER (ORDER BY AVG(Milliseconds) DESC) = 1 THEN 1 ELSE 0 END AS is_longest\nFROM track_genre\nGROUP BY GenreId, GenreName\nORDER BY avg_duration_ms DESC;",
              "success": true
            },
            {
              "question": "Rank tracks by how often they are included in playlists, and for the top 20 tracks show a running total of their appearances, broken down by genre.",
              "sql": "WITH track_counts AS (\n    SELECT\n        t.TrackId,\n        t.Name AS TrackName,\n        g.GenreId,\n        g.Name AS GenreName,\n        COUNT(pt.PlaylistId) AS Appearances\n    FROM Track t\n    LEFT JOIN PlaylistTrack pt ON t.TrackId = pt.TrackId\n    LEFT JOIN Genre g ON t.GenreId = g.GenreId\n    GROUP BY t.TrackId, t.Name, g.GenreId, g.Name\n),\ntop_tracks AS (\n    SELECT *\n    FROM track_counts\n    ORDER BY Appearances DESC\n    LIMIT 20\n)\nSELECT\n    TrackId,\n    TrackName,\n    GenreName,\n    Appearances,\n    SUM(Appearances) OVER (PARTITION BY GenreId ORDER BY Appearances DESC\n                           ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal\nFROM top_tracks\nORDER BY Appearances DESC;",
              "success": true
            },
            {
              "question": "For each genre, list the five tracks that appear most often in playlists, and display the moving average of their inclusion counts over the last three playlists added to the database.",
              "sql": "WITH last_three AS (\n  SELECT PlaylistId FROM Playlist ORDER BY PlaylistId DESC LIMIT 3\n),\ntrack_counts_all AS (\n  SELECT pt.TrackId, COUNT(*) AS total_count\n  FROM PlaylistTrack pt\n  GROUP BY pt.TrackId\n),\nlast_three_counts AS (\n  SELECT pt.TrackId, COUNT(*) AS cnt\n  FROM PlaylistTrack pt\n  JOIN last_three lt ON pt.PlaylistId = lt.PlaylistId\n  GROUP BY pt.TrackId\n),\n top_tracks AS (\n  SELECT t.TrackId,\n         t.Name AS TrackName,\n         g.Name AS GenreName,\n         tc.total_count,\n         ROW_NUMBER() OVER (PARTITION BY g.GenreId ORDER BY tc.total_count DESC) AS rn\n  FROM Track t\n  JOIN Genre g ON t.GenreId = g.GenreId\n  JOIN track_counts_all tc ON t.TrackId = tc.TrackId\n)\nSELECT tt.GenreName,\n       tt.TrackName,\n       tt.total_count,\n       COALESCE(lc.cnt,0)/3.0 AS avg_last3\nFROM top_tracks tt\nLEFT JOIN last_three_counts lc ON tt.TrackId = lc.TrackId\nWHERE tt.rn <= 5\nORDER BY tt.GenreName, tt.total_count DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "1f043b9549eeb5f9f0059bf8c8a4c1a9",
          "output": [
            {
              "question": "How many albums are there?",
              "sql": "SELECT COUNT(*) AS album_count FROM Album;",
              "success": true
            },
            {
              "question": "Which artists have the last name 'Smith'?",
              "sql": "",
              "success": false
            },
            {
              "question": "How many customers are located in Germany?",
              "sql": "SELECT COUNT(*) AS customer_count FROM Customer WHERE Country = 'Germany';",
              "success": true
            },
            {
              "question": "What is the total revenue from all invoices?",
              "sql": "SELECT SUM(Total) AS TotalRevenue FROM Invoice;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "bd8ed71473f7dd26a720753ce67e4db3",
          "output": [
            {
              "question": "Which artists have released albums that have never been purchased by any customer?",
              "sql": "SELECT a.Name\nFROM Artist a\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM Album al\n    JOIN Track t ON al.AlbumId = t.AlbumId\n    JOIN InvoiceLine il ON t.TrackId = il.TrackId\n    WHERE al.ArtistId = a.ArtistId\n);",
              "success": true
            },
            {
              "question": "Which customers spent the most money on tracks in the 'Rock' genre during the last year?",
              "sql": "SELECT c.CustomerId, c.FirstName, c.LastName, SUM(il.UnitPrice * il.Quantity) AS TotalSpent\nFROM Customer c\nJOIN Invoice i ON c.CustomerId = i.CustomerId\nJOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Genre g ON t.GenreId = g.GenreId\nWHERE g.Name = 'Rock'\n  AND i.InvoiceDate >= date('now', '-1 year')\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nORDER BY TotalSpent DESC\nLIMIT 10;",
              "success": true
            },
            {
              "question": "What are the top 5 tracks with the longest playtime that have been downloaded in more than 10 different invoices?",
              "sql": "SELECT t.TrackId, t.Name, t.Milliseconds\nFROM Track t\nJOIN InvoiceLine il ON t.TrackId = il.TrackId\nGROUP BY t.TrackId, t.Name, t.Milliseconds\nHAVING COUNT(DISTINCT il.InvoiceId) > 10\nORDER BY t.Milliseconds DESC\nLIMIT 5;",
              "success": true
            },
            {
              "question": "Which employees have never handled a support case for a customer from Canada?",
              "sql": "SELECT e.EmployeeId, e.FirstName, e.LastName\nFROM Employee e\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM Customer c\n    WHERE c.SupportRepId = e.EmployeeId\n      AND c.Country = 'Canada'\n);",
              "success": true
            }
          ]
        },
        {
          "inputHash": "6b2cd42b7aab6585f8ccdc1244ac1b30",
          "output": [
            {
              "question": "Calculate the total revenue and number of invoices for each genre in each month, showing the month, genre name, total revenue, and invoice count, and display zero revenue for months where a genre had no sales.",
              "sql": "WITH months AS (\n  SELECT DISTINCT strftime('%Y-%m', InvoiceDate) AS month\n  FROM Invoice\n),\ngenres AS (\n  SELECT GenreId, Name\n  FROM Genre\n),\nagg AS (\n  SELECT\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    t.GenreId,\n    SUM(il.UnitPrice * il.Quantity) AS revenue,\n    COUNT(DISTINCT i.InvoiceId) AS invoice_count\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  WHERE t.GenreId IS NOT NULL\n  GROUP BY month, t.GenreId\n)\nSELECT\n  m.month,\n  g.Name AS genre_name,\n  COALESCE(a.revenue, 0) AS total_revenue,\n  COALESCE(a.invoice_count, 0) AS invoice_count\nFROM months m\nCROSS JOIN genres g\nLEFT JOIN agg a ON a.month = m.month AND a.GenreId = g.GenreId\nORDER BY m.month, g.Name;",
              "success": true
            },
            {
              "question": "List all orphaned records in the database, including InvoiceLine entries whose InvoiceId is missing from Invoice, Track entries whose AlbumId is missing from Album, PlaylistTrack entries whose TrackId is missing from Track, and Customer entries whose SupportRepId is missing from Employee.",
              "sql": "SELECT 'InvoiceLine' AS OrphanTable, InvoiceLine.InvoiceLineId AS OrphanId\nFROM InvoiceLine\nLEFT JOIN Invoice ON InvoiceLine.InvoiceId = Invoice.InvoiceId\nWHERE Invoice.InvoiceId IS NULL\nUNION ALL\nSELECT 'Track', Track.TrackId\nFROM Track\nLEFT JOIN Album ON Track.AlbumId = Album.AlbumId\nWHERE Album.AlbumId IS NULL\nUNION ALL\nSELECT 'PlaylistTrack', PlaylistTrack.PlaylistId || '-' || PlaylistTrack.TrackId\nFROM PlaylistTrack\nLEFT JOIN Track ON PlaylistTrack.TrackId = Track.TrackId\nWHERE Track.TrackId IS NULL\nUNION ALL\nSELECT 'Customer', Customer.CustomerId\nFROM Customer\nLEFT JOIN Employee ON Customer.SupportRepId = Employee.EmployeeId\nWHERE Employee.EmployeeId IS NULL\nORDER BY OrphanTable, OrphanId;",
              "success": true
            },
            {
              "question": "Determine the month-over-month growth rate in total revenue for each genre and identify the genre that achieved the highest growth from one month to the next.",
              "sql": "WITH revenue AS (\n  SELECT\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    g.Name AS genre,\n    SUM(il.UnitPrice * il.Quantity) AS revenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY month, genre\n),\ngrowth AS (\n  SELECT\n    month,\n    genre,\n    revenue,\n    ROUND(\n      (revenue - LAG(revenue) OVER (PARTITION BY genre ORDER BY month))\n      / NULLIF(LAG(revenue) OVER (PARTITION BY genre ORDER BY month), 0)\n      * 100,\n      2\n    ) AS growth_rate\n  FROM revenue\n),\nmax_growth AS (\n  SELECT MAX(growth_rate) AS max_growth FROM growth\n)\nSELECT g.genre, g.month, g.revenue, g.growth_rate\nFROM growth g\nJOIN max_growth mg ON g.growth_rate = mg.max_growth\nORDER BY g.genre, g.month;",
              "success": true
            },
            {
              "question": "Identify customers whose total spend increased by at least 20% from the previous year, and show the difference in total spend between the two years.",
              "sql": "WITH yearly_totals AS (\n  SELECT\n    CustomerId,\n    CAST(strftime('%Y', InvoiceDate) AS INTEGER) AS year,\n    SUM(Total) AS total\n  FROM Invoice\n  GROUP BY CustomerId, year\n)\nSELECT\n  c.CustomerId,\n  c.FirstName,\n  c.LastName,\n  t1.year AS current_year,\n  t2.year AS previous_year,\n  t1.total AS current_total,\n  t2.total AS previous_total,\n  (t1.total - t2.total) AS difference,\n  ((t1.total - t2.total) / t2.total) * 100.0 AS percent_increase\nFROM yearly_totals t1\nJOIN yearly_totals t2\n  ON t1.CustomerId = t2.CustomerId\n  AND t1.year = t2.year + 1\nJOIN Customer c\n  ON c.CustomerId = t1.CustomerId\nWHERE ((t1.total - t2.total) / t2.total) >= 0.20\nORDER BY c.CustomerId, t1.year;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "442c46d0cce151e4e38f4c6384f3308a",
          "output": [
            {
              "question": "What is the running total of invoice amounts per month for each customer, and how does each month’s total rank within that customer’s purchase history?",
              "sql": "WITH monthly AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(i.Total) AS monthly_total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  GROUP BY c.CustomerId, month\n)\nSELECT\n  CustomerId,\n  FirstName,\n  LastName,\n  month,\n  monthly_total,\n  SUM(monthly_total) OVER (PARTITION BY CustomerId ORDER BY month) AS running_total,\n  RANK() OVER (PARTITION BY CustomerId ORDER BY monthly_total DESC) AS rank\nFROM monthly\nORDER BY CustomerId, month;",
              "success": true
            },
            {
              "question": "For each employee, rank their customers by how often they purchase within the employee’s region, and list the top three customers for each employee along with how much each customer’s purchase frequency differs from the employee’s average?",
              "sql": "WITH customer_freq AS (\n  SELECT\n    e.EmployeeId,\n    e.FirstName || ' ' || e.LastName AS EmployeeName,\n    c.CustomerId,\n    c.FirstName || ' ' || c.LastName AS CustomerName,\n    COUNT(i.InvoiceId) AS Frequency\n  FROM Employee e\n  JOIN Customer c ON e.Country = c.Country\n  LEFT JOIN Invoice i ON c.CustomerId = i.CustomerId\n  GROUP BY e.EmployeeId, e.FirstName, e.LastName, c.CustomerId, c.FirstName, c.LastName\n),\nemployee_avg AS (\n  SELECT\n    EmployeeId,\n    AVG(Frequency) AS AvgFrequency\n  FROM customer_freq\n  GROUP BY EmployeeId\n),\nranked AS (\n  SELECT\n    cf.EmployeeId,\n    cf.EmployeeName,\n    cf.CustomerId,\n    cf.CustomerName,\n    cf.Frequency,\n    ea.AvgFrequency,\n    cf.Frequency - ea.AvgFrequency AS Difference,\n    ROW_NUMBER() OVER (PARTITION BY cf.EmployeeId ORDER BY cf.Frequency DESC) AS rn\n  FROM customer_freq cf\n  JOIN employee_avg ea ON cf.EmployeeId = ea.EmployeeId\n)\nSELECT\n  EmployeeId,\n  EmployeeName,\n  CustomerId,\n  CustomerName,\n  Frequency,\n  AvgFrequency,\n  Difference\nFROM ranked\nWHERE rn <= 3\nORDER BY EmployeeId, rn;",
              "success": true
            },
            {
              "question": "Which tracks belong to an album but never appear on any invoice line, grouped by genre, and what is the count of such unsold tracks per genre?",
              "sql": "SELECT g.Name AS Genre, COUNT(*) AS UnsoldTrackCount\nFROM Track t\nJOIN Genre g ON t.GenreId = g.GenreId\nWHERE t.AlbumId IS NOT NULL\n  AND NOT EXISTS (\n      SELECT 1\n      FROM InvoiceLine il\n      WHERE il.TrackId = t.TrackId\n  )\nGROUP BY g.Name\nORDER BY UnsoldTrackCount DESC;",
              "success": true
            },
            {
              "question": "What is the 3‑month moving average of total sales per country, how does each month’s average compare to the previous month, and which months show a percentage change greater than 15%?",
              "sql": "WITH monthly_sales AS (\n  SELECT\n    BillingCountry,\n    strftime('%Y-%m', InvoiceDate) AS year_month,\n    SUM(Total) AS monthly_total\n  FROM Invoice\n  GROUP BY BillingCountry, year_month\n),\nmoving_avg AS (\n  SELECT\n    BillingCountry,\n    year_month,\n    monthly_total,\n    AVG(monthly_total) OVER (PARTITION BY BillingCountry ORDER BY year_month\n                             ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg\n  FROM monthly_sales\n),\npct_change AS (\n  SELECT\n    BillingCountry,\n    year_month,\n    monthly_total,\n    moving_avg,\n    (moving_avg - LAG(moving_avg) OVER (PARTITION BY BillingCountry ORDER BY year_month)) /\n    NULLIF(LAG(moving_avg) OVER (PARTITION BY BillingCountry ORDER BY year_month), 0) * 100 AS pct_change\n  FROM moving_avg\n)\nSELECT\n  BillingCountry,\n  year_month,\n  monthly_total,\n  moving_avg,\n  pct_change,\n  CASE WHEN ABS(pct_change) > 15 THEN 1 ELSE 0 END AS change_gt_15\nFROM pct_change\nORDER BY BillingCountry, year_month;",
              "success": true
            }
          ]
        }
      ]
    },
    "evolvedPairs": {
      "committed": false,
      "entries": [
        {
          "inputHash": "7097132f6e043e355824f7a0e4bef45f",
          "output": [
            {
              "question": "What was the average, minimum, maximum, and count of invoice totals for each month in the dataset?",
              "sql": "SELECT strftime('%Y-%m', InvoiceDate) AS month,\n       AVG(Total) AS avg_total,\n       MIN(Total) AS min_total,\n       MAX(Total) AS max_total,\n       COUNT(*) AS invoice_count\nFROM Invoice\nGROUP BY month\nORDER BY month;",
              "success": true
            },
            {
              "question": "What is the total revenue from invoices issued in the last 90 days for customers whose billing country is the United States?",
              "sql": "SELECT SUM(Total) AS TotalRevenue\nFROM Invoice\nWHERE BillingCountry = 'United States'\n  AND InvoiceDate >= datetime('now', '-90 days');",
              "success": true
            },
            {
              "question": "What is the total revenue from all invoices, grouped by artist, showing each artist's name and the total revenue generated from the tracks sold for that artist?",
              "sql": "SELECT a.Name AS ArtistName,\n       SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM InvoiceLine il\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Album al ON t.AlbumId = al.AlbumId\nJOIN Artist a ON al.ArtistId = a.ArtistId\nGROUP BY a.Name\nORDER BY TotalRevenue DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "757a3eea500b9b12c0b0395d58e27765",
          "output": [
            {
              "question": "How many customers are there in each country, and what is the total amount of their invoices by country?",
              "sql": "SELECT\n    c.Country,\n    COUNT(DISTINCT c.CustomerId) AS CustomerCount,\n    COALESCE(SUM(i.Total), 0) AS TotalInvoices\nFROM\n    Customer c\nLEFT JOIN\n    Invoice i ON c.CustomerId = i.CustomerId\nGROUP BY\n    c.Country\nORDER BY\n    c.Country;",
              "success": true
            },
            {
              "question": "How many customers have placed more than five invoices in the past year?",
              "sql": "SELECT COUNT(*) AS CustomerCount\nFROM (\n    SELECT CustomerId\n    FROM Invoice\n    WHERE InvoiceDate >= date('now', '-1 year')\n    GROUP BY CustomerId\n    HAVING COUNT(*) > 5\n);",
              "success": true
            },
            {
              "question": "How many customers are assigned to each support representative?",
              "sql": "SELECT e.EmployeeId, e.FirstName, e.LastName, COUNT(c.CustomerId) AS CustomerCount\nFROM Employee e\nLEFT JOIN Customer c ON e.EmployeeId = c.SupportRepId\nGROUP BY e.EmployeeId, e.FirstName, e.LastName\nORDER BY CustomerCount DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "b6ad7540f855938f859d97ad6960f31b",
          "output": [
            {
              "question": "What is the total number of invoices issued by each customer, and what is the average invoice total per customer?",
              "sql": "SELECT c.CustomerId,\n       c.FirstName || ' ' || c.LastName AS CustomerName,\n       COUNT(i.InvoiceId) AS InvoiceCount,\n       ROUND(AVG(i.Total), 2) AS AvgInvoiceTotal\nFROM Invoice i\nJOIN Customer c ON i.CustomerId = c.CustomerId\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nORDER BY InvoiceCount DESC;",
              "success": true
            },
            {
              "question": "How many invoices have been issued to customers located in the United States with a total amount greater than $500?",
              "sql": "SELECT COUNT(*) AS InvoiceCount FROM Invoice i JOIN Customer c ON i.CustomerId = c.CustomerId WHERE c.Country = 'United States' AND i.Total > 500;",
              "success": true
            },
            {
              "question": "How many invoices have been issued by each support representative, showing the representative's full name and the total number of invoices they are responsible for?",
              "sql": "SELECT e.FirstName || ' ' || e.LastName AS SupportRepName,\n       COUNT(i.InvoiceId) AS InvoiceCount\nFROM Employee e\nJOIN Customer c ON c.SupportRepId = e.EmployeeId\nJOIN Invoice i ON i.CustomerId = c.CustomerId\nGROUP BY e.EmployeeId, e.FirstName, e.LastName\nORDER BY InvoiceCount DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "ff698078190e4381edb99b5f1d7194b2",
          "output": [
            {
              "question": "For each music genre, how many tracks are available in the catalog, and which genre has the highest number of tracks?",
              "sql": "WITH GenreCounts AS (\n  SELECT g.Name AS Genre,\n         COUNT(t.TrackId) AS TrackCount\n  FROM Genre g\n  LEFT JOIN Track t ON t.GenreId = g.GenreId\n  GROUP BY g.GenreId, g.Name\n)\nSELECT Genre,\n       TrackCount,\n       CASE WHEN TrackCount = MAX(TrackCount) OVER () THEN 1 ELSE 0 END AS IsMax\nFROM GenreCounts\nORDER BY TrackCount DESC;",
              "success": true
            },
            {
              "question": "How many tracks are available in the catalog that belong to the 'Rock' genre and have a unit price above $0.99?",
              "sql": "SELECT COUNT(*) AS track_count\nFROM Track\nJOIN Genre ON Track.GenreId = Genre.GenreId\nWHERE Genre.Name = 'Rock'\n  AND Track.UnitPrice > 0.99;",
              "success": true
            },
            {
              "question": "How many tracks are available in the catalog for each artist, showing the artist's name, the total number of tracks, and the total number of albums they have?",
              "sql": "SELECT a.Name AS artist_name, COUNT(DISTINCT t.TrackId) AS total_tracks, COUNT(DISTINCT al.AlbumId) AS total_albums FROM Artist a LEFT JOIN Album al ON al.ArtistId = a.ArtistId LEFT JOIN Track t ON t.AlbumId = al.AlbumId GROUP BY a.ArtistId, a.Name ORDER BY a.Name;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "bce112b373079b9a6a7afa23b2fb2d28",
          "output": [
            {
              "question": "For the most recent calendar quarter, list each customer together with the total they spent, the number of invoices they had, the average amount per invoice, and the largest single invoice amount, ordered by total spent in descending order.",
              "sql": "WITH max_date AS (\n  SELECT MAX(InvoiceDate) AS max_date FROM Invoice\n),\nmax_q AS (\n  SELECT\n    CAST(strftime('%Y', max_date) AS INTEGER) AS year,\n    ((CAST(strftime('%m', max_date) AS INTEGER)-1)/3 + 1) AS quarter\n  FROM max_date\n)\nSELECT\n  c.CustomerId,\n  c.FirstName,\n  c.LastName,\n  SUM(i.Total) AS total_spent,\n  COUNT(i.InvoiceId) AS invoice_count,\n  AVG(i.Total) AS avg_per_invoice,\n  MAX(i.Total) AS max_invoice\nFROM Invoice i\nJOIN Customer c ON i.CustomerId = c.CustomerId\nJOIN max_q mq ON CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) = mq.year\n  AND ((CAST(strftime('%m', i.InvoiceDate) AS INTEGER)-1)/3 + 1) = mq.quarter\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nORDER BY total_spent DESC;",
              "success": true
            },
            {
              "question": "Which customers had the highest total invoice amount in the last calendar quarter, spent more than $200, and purchased at least one track in the \"Jazz\" genre?",
              "sql": "WITH params AS (\n  SELECT\n    CAST(strftime('%Y', 'now') AS INTEGER) AS current_year,\n    CAST(strftime('%m', 'now') AS INTEGER) AS current_month\n),\nlast_quarter AS (\n  SELECT\n    CASE\n      WHEN current_month BETWEEN 1 AND 3 THEN current_year - 1\n      ELSE current_year\n    END AS year,\n    CASE\n      WHEN current_month BETWEEN 1 AND 3 THEN 4\n      WHEN current_month BETWEEN 4 AND 6 THEN 1\n      WHEN current_month BETWEEN 7 AND 9 THEN 2\n      ELSE 3\n    END AS quarter\n  FROM params\n),\ncustomer_totals AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    SUM(i.Total) AS total_spent\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  JOIN last_quarter lq ON CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) = lq.year\n    AND CAST((CAST(strftime('%m', i.InvoiceDate) AS INTEGER)-1)/3 + 1 AS INTEGER) = lq.quarter\n  GROUP BY c.CustomerId, c.FirstName, c.LastName\n  HAVING total_spent > 200\n)\nSELECT\n  ct.CustomerId,\n  ct.FirstName,\n  ct.LastName,\n  ct.total_spent\nFROM (\n  SELECT\n    CustomerId,\n    FirstName,\n    LastName,\n    total_spent,\n    MAX(total_spent) OVER () AS max_total\n  FROM customer_totals\n) ct\nWHERE ct.total_spent = ct.max_total\n  AND EXISTS (\n    SELECT 1\n    FROM InvoiceLine il\n    JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n    JOIN Track t ON il.TrackId = t.TrackId\n    JOIN Genre g ON t.GenreId = g.GenreId\n    WHERE i.CustomerId = ct.CustomerId\n      AND g.Name = 'Jazz'\n      AND CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) = (SELECT year FROM last_quarter)\n      AND CAST((CAST(strftime('%m', i.InvoiceDate) AS INTEGER)-1)/3 + 1 AS INTEGER) = (SELECT quarter FROM last_quarter)\n  )\nORDER BY ct.total_spent DESC;",
              "success": true
            },
            {
              "question": "Identify the customers with the highest total invoice amount in the last calendar quarter, and for each, provide the name of their support representative and the total number of tracks they purchased during that period.",
              "sql": "WITH quarter AS (\n    SELECT date('now', 'start of month', '-3 month') AS start_date,\n           date(date('now', 'start of month', '-3 month'), '+3 month', '-1 day') AS end_date\n),\ncustomer_totals AS (\n    SELECT c.CustomerId,\n           c.FirstName || ' ' || c.LastName AS CustomerName,\n           SUM(i.Total) AS TotalAmount,\n           SUM(il.Quantity) AS TotalTracks\n    FROM Customer c\n    JOIN Invoice i ON i.CustomerId = c.CustomerId\n    JOIN InvoiceLine il ON il.InvoiceId = i.InvoiceId\n    JOIN quarter q ON i.InvoiceDate BETWEEN q.start_date AND q.end_date\n    GROUP BY c.CustomerId\n),\nmax_total AS (\n    SELECT MAX(TotalAmount) AS MaxAmount FROM customer_totals\n)\nSELECT ct.CustomerName,\n       e.FirstName || ' ' || e.LastName AS SupportRepName,\n       ct.TotalTracks\nFROM customer_totals ct\nJOIN max_total mt ON ct.TotalAmount = mt.MaxAmount\nJOIN Customer c ON c.CustomerId = ct.CustomerId\nJOIN Employee e ON e.EmployeeId = c.SupportRepId\nORDER BY ct.TotalTracks DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "62e1a446717a66e7cb6ab2d5280011c3",
          "output": [
            {
              "question": "Among all artists, who generated the most revenue from track sales last year, and what were their total earnings, the total number of tracks sold, and the average revenue earned per track?",
              "sql": "WITH last_year AS (\n  SELECT\n    a.ArtistId,\n    a.Name AS ArtistName,\n    SUM(il.UnitPrice * il.Quantity) AS TotalRevenue,\n    SUM(il.Quantity) AS TotalTracksSold\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  WHERE i.InvoiceDate BETWEEN date('now', '-1 year', 'start of year') AND date('now', '-1 year', 'end of year')\n  GROUP BY a.ArtistId, a.Name\n)\nSELECT\n  ArtistName,\n  TotalRevenue,\n  TotalTracksSold,\n  TotalRevenue / TotalTracksSold AS AvgRevenuePerTrack\nFROM last_year\nORDER BY TotalRevenue DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "Among all artists who have sold at least 200 tracks and earned more than $5,000 from track sales in the last year, who generated the most revenue from track sales, and what were their total earnings?",
              "sql": "SELECT a.Name AS ArtistName, SUM(il.Quantity) AS TotalTracksSold, SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM Artist a\nJOIN Album al ON al.ArtistId = a.ArtistId\nJOIN Track t ON t.AlbumId = al.AlbumId\nJOIN InvoiceLine il ON il.TrackId = t.TrackId\nJOIN Invoice i ON i.InvoiceId = il.InvoiceId\nWHERE i.InvoiceDate >= date('now', '-1 year')\nGROUP BY a.ArtistId, a.Name\nHAVING SUM(il.Quantity) >= 200 AND SUM(il.UnitPrice * il.Quantity) > 5000\nORDER BY TotalRevenue DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "Which artist earned the most revenue from track sales in the past year, and for that artist, provide their total earnings, the number of tracks sold, the average unit price, and the customer who bought the most tracks from them (including the customer's full name and country).",
              "sql": "WITH ArtistRevenue AS (\n  SELECT a.ArtistId,\n         a.Name AS ArtistName,\n         SUM(il.UnitPrice * il.Quantity) AS TotalEarnings,\n         SUM(il.Quantity) AS TotalTracksSold,\n         SUM(il.UnitPrice * il.Quantity) / SUM(il.Quantity) AS AvgUnitPrice\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY a.ArtistId, a.Name\n),\nTopArtist AS (\n  SELECT * FROM ArtistRevenue ORDER BY TotalEarnings DESC LIMIT 1\n),\nCustomerStats AS (\n  SELECT c.CustomerId,\n         c.FirstName,\n         c.LastName,\n         c.Country,\n         SUM(il.Quantity) AS TracksBought,\n         ROW_NUMBER() OVER (ORDER BY SUM(il.Quantity) DESC) AS rn\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN TopArtist ta ON a.ArtistId = ta.ArtistId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY c.CustomerId, c.FirstName, c.LastName, c.Country\n)\nSELECT ta.ArtistName,\n       ta.TotalEarnings,\n       ta.TotalTracksSold,\n       ta.AvgUnitPrice,\n       cs.FirstName || ' ' || cs.LastName AS CustomerFullName,\n       cs.Country AS CustomerCountry\nFROM TopArtist ta\nJOIN CustomerStats cs ON cs.rn = 1;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "b1eeb4afe2b1f42d39f5c51b0838fecc",
          "output": [
            {
              "question": "For each music genre, calculate the total revenue, the number of invoices, and the average revenue per invoice for February 2023, then list the top three genres ranked by the highest average revenue per invoice.",
              "sql": "SELECT\n  g.Name AS Genre,\n  SUM(il.UnitPrice * il.Quantity) AS TotalRevenue,\n  COUNT(DISTINCT i.InvoiceId) AS InvoiceCount,\n  SUM(il.UnitPrice * il.Quantity) / COUNT(DISTINCT i.InvoiceId) AS AvgRevenuePerInvoice\nFROM Invoice i\nJOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Genre g ON t.GenreId = g.GenreId\nWHERE i.InvoiceDate >= '2023-02-01' AND i.InvoiceDate < '2023-03-01'\nGROUP BY g.Name\nORDER BY AvgRevenuePerInvoice DESC\nLIMIT 3;",
              "success": true
            },
            {
              "question": "Which music genres that had at least $1,000 in January 2023 revenue and were purchased by customers located in the United States showed the greatest month‑to‑month revenue increase from January to February 2023, and what was the percentage growth?",
              "sql": "WITH jan AS (\n  SELECT g.GenreId, g.Name AS GenreName,\n         SUM(il.UnitPrice * il.Quantity) AS JanRev\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE c.Country = 'United States'\n    AND i.InvoiceDate >= '2023-01-01' AND i.InvoiceDate < '2023-02-01'\n  GROUP BY g.GenreId, g.Name\n), feb AS (\n  SELECT g.GenreId, g.Name AS GenreName,\n         SUM(il.UnitPrice * il.Quantity) AS FebRev\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE c.Country = 'United States'\n    AND i.InvoiceDate >= '2023-02-01' AND i.InvoiceDate < '2023-03-01'\n  GROUP BY g.GenreId, g.Name\n)\nSELECT j.GenreName,\n       ROUND(((COALESCE(f.FebRev,0) - j.JanRev) / j.JanRev) * 100, 2) AS GrowthPercent\nFROM jan j\nJOIN feb f ON j.GenreId = f.GenreId\nWHERE j.JanRev >= 1000\nORDER BY GrowthPercent DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "Identify the music genres that experienced the largest month‑to‑month revenue increase from January to February 2023, and for each genre, list the artist whose tracks contributed the most to that growth, along with the percentage growth.",
              "sql": "WITH artist_rev AS (\n  SELECT g.Name AS Genre,\n         a.Name AS Artist,\n         strftime('%Y-%m', i.InvoiceDate) AS Month,\n         SUM(il.UnitPrice * il.Quantity) AS Revenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE i.InvoiceDate >= '2023-01-01' AND i.InvoiceDate < '2023-03-01'\n  GROUP BY Genre, Artist, Month\n),\nartist_month_rev AS (\n  SELECT Genre,\n         Artist,\n         SUM(CASE WHEN Month='2023-01' THEN Revenue ELSE 0 END) AS JanRev,\n         SUM(CASE WHEN Month='2023-02' THEN Revenue ELSE 0 END) AS FebRev\n  FROM artist_rev\n  GROUP BY Genre, Artist\n),\nartist_diff AS (\n  SELECT Genre,\n         Artist,\n         JanRev,\n         FebRev,\n         (FebRev - JanRev) AS Diff,\n         ((FebRev - JanRev)/JanRev)*100.0 AS GrowthPct\n  FROM artist_month_rev\n  WHERE JanRev > 0\n),\ngenre_diff AS (\n  SELECT Genre,\n         SUM(Diff) AS GenreDiff\n  FROM artist_diff\n  GROUP BY Genre\n),\nmax_genre AS (\n  SELECT Genre\n  FROM genre_diff\n  WHERE GenreDiff = (SELECT MAX(GenreDiff) FROM genre_diff)\n),\ntop_artist_per_genre AS (\n  SELECT ad.Genre,\n         ad.Artist,\n         ad.GrowthPct\n  FROM (\n    SELECT ad.*,\n           ROW_NUMBER() OVER (PARTITION BY ad.Genre ORDER BY ad.Diff DESC) AS rn\n    FROM artist_diff ad\n  ) ad\n  WHERE ad.rn = 1\n    AND ad.Genre IN (SELECT Genre FROM max_genre)\n)\nSELECT Genre,\n       Artist,\n       ROUND(GrowthPct, 2) AS PercentageGrowth\nFROM top_artist_per_genre\nORDER BY PercentageGrowth DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "f42daef220d60442afb97d7a9f4d0125",
          "output": [
            {
              "question": "For each country, report the total number of invoices, the average, minimum, and maximum invoice totals, the total number of distinct customers, and the average number of tracks per invoice, and identify the country with the highest average invoice total.",
              "sql": "WITH invoice_tracks AS (\n  SELECT i.InvoiceId, i.BillingCountry, i.Total, i.CustomerId,\n         COUNT(il.InvoiceLineId) AS track_count\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  GROUP BY i.InvoiceId, i.BillingCountry, i.Total, i.CustomerId\n),\ncountry_stats AS (\n  SELECT\n    BillingCountry AS country,\n    COUNT(*) AS total_invoices,\n    AVG(Total) AS avg_invoice_total,\n    MIN(Total) AS min_invoice_total,\n    MAX(Total) AS max_invoice_total,\n    COUNT(DISTINCT CustomerId) AS distinct_customers,\n    AVG(track_count) AS avg_tracks_per_invoice\n  FROM invoice_tracks\n  GROUP BY BillingCountry\n)\nSELECT\n  cs.*,\n  CASE WHEN cs.avg_invoice_total = MAX(cs.avg_invoice_total) OVER () THEN 1 ELSE 0 END AS is_top_country\nFROM country_stats cs\nORDER BY country;",
              "success": true
            },
            {
              "question": "For each country, among invoices issued in the last 12 months with a total exceeding $100, how many invoices were issued, what was the average invoice total, and which country had the largest average?",
              "sql": "WITH stats AS ( SELECT BillingCountry AS Country, COUNT(*) AS InvoiceCount, AVG(Total) AS AvgTotal FROM Invoice WHERE InvoiceDate >= date('now', '-12 months') AND Total > 100 GROUP BY BillingCountry ) SELECT Country, InvoiceCount, AvgTotal, CASE WHEN AvgTotal = MAX(AvgTotal) OVER () THEN 'Yes' ELSE 'No' END AS IsLargestAvg FROM stats ORDER BY AvgTotal DESC;",
              "success": false
            },
            {
              "question": "For each country, how many invoices were issued, what was the average invoice total, how many distinct customers were billed, who was the support representative with the most invoices in that country, and which country had the largest average invoice total?",
              "sql": "WITH country_stats AS (\n  SELECT\n    i.BillingCountry AS country,\n    COUNT(*) AS invoice_count,\n    AVG(i.Total) AS avg_total,\n    COUNT(DISTINCT i.CustomerId) AS distinct_customer_count\n  FROM Invoice i\n  GROUP BY i.BillingCountry\n),\nrep_counts AS (\n  SELECT\n    i.BillingCountry AS country,\n    c.SupportRepId AS rep_id,\n    COUNT(*) AS rep_invoice_count\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  GROUP BY i.BillingCountry, c.SupportRepId\n),\ntop_rep AS (\n  SELECT\n    country,\n    rep_id,\n    rep_invoice_count,\n    ROW_NUMBER() OVER (PARTITION BY country ORDER BY rep_invoice_count DESC) AS rn\n  FROM rep_counts\n),\nrep_names AS (\n  SELECT\n    tr.country,\n    tr.rep_id,\n    tr.rep_invoice_count,\n    e.FirstName || ' ' || e.LastName AS rep_name\n  FROM top_rep tr\n  JOIN Employee e ON tr.rep_id = e.EmployeeId\n  WHERE tr.rn = 1\n),\nmax_avg AS (\n  SELECT\n    MAX(avg_total) AS max_avg_total\n  FROM country_stats\n),\nmax_country AS (\n  SELECT\n    cs.country AS largest_avg_country\n  FROM country_stats cs\n  JOIN max_avg ma ON cs.avg_total = ma.max_avg_total\n)\nSELECT\n  cs.country,\n  cs.invoice_count,\n  cs.avg_total,\n  cs.distinct_customer_count,\n  rn.rep_name AS top_support_rep,\n  rn.rep_invoice_count AS top_rep_invoice_count,\n  mc.largest_avg_country\nFROM country_stats cs\nLEFT JOIN rep_names rn ON cs.country = rn.country\nCROSS JOIN max_country mc\nORDER BY cs.country;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "02b72b8628fae17e039197ada9d1b451",
          "output": [
            {
              "question": "For each month of 2023, find the country with the largest percentage increase in total revenue compared to the same month in 2022, and report that country's percentage growth, its total revenue in 2022 and 2023, the number of invoices issued in each year, and the average invoice amount for 2023.",
              "sql": "WITH rev AS (\n  SELECT\n    strftime('%Y', InvoiceDate) AS year,\n    strftime('%m', InvoiceDate) AS month,\n    Customer.Country,\n    SUM(Invoice.Total) AS total_rev,\n    COUNT(*) AS invoice_cnt\n  FROM Invoice\n  JOIN Customer ON Invoice.CustomerId = Customer.CustomerId\n  WHERE strftime('%Y', InvoiceDate) IN ('2022','2023')\n  GROUP BY year, month, Customer.Country\n),\nrev_2022 AS (\n  SELECT month, Country, total_rev AS rev_2022, invoice_cnt AS cnt_2022\n  FROM rev WHERE year='2022'\n),\nrev_2023 AS (\n  SELECT month, Country, total_rev AS rev_2023, invoice_cnt AS cnt_2023\n  FROM rev WHERE year='2023'\n),\ngrowth AS (\n  SELECT\n    r3.month,\n    r3.Country,\n    ((r3.rev_2023 - r2.rev_2022) / NULLIF(r2.rev_2022,0)) * 100 AS pct_growth,\n    r2.rev_2022,\n    r3.rev_2023,\n    r2.cnt_2022,\n    r3.cnt_2023,\n    r3.rev_2023 / NULLIF(r3.cnt_2023,0) AS avg_invoice_2023\n  FROM rev_2023 r3\n  JOIN rev_2022 r2\n    ON r3.month = r2.month AND r3.Country = r2.Country\n  WHERE r2.rev_2022 > 0\n),\nranked AS (\n  SELECT *,\n    ROW_NUMBER() OVER (PARTITION BY month ORDER BY pct_growth DESC) AS rn\n  FROM growth\n)\nSELECT\n  month,\n  Country,\n  pct_growth,\n  rev_2022,\n  rev_2023,\n  cnt_2022,\n  cnt_2023,\n  avg_invoice_2023\nFROM ranked\nWHERE rn = 1\nORDER BY month;",
              "success": true
            },
            {
              "question": "For each month of 2023, among countries that recorded at least 10 invoices in that month and had a total 2023 revenue exceeding $10,000, which country achieved the highest percentage increase in total revenue compared to the same month in 2022, and what was that percentage?",
              "sql": "WITH revenue AS (\n  SELECT\n    strftime('%Y', InvoiceDate) AS year,\n    strftime('%m', InvoiceDate) AS month,\n    Customer.Country,\n    SUM(Invoice.Total) AS total,\n    COUNT(*) AS invoice_count\n  FROM Invoice\n  JOIN Customer ON Invoice.CustomerId = Customer.CustomerId\n  GROUP BY year, month, Customer.Country\n),\nfiltered AS (\n  SELECT *\n  FROM revenue\n  WHERE year = '2023'\n    AND invoice_count >= 10\n    AND total > 10000\n),\nrevenue_2022 AS (\n  SELECT\n    month,\n    Country,\n    total AS total_2022\n  FROM revenue\n  WHERE year = '2022'\n),\njoined AS (\n  SELECT\n    f.month,\n    f.Country,\n    f.total AS total_2023,\n    r.total_2022\n  FROM filtered f\n  LEFT JOIN revenue_2022 r\n    ON f.month = r.month AND f.Country = r.Country\n),\ncalc AS (\n  SELECT\n    month,\n    Country,\n    total_2023,\n    total_2022,\n    CASE\n      WHEN total_2022 IS NULL OR total_2022 = 0 THEN NULL\n      ELSE ((total_2023 - total_2022) / total_2022) * 100.0\n    END AS pct_increase\n  FROM joined\n),\nranked AS (\n  SELECT\n    month,\n    Country,\n    pct_increase,\n    ROW_NUMBER() OVER (PARTITION BY month ORDER BY pct_increase DESC) AS rn\n  FROM calc\n)\nSELECT\n  month,\n  Country,\n  ROUND(pct_increase, 2) AS pct_increase\nFROM ranked\nWHERE rn = 1\nORDER BY month;",
              "success": true
            },
            {
              "question": "For each month of 2023, identify the country that experienced the greatest percentage increase in total revenue compared to the same month in 2022, and report that percentage. Additionally, for that country and month, provide the most frequently purchased music genre and the number of tracks sold in that genre. This requires joining the Invoice, Customer, InvoiceLine, Track, and Genre tables.",
              "sql": "WITH revenue AS (\n  SELECT\n    strftime('%Y-%m', i.InvoiceDate) AS year_month,\n    c.Country,\n    SUM(i.Total) AS revenue\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE i.InvoiceDate >= '2022-01-01' AND i.InvoiceDate < '2024-01-01'\n  GROUP BY year_month, c.Country\n),\nrev_by_year AS (\n  SELECT\n    year_month,\n    Country,\n    revenue,\n    substr(year_month, 1, 4) AS year,\n    substr(year_month, 6, 2) AS month\n  FROM revenue\n),\nrev_2022 AS (\n  SELECT * FROM rev_by_year WHERE year = '2022'\n),\nrev_2023 AS (\n  SELECT * FROM rev_by_year WHERE year = '2023'\n),\npct AS (\n  SELECT\n    r3.year_month,\n    r3.Country,\n    ((r3.revenue - r2.revenue) / r2.revenue) * 100.0 AS pct_increase\n  FROM rev_2023 r3\n  JOIN rev_2022 r2\n    ON r3.month = r2.month\n   AND r3.Country = r2.Country\n  WHERE r2.revenue > 0\n),\npct_ranked AS (\n  SELECT\n    year_month,\n    Country,\n    pct_increase,\n    ROW_NUMBER() OVER (PARTITION BY year_month ORDER BY pct_increase DESC) AS rn\n  FROM pct\n),\ntop_pct AS (\n  SELECT year_month, Country, pct_increase\n  FROM pct_ranked\n  WHERE rn = 1\n),\ngenre_sales AS (\n  SELECT\n    strftime('%Y-%m', i.InvoiceDate) AS year_month,\n    c.Country,\n    g.Name AS genre,\n    SUM(il.Quantity) AS tracks_sold\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE i.InvoiceDate >= '2022-01-01' AND i.InvoiceDate < '2024-01-01'\n  GROUP BY year_month, c.Country, g.GenreId, g.Name\n),\ngenre_ranked AS (\n  SELECT\n    year_month,\n    Country,\n    genre,\n    tracks_sold,\n    ROW_NUMBER() OVER (PARTITION BY year_month, Country ORDER BY tracks_sold DESC) AS rn\n  FROM genre_sales\n),\ntop_genre AS (\n  SELECT year_month, Country, genre, tracks_sold\n  FROM genre_ranked\n  WHERE rn = 1\n)\nSELECT\n  tp.year_month,\n  tp.Country,\n  ROUND(tp.pct_increase, 2) AS pct_increase,\n  tg.genre,\n  tg.tracks_sold\nFROM top_pct tp\nJOIN top_genre tg\n  ON tp.year_month = tg.year_month\n AND tp.Country = tg.Country\nORDER BY tp.year_month;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "58fff7c0ac2c8e86d394d0b9001f01f2",
          "output": [
            {
              "question": "Identify all customers who have shown a month‑over‑month increase in total spend for each of the last 12 months, list their average growth rate, and also report the count of such customers, the total spend accumulated by them over the period, the highest individual monthly spend among them, and the lowest.",
              "sql": "WITH monthly_totals AS ( SELECT i.CustomerId, strftime('%Y-%m', i.InvoiceDate) AS month, SUM(i.Total) AS month_total FROM Invoice i WHERE i.InvoiceDate >= date('now', '-11 months', 'start of month') GROUP BY i.CustomerId, month ), ordered AS ( SELECT CustomerId, month, month_total, ROW_NUMBER() OVER (PARTITION BY CustomerId ORDER BY month) AS rn, LAG(month_total) OVER (PARTITION BY CustomerId ORDER BY month) AS prev_total FROM monthly_totals ), valid_customers AS ( SELECT CustomerId, COUNT(*) AS month_count, SUM(month_total) AS total_spend, MAX(month_total) AS max_monthly, MIN(month_total) AS min_monthly, AVG((month_total - prev_total) / prev_total) AS avg_growth_rate FROM ordered WHERE prev_total IS NOT NULL AND month_total > prev_total GROUP BY CustomerId HAVING month_count = 12 ) SELECT c.CustomerId, c.FirstName, c.LastName, ROUND(vc.avg_growth_rate * 100, 2) AS avg_growth_rate_percent FROM valid_customers vc JOIN Customer c ON c.CustomerId = vc.CustomerId ORDER BY vc.avg_growth_rate DESC; SELECT COUNT(*) AS customer_count, ROUND(SUM(total_spend), 2) AS total_spend, ROUND(MAX(max_monthly), 2) AS highest_monthly_spend, ROUND(MIN(min_monthly), 2) AS lowest_monthly_spend FROM valid_customers;",
              "success": true
            },
            {
              "question": "Which customers, who have spent more than $500 in total over the last 12 months and live in the United States, have consistently increased their monthly spend month over month, and what was their average month‑over‑month growth rate?",
              "sql": "WITH last12 AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    c.Country,\n    strftime('%Y-%m', i.InvoiceDate) AS ym,\n    SUM(i.Total) AS month_total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE i.InvoiceDate >= date('now', '-12 months')\n    AND c.Country = 'United States'\n  GROUP BY c.CustomerId, ym\n),\nmonthly AS (\n  SELECT\n    CustomerId,\n    ym,\n    month_total,\n    ROW_NUMBER() OVER (PARTITION BY CustomerId ORDER BY ym) AS rn,\n    LAG(month_total) OVER (PARTITION BY CustomerId ORDER BY ym) AS prev_total\n  FROM last12\n),\nvalid AS (\n  SELECT\n    CustomerId,\n    COUNT(*) AS months_with_spend,\n    SUM(month_total) AS total_spent,\n    AVG((month_total - prev_total)/prev_total) AS avg_growth\n  FROM monthly\n  WHERE prev_total IS NOT NULL AND month_total > prev_total\n  GROUP BY CustomerId\n  HAVING months_with_spend = 12\n    AND SUM(month_total) > 500\n)\nSELECT\n  c.CustomerId,\n  c.FirstName,\n  c.LastName,\n  v.total_spent,\n  v.avg_growth\nFROM valid v\nJOIN Customer c ON v.CustomerId = c.CustomerId;",
              "success": true
            },
            {
              "question": "Which customers have consistently increased their total spend month over month for the last 12 months, what was their average month‑over‑month growth rate, and which support representative (first and last name) is assigned to each customer?",
              "sql": "WITH monthly_totals AS (\n  SELECT\n    CustomerId,\n    strftime('%Y-%m', InvoiceDate) AS month,\n    SUM(Total) AS month_total\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-11 months', 'start of month')\n  GROUP BY CustomerId, month\n),\nmonthly_with_lag AS (\n  SELECT\n    CustomerId,\n    month,\n    month_total,\n    LAG(month_total) OVER (PARTITION BY CustomerId ORDER BY month) AS prev_total,\n    CASE\n      WHEN LAG(month_total) OVER (PARTITION BY CustomerId ORDER BY month) IS NULL THEN 0\n      WHEN month_total > LAG(month_total) OVER (PARTITION BY CustomerId ORDER BY month) THEN 1\n      ELSE 0\n    END AS increased_flag,\n    CASE\n      WHEN LAG(month_total) OVER (PARTITION BY CustomerId ORDER BY month) IS NULL THEN NULL\n      ELSE (month_total / LAG(month_total) OVER (PARTITION BY CustomerId ORDER BY month) - 1)\n    END AS growth_rate\n  FROM monthly_totals\n),\ncustomer_stats AS (\n  SELECT\n    CustomerId,\n    COUNT(*) AS month_count,\n    SUM(increased_flag) AS increased_count,\n    AVG(growth_rate) AS avg_growth_rate\n  FROM monthly_with_lag\n  GROUP BY CustomerId\n  HAVING month_count = 12 AND increased_count = 11\n)\nSELECT\n  c.CustomerId,\n  c.FirstName,\n  c.LastName,\n  e.FirstName AS SupportRepFirstName,\n  e.LastName AS SupportRepLastName,\n  cs.avg_growth_rate\nFROM customer_stats cs\nJOIN Customer c ON c.CustomerId = cs.CustomerId\nLEFT JOIN Employee e ON e.EmployeeId = c.SupportRepId;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "47fb2a32e7078dd411f57b6ce33ec09c",
          "output": [
            {
              "question": "For each genre, report the average, minimum, and maximum unit price of its tracks; count how many distinct tracks have been sold and how many distinct customers purchased those tracks; compute the total revenue and the average revenue per sale; calculate the revenue growth percentage from the previous year to the current year; and determine the percentage of tracks in that genre that have never been sold.",
              "sql": "WITH\n  genre_stats AS (\n    SELECT\n      g.GenreId,\n      g.Name AS GenreName,\n      AVG(t.UnitPrice) AS avg_unit_price,\n      MIN(t.UnitPrice) AS min_unit_price,\n      MAX(t.UnitPrice) AS max_unit_price,\n      COUNT(DISTINCT CASE WHEN il.InvoiceLineId IS NOT NULL THEN t.TrackId END) AS distinct_tracks_sold,\n      COUNT(DISTINCT CASE WHEN il.InvoiceLineId IS NOT NULL THEN i.CustomerId END) AS distinct_customers,\n      SUM(CASE WHEN il.InvoiceLineId IS NOT NULL THEN il.UnitPrice * il.Quantity END) AS total_revenue,\n      COUNT(il.InvoiceLineId) AS total_sales,\n      COUNT(DISTINCT t.TrackId) AS total_tracks_in_genre,\n      COUNT(DISTINCT CASE WHEN il.InvoiceLineId IS NULL THEN t.TrackId END) AS tracks_never_sold\n    FROM Genre g\n    JOIN Track t ON t.GenreId = g.GenreId\n    LEFT JOIN InvoiceLine il ON il.TrackId = t.TrackId\n    LEFT JOIN Invoice i ON i.InvoiceId = il.InvoiceId\n    GROUP BY g.GenreId, g.Name\n  ),\n  revenue_by_year AS (\n    SELECT\n      g.GenreId,\n      strftime('%Y', i.InvoiceDate) AS year,\n      SUM(il.UnitPrice * il.Quantity) AS rev\n    FROM Genre g\n    JOIN Track t ON t.GenreId = g.GenreId\n    JOIN InvoiceLine il ON il.TrackId = t.TrackId\n    JOIN Invoice i ON i.InvoiceId = il.InvoiceId\n    GROUP BY g.GenreId, year\n  ),\n  current_year AS (\n    SELECT MAX(CAST(year AS INTEGER)) AS curr_year FROM revenue_by_year\n  ),\n  rev_per_genre AS (\n    SELECT\n      r.GenreId,\n      SUM(CASE WHEN CAST(r.year AS INTEGER) = curr_year THEN r.rev ELSE 0 END) AS rev_current,\n      SUM(CASE WHEN CAST(r.year AS INTEGER) = curr_year - 1 THEN r.rev ELSE 0 END) AS rev_prev\n    FROM revenue_by_year r\n    CROSS JOIN current_year\n    GROUP BY r.GenreId\n  )\nSELECT\n  gs.GenreName,\n  gs.avg_unit_price,\n  gs.min_unit_price,\n  gs.max_unit_price,\n  gs.distinct_tracks_sold,\n  gs.distinct_customers,\n  gs.total_revenue,\n  CASE WHEN gs.total_sales > 0 THEN gs.total_revenue / gs.total_sales ELSE 0 END AS avg_revenue_per_sale,\n  CASE WHEN rp.rev_prev > 0 THEN ((rp.rev_current - rp.rev_prev) / rp.rev_prev) * 100 ELSE NULL END AS revenue_growth_pct,\n  CASE WHEN gs.total_tracks_in_genre > 0 THEN (gs.tracks_never_sold * 100.0 / gs.total_tracks_in_genre) ELSE 0 END AS pct_tracks_never_sold\nFROM genre_stats gs\nLEFT JOIN rev_per_genre rp ON rp.GenreId = gs.GenreId;",
              "success": true
            },
            {
              "question": "For each genre that has sold at least 500 tracks in the current year and whose average unit price exceeds $0.99, what is the average unit price of its tracks, the total number of tracks sold, the total revenue generated, and how does this year’s revenue compare to the previous year’s revenue for that genre?",
              "sql": "WITH current_year AS (\n  SELECT\n    g.GenreId,\n    g.Name,\n    SUM(il.Quantity) AS tracks_sold,\n    AVG(il.UnitPrice) AS avg_unit_price,\n    SUM(il.UnitPrice * il.Quantity) AS revenue_current\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now')\n  GROUP BY g.GenreId, g.Name\n),\nprevious_year AS (\n  SELECT\n    g.GenreId,\n    SUM(il.UnitPrice * il.Quantity) AS revenue_prev\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now', '-1 year')\n  GROUP BY g.GenreId\n)\nSELECT\n  c.GenreId,\n  c.Name,\n  c.avg_unit_price,\n  c.tracks_sold,\n  c.revenue_current,\n  COALESCE(p.revenue_prev, 0) AS revenue_prev,\n  c.revenue_current - COALESCE(p.revenue_prev, 0) AS revenue_diff,\n  CASE WHEN COALESCE(p.revenue_prev, 0) = 0 THEN NULL\n       ELSE c.revenue_current / COALESCE(p.revenue_prev, 0)\n  END AS revenue_ratio\nFROM current_year c\nLEFT JOIN previous_year p ON c.GenreId = p.GenreId\nWHERE c.tracks_sold >= 500\n  AND c.avg_unit_price > 0.99;",
              "success": true
            },
            {
              "question": "Across all genres, determine for each genre the average unit price of its tracks, the total number of those tracks sold, the total revenue generated, the revenue change from the previous year, and, additionally, identify the artist who has the most tracks in that genre and the number of invoices that customers from each country have placed for tracks of that genre.",
              "sql": "WITH years AS (\n  SELECT CAST(MAX(strftime('%Y', InvoiceDate)) AS INTEGER) AS current_year,\n         CAST(MAX(strftime('%Y', InvoiceDate)) AS INTEGER) - 1 AS previous_year\n  FROM Invoice\n),\n top_artist_per_genre AS (\n  SELECT g.GenreId,\n         ar.ArtistId,\n         ar.Name AS ArtistName,\n         COUNT(*) AS TrackCount,\n         ROW_NUMBER() OVER (PARTITION BY g.GenreId ORDER BY COUNT(*) DESC) AS rn\n  FROM Genre g\n  JOIN Track t ON t.GenreId = g.GenreId\n  JOIN Album a ON a.AlbumId = t.AlbumId\n  JOIN Artist ar ON ar.ArtistId = a.ArtistId\n  GROUP BY g.GenreId, ar.ArtistId, ar.Name\n),\n genre_stats AS (\n  SELECT g.GenreId,\n         g.Name AS GenreName,\n         ROUND(AVG(t.UnitPrice), 2) AS AvgUnitPrice,\n         SUM(il.Quantity) AS TotalTracksSold,\n         ROUND(SUM(il.UnitPrice * il.Quantity), 2) AS TotalRevenue,\n         ROUND(\n           SUM(CASE WHEN CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) = y.current_year\n                    THEN il.UnitPrice * il.Quantity\n                    ELSE 0 END) -\n           SUM(CASE WHEN CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) = y.previous_year\n                    THEN il.UnitPrice * il.Quantity\n                    ELSE 0 END), 2) AS RevenueChange,\n         ttop.ArtistName AS TopArtistName,\n         ttop.TrackCount AS TopArtistTrackCount\n  FROM Genre g\n  JOIN Track t ON t.GenreId = g.GenreId\n  JOIN InvoiceLine il ON il.TrackId = t.TrackId\n  JOIN Invoice i ON i.InvoiceId = il.InvoiceId\n  CROSS JOIN years y\n  JOIN top_artist_per_genre ttop ON ttop.GenreId = g.GenreId AND ttop.rn = 1\n  GROUP BY g.GenreId, g.Name, ttop.ArtistName, ttop.TrackCount\n),\n country_invoice_counts AS (\n  SELECT g.GenreId,\n         c.Country,\n         COUNT(DISTINCT i.InvoiceId) AS InvoiceCount\n  FROM Genre g\n  JOIN Track t ON t.GenreId = g.GenreId\n  JOIN InvoiceLine il ON il.TrackId = t.TrackId\n  JOIN Invoice i ON i.InvoiceId = il.InvoiceId\n  JOIN Customer c ON c.CustomerId = i.CustomerId\n  GROUP BY g.GenreId, c.Country\n)\nSELECT gs.GenreName,\n       gs.AvgUnitPrice,\n       gs.TotalTracksSold,\n       gs.TotalRevenue,\n       gs.RevenueChange,\n       gs.TopArtistName,\n       gs.TopArtistTrackCount,\n       cic.Country,\n       cic.InvoiceCount\nFROM genre_stats gs\nJOIN country_invoice_counts cic ON cic.GenreId = gs.GenreId\nORDER BY gs.GenreName, cic.Country;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "f84515eeb70f1238652021f2e281da71",
          "output": [
            {
              "question": "For each support representative, calculate the average monthly invoice value per customer they support, considering only customers who have made at least two purchases in the past six months. Rank the representatives by this metric, and list the top five. For each of these top five, also provide the variance and standard deviation of the invoice totals for their supported customers. Finally, compare each representative’s average to the overall average and to the median average across all support representatives.",
              "sql": "WITH\n  filtered_customers AS (\n    SELECT c.CustomerId, c.SupportRepId\n    FROM Customer c\n    JOIN Invoice i ON i.CustomerId = c.CustomerId\n    WHERE i.InvoiceDate >= date('now', '-6 months')\n    GROUP BY c.CustomerId, c.SupportRepId\n    HAVING COUNT(i.InvoiceId) >= 2\n  ),\n  customer_totals AS (\n    SELECT fc.CustomerId, fc.SupportRepId,\n           SUM(i.Total) AS total\n    FROM filtered_customers fc\n    JOIN Invoice i ON i.CustomerId = fc.CustomerId\n    WHERE i.InvoiceDate >= date('now', '-6 months')\n    GROUP BY fc.CustomerId, fc.SupportRepId\n  ),\n  rep_metrics AS (\n    SELECT\n      ct.SupportRepId,\n      e.FirstName || ' ' || e.LastName AS SupportRepName,\n      COUNT(ct.CustomerId) AS num_customers,\n      SUM(ct.total) AS sum_totals,\n      SUM(ct.total) / (COUNT(ct.CustomerId) * 6.0) AS avg_monthly_per_customer,\n      AVG(ct.total) AS avg_total,\n      AVG(ct.total * ct.total) AS avg_total_sq,\n      (AVG(ct.total * ct.total) - (AVG(ct.total) * AVG(ct.total))) AS variance,\n      sqrt(AVG(ct.total * ct.total) - (AVG(ct.total) * AVG(ct.total))) AS stddev\n    FROM customer_totals ct\n    JOIN Employee e ON e.EmployeeId = ct.SupportRepId\n    GROUP BY ct.SupportRepId, e.FirstName, e.LastName\n  ),\n  rep_stats_sorted AS (\n    SELECT\n      rm.*,\n      ROW_NUMBER() OVER (ORDER BY rm.avg_monthly_per_customer) AS rn,\n      COUNT(*) OVER () AS cnt\n    FROM rep_metrics rm\n  ),\n  overall_stats AS (\n    SELECT\n      AVG(avg_monthly_per_customer) AS overall_avg,\n      AVG(avg_monthly_per_customer) AS median_avg -- placeholder; will be overwritten below\n    FROM rep_metrics\n  ),\n  median_calc AS (\n    SELECT\n      AVG(avg_monthly_per_customer) AS median_avg\n    FROM rep_stats_sorted\n    WHERE rn IN ((cnt + 1) / 2.0, (cnt + 2) / 2.0)\n  )\nSELECT\n  rm.SupportRepId,\n  rm.SupportRepName,\n  rm.avg_monthly_per_customer,\n  rm.variance,\n  rm.stddev,\n  os.overall_avg,\n  mc.median_avg,\n  rm.avg_monthly_per_customer - os.overall_avg AS diff_overall,\n  rm.avg_monthly_per_customer - mc.median_avg AS diff_median\nFROM rep_metrics rm\nCROSS JOIN overall_stats os\nCROSS JOIN median_calc mc\nORDER BY rm.avg_monthly_per_customer DESC\nLIMIT 5;",
              "success": false
            },
            {
              "question": "Among employees who are support representatives and were hired after 2015-01-01, which ones have the highest average monthly invoice value per customer they support, considering only customers who live in the United States and have made at least two purchases in the last six months (including at least one purchase in the last month) and each invoice they made is over $50, and how does that average compare to the overall average across all such employees?",
              "sql": "WITH qualifying_customers AS (SELECT c.CustomerId FROM Customer c JOIN Invoice i ON i.CustomerId = c.CustomerId WHERE c.Country = 'United States' AND i.Total > 50 GROUP BY c.CustomerId HAVING COUNT(*) >= 2 AND MIN(i.Total) > 50 AND SUM(CASE WHEN i.InvoiceDate >= date('now', '-1 month') THEN 1 ELSE 0 END) >= 1), customer_monthly_totals AS (SELECT i.CustomerId, strftime('%Y-%m', i.InvoiceDate) AS month, SUM(i.Total) AS month_total FROM Invoice i WHERE i.CustomerId IN (SELECT CustomerId FROM qualifying_customers) AND i.InvoiceDate >= date('now', '-6 months') GROUP BY i.CustomerId, month), customer_avg_monthly AS (SELECT cm.CustomerId, AVG(cm.month_total) AS avg_monthly FROM customer_monthly_totals cm GROUP BY cm.CustomerId), employee_customer_avg AS (SELECT e.EmployeeId, e.FirstName, e.LastName, AVG(ca.avg_monthly) AS employee_avg FROM Employee e JOIN Customer cust ON cust.SupportRepId = e.EmployeeId JOIN customer_avg_monthly ca ON ca.CustomerId = cust.CustomerId WHERE e.HireDate > date('2015-01-01') GROUP BY e.EmployeeId, e.FirstName, e.LastName), overall_avg AS (SELECT AVG(employee_avg) AS overall_avg FROM employee_customer_avg) SELECT e.EmployeeId, e.FirstName, e.LastName, e.employee_avg, o.overall_avg FROM employee_customer_avg e CROSS JOIN overall_avg o ORDER BY e.employee_avg DESC LIMIT 1;",
              "success": true
            },
            {
              "question": "Among employees who are support representatives, identify the ones with the highest average monthly invoice value per customer they support, where only customers who have made at least two purchases in the last six months are considered. For each of these customers, calculate the average unit price of the tracks they purchased, and also provide the support representative’s manager’s full name. Finally, compare the representatives’ average monthly invoice values to the overall average across all employees.",
              "sql": "WITH\n  -- Customers with at least two invoices in the last six months\n  filtered_customers AS (\n    SELECT c.CustomerId, c.SupportRepId\n    FROM Customer c\n    JOIN Invoice i ON i.CustomerId = c.CustomerId\n    WHERE i.InvoiceDate >= date('now', '-6 months')\n    GROUP BY c.CustomerId, c.SupportRepId\n    HAVING COUNT(i.InvoiceId) >= 2\n  ),\n  -- Total invoice amount per customer in the last six months\n  customer_totals AS (\n    SELECT fc.CustomerId, fc.SupportRepId,\n           SUM(i.Total) AS total_last6\n    FROM filtered_customers fc\n    JOIN Invoice i ON i.CustomerId = fc.CustomerId\n    WHERE i.InvoiceDate >= date('now', '-6 months')\n    GROUP BY fc.CustomerId, fc.SupportRepId\n  ),\n  -- Average monthly invoice value per customer\n  customer_avg_monthly AS (\n    SELECT CustomerId, SupportRepId,\n           total_last6 / 6.0 AS avg_monthly_invoice\n    FROM customer_totals\n  ),\n  -- Average monthly invoice value per support rep\n  rep_avg AS (\n    SELECT SupportRepId,\n           AVG(avg_monthly_invoice) AS rep_avg_monthly_invoice\n    FROM customer_avg_monthly\n    GROUP BY SupportRepId\n  ),\n  -- Overall average across all support reps\n  overall_avg AS (\n    SELECT AVG(rep_avg_monthly_invoice) AS overall_avg_monthly_invoice\n    FROM rep_avg\n  ),\n  -- Maximum rep average\n  max_rep_avg AS (\n    SELECT MAX(rep_avg_monthly_invoice) AS max_avg\n    FROM rep_avg\n  ),\n  -- Reps that achieve the maximum\n  top_reps AS (\n    SELECT SupportRepId, rep_avg_monthly_invoice\n    FROM rep_avg\n    WHERE rep_avg_monthly_invoice = (SELECT max_avg FROM max_rep_avg)\n  ),\n  -- Rep info with manager name\n  rep_info AS (\n    SELECT e.EmployeeId AS SupportRepId,\n           e.FirstName || ' ' || e.LastName AS rep_name,\n           m.FirstName || ' ' || m.LastName AS manager_name,\n           r.rep_avg_monthly_invoice\n    FROM top_reps r\n    JOIN Employee e ON e.EmployeeId = r.SupportRepId\n    LEFT JOIN Employee m ON m.EmployeeId = e.ReportsTo\n  ),\n  -- Average unit price of tracks purchased by each customer in last six months\n  customer_avg_unit_price AS (\n    SELECT i.CustomerId,\n           AVG(t.UnitPrice) AS avg_unit_price\n    FROM Invoice i\n    JOIN InvoiceLine il ON il.InvoiceId = i.InvoiceId\n    JOIN Track t ON t.TrackId = il.TrackId\n    WHERE i.InvoiceDate >= date('now', '-6 months')\n    GROUP BY i.CustomerId\n  )\nSELECT\n  ri.SupportRepId,\n  ri.rep_name,\n  ri.manager_name,\n  ri.rep_avg_monthly_invoice,\n  oa.overall_avg_monthly_invoice,\n  ri.rep_avg_monthly_invoice - oa.overall_avg_monthly_invoice AS diff,\n  (ri.rep_avg_monthly_invoice / oa.overall_avg_monthly_invoice) AS ratio,\n  c.CustomerId,\n  c.FirstName || ' ' || c.LastName AS customer_name,\n  cup.avg_unit_price\nFROM rep_info ri\nJOIN filtered_customers fc ON fc.SupportRepId = ri.SupportRepId\nJOIN Customer c ON c.CustomerId = fc.CustomerId\nJOIN customer_avg_unit_price cup ON cup.CustomerId = c.CustomerId\nCROSS JOIN overall_avg oa\nORDER BY ri.SupportRepId, c.CustomerId;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "286287049a18e9332af358b6f403d11a",
          "output": [
            {
              "question": "For the past two years, what is the running total of invoice amounts per month, and for each month, how many invoices were issued, what were the average, minimum, and maximum invoice amounts, and how does the month’s total compare to the previous month in terms of growth percentage?",
              "sql": "WITH monthly AS (\n  SELECT\n    strftime('%Y-%m', InvoiceDate) AS month,\n    COUNT(*) AS invoice_count,\n    SUM(Total) AS month_total,\n    AVG(Total) AS avg_total,\n    MIN(Total) AS min_total,\n    MAX(Total) AS max_total\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-2 years')\n  GROUP BY month\n)\nSELECT\n  month,\n  invoice_count,\n  month_total,\n  avg_total,\n  min_total,\n  max_total,\n  SUM(month_total) OVER (ORDER BY month) AS running_total,\n  ROUND(\n    (month_total - LAG(month_total) OVER (ORDER BY month)) / NULLIF(LAG(month_total) OVER (ORDER BY month), 0) * 100,\n    2\n  ) AS growth_pct\nFROM monthly\nORDER BY month;",
              "success": true
            },
            {
              "question": "For invoices in the last two years that were billed in the United Kingdom and have a total amount exceeding $50, and where the customer has made at least five invoices overall, what is the running total of invoice amounts per month and how does each month’s total compare to the previous month in terms of growth percentage?",
              "sql": "WITH filtered_invoices AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total\n  FROM Invoice i\n  WHERE i.InvoiceDate >= date('now', '-2 years')\n    AND i.BillingCountry = 'United Kingdom'\n    AND i.Total > 50\n),\ncustomer_counts AS (\n  SELECT CustomerId\n  FROM Invoice\n  GROUP BY CustomerId\n  HAVING COUNT(*) >= 5\n),\nmonthly_totals AS (\n  SELECT\n    strftime('%Y-%m', fi.InvoiceDate) AS month,\n    SUM(fi.Total) AS month_total\n  FROM filtered_invoices fi\n  JOIN customer_counts cc ON fi.CustomerId = cc.CustomerId\n  GROUP BY month\n)\nSELECT\n  month,\n  month_total,\n  SUM(month_total) OVER (ORDER BY month) AS running_total,\n  ROUND(\n    (month_total - LAG(month_total) OVER (ORDER BY month)) /\n    LAG(month_total) OVER (ORDER BY month) * 100,\n    2\n  ) AS growth_percent\nFROM monthly_totals\nORDER BY month;",
              "success": true
            },
            {
              "question": "For each month in the last two years, list the running total of invoice amounts, the average total per customer for that month, and the month‑over‑month growth percentage of the total, all grouped by the city of the customer’s support representative. Include the representative’s name and city next to each month’s figures.",
              "sql": "WITH monthly AS (\n  SELECT\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    e.City AS rep_city,\n    e.FirstName || ' ' || e.LastName AS rep_name,\n    SUM(i.Total) AS month_total,\n    COUNT(DISTINCT c.CustomerId) AS customer_count\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  WHERE i.InvoiceDate >= date('now', '-2 years')\n  GROUP BY month, rep_city, rep_name\n)\nSELECT\n  month,\n  rep_city,\n  rep_name,\n  SUM(month_total) OVER (PARTITION BY rep_city ORDER BY month) AS running_total,\n  month_total / customer_count AS avg_per_customer,\n  ((month_total - LAG(month_total) OVER (PARTITION BY rep_city ORDER BY month))\n   / NULLIF(LAG(month_total) OVER (PARTITION BY rep_city ORDER BY month), 0)) * 100 AS growth_percent\nFROM monthly\nORDER BY rep_city, month;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "c1a3efe344ea24a7bababaf420d38694",
          "output": [
            {
              "question": "For each country, rank customers by their total spend and list the top 5 customers, showing for each their total spend, the number of invoices they issued, the average invoice amount, and the percentage of the country’s total revenue that they represent.",
              "sql": "WITH customer_totals AS (\n  SELECT c.Country,\n         c.CustomerId,\n         c.FirstName,\n         c.LastName,\n         SUM(i.Total) AS total_spend,\n         COUNT(i.InvoiceId) AS invoice_count,\n         AVG(i.Total) AS avg_invoice\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  GROUP BY c.Country, c.CustomerId, c.FirstName, c.LastName\n),\nranked AS (\n  SELECT ct.*,\n         SUM(total_spend) OVER (PARTITION BY Country) AS country_total,\n         RANK() OVER (PARTITION BY Country ORDER BY total_spend DESC) AS rank\n  FROM customer_totals ct\n)\nSELECT Country,\n       CustomerId,\n       FirstName,\n       LastName,\n       total_spend,\n       invoice_count,\n       avg_invoice,\n       ROUND(total_spend * 100.0 / country_total, 2) AS percentage_of_country_revenue,\n       rank\nFROM ranked\nWHERE rank <= 5\nORDER BY Country, rank;",
              "success": true
            },
            {
              "question": "Rank customers within each country by their total spend for invoices dated in the last 12 months, but only consider customers who have made at least 5 purchases and whose total spend exceeds $2000, and show the top 5 customers per country along with the percentage of that country’s total revenue they represent.",
              "sql": "WITH customer_spend AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    c.Country,\n    COUNT(i.InvoiceId) AS InvoiceCount,\n    SUM(i.Total) AS TotalSpend\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE i.InvoiceDate >= date('now', '-12 months')\n  GROUP BY c.CustomerId, c.FirstName, c.LastName, c.Country\n  HAVING COUNT(i.InvoiceId) >= 5 AND SUM(i.Total) > 2000\n),\ncountry_totals AS (\n  SELECT\n    Country,\n    SUM(TotalSpend) AS CountryTotal\n  FROM customer_spend\n  GROUP BY Country\n),\nranked AS (\n  SELECT\n    cs.CustomerId,\n    cs.FirstName,\n    cs.LastName,\n    cs.Country,\n    cs.TotalSpend,\n    cs.InvoiceCount,\n    ct.CountryTotal,\n    (cs.TotalSpend / ct.CountryTotal) * 100 AS Percentage,\n    ROW_NUMBER() OVER (PARTITION BY cs.Country ORDER BY cs.TotalSpend DESC) AS rn\n  FROM customer_spend cs\n  JOIN country_totals ct ON cs.Country = ct.Country\n)\nSELECT\n  CustomerId,\n  FirstName,\n  LastName,\n  Country,\n  TotalSpend,\n  InvoiceCount,\n  ROUND(Percentage, 2) AS Percentage\nFROM ranked\nWHERE rn <= 5\nORDER BY Country, TotalSpend DESC;",
              "success": true
            },
            {
              "question": "For every country, list the five customers with the highest total spend, showing each customer's full name, their total spend, the percentage of that country's overall revenue they account for, the name of the support representative assigned to that customer, and the manager of that support representative.",
              "sql": "WITH customer_totals AS (\n  SELECT\n    c.CustomerId,\n    c.Country,\n    c.FirstName,\n    c.LastName,\n    SUM(i.Total) AS TotalSpend,\n    c.SupportRepId\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  GROUP BY c.CustomerId, c.Country, c.FirstName, c.LastName, c.SupportRepId\n),\ncountry_totals AS (\n  SELECT\n    Country,\n    SUM(TotalSpend) AS CountryTotal\n  FROM customer_totals\n  GROUP BY Country\n),\nranked AS (\n  SELECT\n    ct.CustomerId,\n    ct.Country,\n    ct.FirstName,\n    ct.LastName,\n    ct.TotalSpend,\n    ct.SupportRepId,\n    ct2.CountryTotal,\n    ROW_NUMBER() OVER (PARTITION BY ct.Country ORDER BY ct.TotalSpend DESC) AS rn\n  FROM customer_totals ct\n  JOIN country_totals ct2 ON ct.Country = ct2.Country\n)\nSELECT\n  r.Country,\n  r.FirstName || ' ' || r.LastName AS FullName,\n  r.TotalSpend,\n  (r.TotalSpend * 100.0 / r.CountryTotal) AS PercentOfCountry,\n  COALESCE(sr.FirstName || ' ' || sr.LastName, 'N/A') AS SupportRepName,\n  COALESCE(mgr.FirstName || ' ' || mgr.LastName, 'N/A') AS ManagerName\nFROM ranked r\nLEFT JOIN Employee sr ON r.SupportRepId = sr.EmployeeId\nLEFT JOIN Employee mgr ON sr.ReportsTo = mgr.EmployeeId\nWHERE r.rn <= 5\nORDER BY r.Country, r.TotalSpend DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "451990c0a4f83f631c9f7fd40e5521cd",
          "output": [
            {
              "question": "For each music genre, calculate the moving average of monthly invoice totals over the past six months, the overall average monthly total, the total number of invoices issued in the current month, and the average quantity of tracks sold per invoice in that month. Then identify the genres whose current month’s moving average is at least fifteen percent higher than the genre’s overall average, and rank those genres by their average quantity sold per invoice.",
              "sql": "WITH monthly_genre_totals AS (\n  SELECT\n    g.GenreId,\n    g.Name AS GenreName,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(il.UnitPrice * il.Quantity) AS monthly_total\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY g.GenreId, month\n),\nmoving_avg AS (\n  SELECT\n    GenreId,\n    GenreName,\n    month,\n    monthly_total,\n    AVG(monthly_total) OVER (PARTITION BY GenreId ORDER BY month ROWS BETWEEN 5 PRECEDING AND CURRENT ROW) AS moving_avg_6m,\n    AVG(monthly_total) OVER (PARTITION BY GenreId) AS overall_avg_monthly_total\n  FROM monthly_genre_totals\n),\ncurrent_month AS (\n  SELECT MAX(month) AS current_month FROM monthly_genre_totals\n),\ncurrent_month_stats AS (\n  SELECT\n    g.GenreId,\n    g.Name AS GenreName,\n    COUNT(DISTINCT i.InvoiceId) AS invoices_in_current_month,\n    SUM(il.Quantity) AS total_quantity_in_current_month,\n    SUM(il.Quantity) * 1.0 / COUNT(DISTINCT i.InvoiceId) AS avg_quantity_per_invoice\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  JOIN current_month cm ON strftime('%Y-%m', i.InvoiceDate) = cm.current_month\n  GROUP BY g.GenreId\n)\nSELECT\n  ma.GenreName,\n  ma.moving_avg_6m,\n  ma.overall_avg_monthly_total,\n  cms.invoices_in_current_month,\n  cms.avg_quantity_per_invoice\nFROM moving_avg ma\nJOIN current_month_stats cms ON ma.GenreId = cms.GenreId\nJOIN current_month cm ON ma.month = cm.current_month\nWHERE ma.moving_avg_6m >= 1.15 * ma.overall_avg_monthly_total\nORDER BY cms.avg_quantity_per_invoice DESC;",
              "success": true
            },
            {
              "question": "Calculate the moving average of monthly invoice totals over the past six months for each genre, but only include invoices from customers who are located in the United States and who have placed at least three invoices in the preceding 12 months. Identify those genres where the current month’s moving average is at least fifteen percent higher than the genre’s overall average.",
              "sql": "WITH filtered_invoices AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE c.Country = 'United States'\n    AND (\n      SELECT COUNT(*)\n      FROM Invoice i2\n      WHERE i2.CustomerId = i.CustomerId\n        AND i2.InvoiceDate < i.InvoiceDate\n        AND i2.InvoiceDate >= datetime(i.InvoiceDate, '-12 months')\n    ) >= 3\n),\ninvoice_genre_totals AS (\n  SELECT\n    strftime('%Y-%m', fi.InvoiceDate) AS year_month,\n    g.GenreId,\n    g.Name AS GenreName,\n    SUM(il.UnitPrice * il.Quantity) AS month_total\n  FROM filtered_invoices fi\n  JOIN InvoiceLine il ON fi.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY year_month, g.GenreId, g.Name\n),\nmoving_avg AS (\n  SELECT\n    year_month,\n    GenreId,\n    GenreName,\n    month_total,\n    AVG(month_total) OVER (PARTITION BY GenreId ORDER BY year_month\n                           ROWS BETWEEN 5 PRECEDING AND CURRENT ROW) AS moving_avg_6m\n  FROM invoice_genre_totals\n),\noverall_avg AS (\n  SELECT\n    GenreId,\n    GenreName,\n    AVG(month_total) AS overall_avg\n  FROM invoice_genre_totals\n  GROUP BY GenreId, GenreName\n),\nlatest_month AS (\n  SELECT MAX(year_month) AS latest_month FROM invoice_genre_totals\n)\nSELECT\n  m.GenreName,\n  m.moving_avg_6m AS current_month_moving_avg,\n  o.overall_avg,\n  (m.moving_avg_6m - o.overall_avg) / o.overall_avg * 100 AS percent_increase\nFROM moving_avg m\nJOIN overall_avg o ON m.GenreId = o.GenreId\nJOIN latest_month l ON m.year_month = l.latest_month\nWHERE m.moving_avg_6m >= 1.15 * o.overall_avg;",
              "success": true
            },
            {
              "question": "For each genre, compute the moving average of monthly invoice totals over the past six months, and for the current month also show the artist who sold the most tracks in that genre and the country of the customer who generated the highest invoice total for that month. Identify genres where this current month’s moving average is at least fifteen percent higher than the genre’s overall average.",
              "sql": "WITH monthly AS (\n  SELECT\n    g.GenreId,\n    g.Name AS GenreName,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(il.UnitPrice * il.Quantity) AS monthly_total\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY g.GenreId, month\n),\nmoving AS (\n  SELECT\n    GenreId,\n    GenreName,\n    month,\n    monthly_total,\n    AVG(monthly_total) OVER (PARTITION BY GenreId ORDER BY month ROWS BETWEEN 5 PRECEDING AND CURRENT ROW) AS moving_avg6,\n    AVG(monthly_total) OVER (PARTITION BY GenreId) AS overall_avg\n  FROM monthly\n),\ncurrent AS (\n  SELECT\n    GenreId,\n    GenreName,\n    month,\n    moving_avg6,\n    overall_avg\n  FROM moving\n  WHERE month = strftime('%Y-%m', 'now')\n),\nartist_top AS (\n  SELECT\n    t.GenreId,\n    a.ArtistId,\n    a.Name AS ArtistName,\n    SUM(il.Quantity) AS total_qty,\n    ROW_NUMBER() OVER (PARTITION BY t.GenreId ORDER BY SUM(il.Quantity) DESC) AS rn\n  FROM InvoiceLine il\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  WHERE strftime('%Y-%m', i.InvoiceDate) = strftime('%Y-%m', 'now')\n  GROUP BY t.GenreId, a.ArtistId\n),\ntop_artist AS (\n  SELECT GenreId, ArtistName\n  FROM artist_top\n  WHERE rn = 1\n),\ncountry_top AS (\n  SELECT\n    i.InvoiceId,\n    i.CustomerId,\n    c.Country,\n    i.Total,\n    ROW_NUMBER() OVER (ORDER BY i.Total DESC) AS rn\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE strftime('%Y-%m', i.InvoiceDate) = strftime('%Y-%m', 'now')\n)\nSELECT\n  c.GenreName,\n  c.month AS CurrentMonth,\n  c.moving_avg6 AS MovingAvg6,\n  t.ArtistName AS TopArtist,\n  ct.Country AS TopCountry,\n  c.overall_avg AS OverallAvg,\n  CASE WHEN c.moving_avg6 >= 1.15 * c.overall_avg THEN 1 ELSE 0 END AS IsHigherThan15Percent\nFROM current c\nLEFT JOIN top_artist t ON c.GenreId = t.GenreId\nLEFT JOIN country_top ct ON ct.rn = 1\nWHERE c.moving_avg6 >= 1.15 * c.overall_avg;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "49ee20299bb105e667192d7d246d64fc",
          "output": [
            {
              "question": "For each track, compute the total quantity sold and total revenue in the current quarter and the previous quarter, then calculate the percentage change in both quantity and revenue. Rank the tracks by a weighted score that gives 70% weight to the quantity change and 30% to the revenue change, and list the top 10 tracks with the greatest overall decline. Include in the output the track name, the weighted decline score, the percentage change in quantity, the percentage change in revenue, the average unit price of the track, and the number of distinct customers who purchased the track during the current quarter.",
              "sql": "WITH quarter_dates AS (\n  SELECT\n    date('now', 'start of month', '-' || ((CAST(strftime('%m', date('now')) AS INTEGER)-1) % 3) || ' months') AS current_start\n),\nquarter_bounds AS (\n  SELECT\n    current_start,\n    date(current_start, '+3 months', '-1 day') AS current_end,\n    date(current_start, '-3 months') AS prev_start,\n    date(current_start, '-1 day') AS prev_end\n  FROM quarter_dates\n),\ncurrent_sales AS (\n  SELECT\n    il.TrackId,\n    SUM(il.Quantity) AS curr_qty,\n    SUM(il.UnitPrice * il.Quantity) AS curr_rev\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN quarter_bounds qb ON i.InvoiceDate BETWEEN qb.current_start AND qb.current_end\n  GROUP BY il.TrackId\n),\nprev_sales AS (\n  SELECT\n    il.TrackId,\n    SUM(il.Quantity) AS prev_qty,\n    SUM(il.UnitPrice * il.Quantity) AS prev_rev\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN quarter_bounds qb ON i.InvoiceDate BETWEEN qb.prev_start AND qb.prev_end\n  GROUP BY il.TrackId\n),\ncustomers_current AS (\n  SELECT\n    il.TrackId,\n    COUNT(DISTINCT i.CustomerId) AS distinct_customers\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN quarter_bounds qb ON i.InvoiceDate BETWEEN qb.current_start AND qb.current_end\n  GROUP BY il.TrackId\n),\ntrack_stats AS (\n  SELECT\n    t.TrackId,\n    t.Name,\n    t.UnitPrice,\n    COALESCE(cs.curr_qty, 0) AS curr_qty,\n    COALESCE(cs.curr_rev, 0) AS curr_rev,\n    COALESCE(ps.prev_qty, 0) AS prev_qty,\n    COALESCE(ps.prev_rev, 0) AS prev_rev,\n    COALESCE(cc.distinct_customers, 0) AS distinct_customers\n  FROM Track t\n  LEFT JOIN current_sales cs ON t.TrackId = cs.TrackId\n  LEFT JOIN prev_sales ps ON t.TrackId = ps.TrackId\n  LEFT JOIN customers_current cc ON t.TrackId = cc.TrackId\n),\nchanges AS (\n  SELECT\n    ts.TrackId,\n    ts.Name,\n    ts.UnitPrice,\n    ts.curr_qty,\n    ts.prev_qty,\n    ts.curr_rev,\n    ts.prev_rev,\n    ts.distinct_customers,\n    CASE WHEN ts.prev_qty = 0 THEN NULL ELSE ((ts.curr_qty - ts.prev_qty) * 100.0 / ts.prev_qty) END AS pct_qty_change,\n    CASE WHEN ts.prev_rev = 0 THEN NULL ELSE ((ts.curr_rev - ts.prev_rev) * 100.0 / ts.prev_rev) END AS pct_rev_change,\n    0.7 * CASE WHEN ts.prev_qty = 0 THEN NULL ELSE ((ts.curr_qty - ts.prev_qty) * 100.0 / ts.prev_qty) END\n    + 0.3 * CASE WHEN ts.prev_rev = 0 THEN NULL ELSE ((ts.curr_rev - ts.prev_rev) * 100.0 / ts.prev_rev) END AS weighted_decline\n  FROM track_stats ts\n)\nSELECT\n  Name AS track_name,\n  weighted_decline,\n  pct_qty_change,\n  pct_rev_change,\n  UnitPrice AS average_unit_price,\n  distinct_customers\nFROM changes\nWHERE weighted_decline IS NOT NULL\nORDER BY weighted_decline ASC\nLIMIT 10;",
              "success": true
            },
            {
              "question": "Determine the trend of track sales by comparing the quantity sold in the current quarter versus the previous quarter, rank tracks by the percentage change, highlight tracks with a decline greater than thirty percent, but only for tracks in the \"Rock\" genre that have sold at least 200 units in the current year and whose total revenue in the current quarter exceeds $1,000.",
              "sql": "WITH date_info AS (\n  SELECT\n    strftime('%Y', 'now') AS current_year,\n    ((CAST(strftime('%m', 'now') AS INTEGER)-1)/3)+1 AS current_quarter,\n    CASE\n      WHEN ((CAST(strftime('%m', 'now') AS INTEGER)-1)/3)+1 > 1\n      THEN strftime('%Y', 'now')\n      ELSE CAST(strftime('%Y', 'now') AS INTEGER)-1\n    END AS prev_year,\n    CASE\n      WHEN ((CAST(strftime('%m', 'now') AS INTEGER)-1)/3)+1 > 1\n      THEN ((CAST(strftime('%m', 'now') AS INTEGER)-1)/3)\n      ELSE 4\n    END AS prev_quarter\n),\nsales AS (\n  SELECT\n    t.TrackId,\n    t.Name AS TrackName,\n    g.Name AS GenreName,\n    strftime('%Y', i.InvoiceDate) AS year,\n    ((CAST(strftime('%m', i.InvoiceDate) AS INTEGER)-1)/3)+1 AS quarter,\n    SUM(il.Quantity) AS qty,\n    SUM(il.UnitPrice * il.Quantity) AS revenue\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE g.Name = 'Rock'\n  GROUP BY t.TrackId, year, quarter\n),\ncurrent_quarter AS (\n  SELECT\n    TrackId,\n    TrackName,\n    GenreName,\n    qty AS current_qty,\n    revenue AS current_revenue\n  FROM sales\n  JOIN date_info ON sales.year = date_info.current_year\n    AND sales.quarter = date_info.current_quarter\n),\nprevious_quarter AS (\n  SELECT\n    TrackId,\n    qty AS prev_qty\n  FROM sales\n  JOIN date_info ON sales.year = date_info.prev_year\n    AND sales.quarter = date_info.prev_quarter\n),\ncurrent_year_total AS (\n  SELECT\n    TrackId,\n    SUM(qty) AS total_units_current_year\n  FROM sales\n  JOIN date_info ON sales.year = date_info.current_year\n  GROUP BY TrackId\n)\nSELECT\n  cq.TrackId,\n  cq.TrackName,\n  cq.current_qty,\n  pq.prev_qty,\n  ((cq.current_qty - pq.prev_qty) * 100.0 / NULLIF(pq.prev_qty, 0)) AS percent_change,\n  ROW_NUMBER() OVER (ORDER BY ((cq.current_qty - pq.prev_qty) * 100.0 / NULLIF(pq.prev_qty, 0)) DESC) AS rank,\n  CASE WHEN ((cq.current_qty - pq.prev_qty) * 100.0 / NULLIF(pq.prev_qty, 0)) < -30 THEN 1 ELSE 0 END AS decline_flag\nFROM current_quarter cq\nJOIN previous_quarter pq ON cq.TrackId = pq.TrackId\nJOIN current_year_total cy ON cq.TrackId = cy.TrackId\nWHERE cy.total_units_current_year >= 200\n  AND cq.current_revenue > 1000\nORDER BY percent_change DESC;",
              "success": true
            },
            {
              "question": "Determine the trend of track sales by comparing the quantity sold in the current quarter versus the previous quarter, and rank tracks by the percentage change. Highlight tracks with a decline greater than thirty percent. For each track, also include the artist name, album title, genre name, and the total revenue generated in each quarter.",
              "sql": "WITH invoice_quarters AS (\n  SELECT\n    i.InvoiceId,\n    CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) AS year,\n    CASE\n      WHEN CAST(strftime('%m', i.InvoiceDate) AS INTEGER) BETWEEN 1 AND 3 THEN 1\n      WHEN CAST(strftime('%m', i.InvoiceDate) AS INTEGER) BETWEEN 4 AND 6 THEN 2\n      WHEN CAST(strftime('%m', i.InvoiceDate) AS INTEGER) BETWEEN 7 AND 9 THEN 3\n      ELSE 4\n    END AS quarter,\n    CAST(strftime('%Y', i.InvoiceDate) AS INTEGER)*10 + \n      CASE\n        WHEN CAST(strftime('%m', i.InvoiceDate) AS INTEGER) BETWEEN 1 AND 3 THEN 1\n        WHEN CAST(strftime('%m', i.InvoiceDate) AS INTEGER) BETWEEN 4 AND 6 THEN 2\n        WHEN CAST(strftime('%m', i.InvoiceDate) AS INTEGER) BETWEEN 7 AND 9 THEN 3\n        ELSE 4\n      END AS quarter_num\n  FROM Invoice i\n),\nlatest_quarter AS (\n  SELECT MAX(quarter_num) AS current_quarter_num,\n         MAX(year) AS current_year,\n         MAX(quarter) AS current_quarter\n  FROM invoice_quarters\n),\nprev_quarter AS (\n  SELECT\n    CASE WHEN current_quarter > 1 THEN current_year*10 + (current_quarter-1)\n         ELSE (current_year-1)*10 + 4\n    END AS prev_quarter_num\n  FROM latest_quarter\n),\ntrack_sales AS (\n  SELECT\n    t.TrackId,\n    t.Name AS track_name,\n    a.Title AS album_title,\n    ar.Name AS artist_name,\n    g.Name AS genre_name,\n    il.Quantity,\n    il.UnitPrice,\n    iq.quarter_num\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album a ON t.AlbumId = a.AlbumId\n  JOIN Artist ar ON a.ArtistId = ar.ArtistId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  JOIN invoice_quarters iq ON i.InvoiceId = iq.InvoiceId\n)\nSELECT\n  ts.track_name,\n  ts.artist_name,\n  ts.album_title,\n  ts.genre_name,\n  SUM(CASE WHEN ts.quarter_num = lq.current_quarter_num THEN ts.Quantity END) AS current_qty,\n  SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.Quantity END) AS prev_qty,\n  SUM(CASE WHEN ts.quarter_num = lq.current_quarter_num THEN ts.UnitPrice * ts.Quantity END) AS current_revenue,\n  SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.UnitPrice * ts.Quantity END) AS prev_revenue,\n  ROUND(\n    ((SUM(CASE WHEN ts.quarter_num = lq.current_quarter_num THEN ts.Quantity END) -\n      SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.Quantity END)) /\n     NULLIF(SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.Quantity END), 0)) * 100,\n    2\n  ) AS percent_change,\n  CASE WHEN ((SUM(CASE WHEN ts.quarter_num = lq.current_quarter_num THEN ts.Quantity END) -\n      SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.Quantity END)) /\n     NULLIF(SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.Quantity END), 0)) * 100 < -30 THEN 'Yes' ELSE 'No' END AS decline_flag,\n  ROW_NUMBER() OVER (ORDER BY\n    ((SUM(CASE WHEN ts.quarter_num = lq.current_quarter_num THEN ts.Quantity END) -\n      SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.Quantity END)) /\n     NULLIF(SUM(CASE WHEN ts.quarter_num = pq.prev_quarter_num THEN ts.Quantity END), 0)) * 100 DESC\n  ) AS rank\nFROM track_sales ts\nJOIN latest_quarter lq\nJOIN prev_quarter pq\nGROUP BY ts.TrackId\nORDER BY percent_change DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "6914a8412ff249f720da7c93ab2ca618",
          "output": [
            {
              "question": "How many invoices has customer 42 placed, what is the total amount they've spent, and what is their average invoice amount?",
              "sql": "SELECT COUNT(*) AS invoice_count, SUM(Total) AS total_spent, AVG(Total) AS avg_invoice FROM Invoice WHERE CustomerId = 42;",
              "success": true
            },
            {
              "question": "Who is customer 42 who has made more than 5 purchases?",
              "sql": "SELECT c.*\nFROM Customer c\nJOIN Invoice i ON c.CustomerId = i.CustomerId\nWHERE c.CustomerId = 42\nGROUP BY c.CustomerId\nHAVING COUNT(i.InvoiceId) > 5;",
              "success": true
            },
            {
              "question": "What are the details of customer 42, including the name of their support representative and the total amount they have spent on invoices?",
              "sql": "SELECT c.*, e.FirstName || ' ' || e.LastName AS SupportRepName, IFNULL(SUM(i.Total),0) AS TotalSpent FROM Customer c LEFT JOIN Employee e ON c.SupportRepId = e.EmployeeId LEFT JOIN Invoice i ON c.CustomerId = i.CustomerId WHERE c.CustomerId = 42 GROUP BY c.CustomerId, e.EmployeeId;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "1a0256d5e4d8ea8722a15c878bb2a22e",
          "output": [
            {
              "question": "For each customer, how many invoices have a total greater than $0, and what is the average total amount of those invoices?",
              "sql": "SELECT c.CustomerId,\n       c.FirstName,\n       c.LastName,\n       COUNT(*) AS invoice_count,\n       AVG(i.Total) AS avg_total\nFROM Customer c\nJOIN Invoice i ON c.CustomerId = i.CustomerId\nWHERE i.Total > 0\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nORDER BY c.CustomerId;",
              "success": true
            },
            {
              "question": "Which invoices have a total greater than $0 and were issued to customers located in the United States during the past 12 months?",
              "sql": "SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total\nFROM Invoice i\nJOIN Customer c ON i.CustomerId = c.CustomerId\nWHERE i.Total > 0\n  AND c.Country = 'United States'\n  AND i.InvoiceDate >= date('now', '-12 months');",
              "success": true
            },
            {
              "question": "Which invoices have a total greater than $0, along with the customer's full name and the support representative's full name, sorted by invoice date descending.",
              "sql": "SELECT i.InvoiceId,\n       i.Total,\n       i.InvoiceDate,\n       c.FirstName || ' ' || c.LastName AS CustomerName,\n       e.FirstName || ' ' || e.LastName AS SupportRepName\nFROM Invoice i\nJOIN Customer c ON i.CustomerId = c.CustomerId\nLEFT JOIN Employee e ON c.SupportRepId = e.EmployeeId\nWHERE i.Total > 0\nORDER BY i.InvoiceDate DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "54010927f6f0d754b1b1370425a6da8c",
          "output": [
            {
              "question": "Which tracks have been sold, and for each track, how many units have been sold and what is the total revenue generated?",
              "sql": "SELECT t.TrackId,\n       t.Name,\n       SUM(il.Quantity) AS UnitsSold,\n       SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM InvoiceLine il\nJOIN Track t ON il.TrackId = t.TrackId\nGROUP BY t.TrackId, t.Name\nORDER BY TotalRevenue DESC;",
              "success": true
            },
            {
              "question": "Which tracks have been sold more than five times in the last 90 days to customers located in the United Kingdom?",
              "sql": "SELECT t.Name, SUM(il.Quantity) AS total_sold\nFROM InvoiceLine il\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Customer c ON i.CustomerId = c.CustomerId\nJOIN Track t ON il.TrackId = t.TrackId\nWHERE i.InvoiceDate >= date('now', '-90 days')\n  AND c.Country = 'United Kingdom'\nGROUP BY t.TrackId, t.Name\nHAVING SUM(il.Quantity) > 5\nORDER BY total_sold DESC;",
              "success": true
            },
            {
              "question": "Which tracks have been sold, along with the number of times each track was sold, the total revenue generated, and the names of the artists who performed them?",
              "sql": "SELECT t.Name AS TrackName, a.Name AS ArtistName, SUM(il.Quantity) AS UnitsSold, SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM InvoiceLine il\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Album al ON t.AlbumId = al.AlbumId\nJOIN Artist a ON al.ArtistId = a.ArtistId\nGROUP BY t.TrackId, t.Name, a.Name\nORDER BY TotalRevenue DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "653e6cf8f2543bf0a7df658730a21b5c",
          "output": [
            {
              "question": "Identify the support representative assigned to customer 42 and report how many customers they handle in total, as well as the average total invoice amount for those customers.",
              "sql": "SELECT\n    e.EmployeeId,\n    e.FirstName,\n    e.LastName,\n    COUNT(DISTINCT c2.CustomerId) AS customer_count,\n    AVG(i.Total) AS avg_invoice_total\nFROM\n    Customer c1\nJOIN\n    Employee e ON c1.SupportRepId = e.EmployeeId\nJOIN\n    Customer c2 ON c2.SupportRepId = e.EmployeeId\nLEFT JOIN\n    Invoice i ON i.CustomerId = c2.CustomerId\nWHERE\n    c1.CustomerId = 42\nGROUP BY\n    e.EmployeeId, e.FirstName, e.LastName;",
              "success": true
            },
            {
              "question": "Which support representative is assigned to customer 42, who has made at least one invoice exceeding $100 in the past 30 days?",
              "sql": "SELECT e.*\nFROM Employee e\nJOIN Customer c ON e.EmployeeId = c.SupportRepId\nWHERE c.CustomerId = 42\n  AND EXISTS (\n    SELECT 1\n    FROM Invoice i\n    WHERE i.CustomerId = 42\n      AND i.Total > 100\n      AND i.InvoiceDate >= date('now', '-30 days')\n  );",
              "success": true
            },
            {
              "question": "For customer 42, what is the name of the assigned support representative, their manager's name, the representative's title, and the customer's company?",
              "sql": "SELECT e.FirstName || ' ' || e.LastName AS SupportRepName,\n       m.FirstName || ' ' || m.LastName AS ManagerName,\n       e.Title,\n       c.Company\nFROM Customer c\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nLEFT JOIN Employee m ON e.ReportsTo = m.EmployeeId\nWHERE c.CustomerId = 42;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "3190852ae09f089e16958be930e3f4e5",
          "output": [
            {
              "question": "For each customer assigned to the support representative with last name 'Smith', list the customer’s name, the total amount of invoices they placed in the past year, the number of invoices, and the average invoice amount, but only include customers whose total invoice amount exceeds $200.",
              "sql": "SELECT c.FirstName || ' ' || c.LastName AS customer_name,\n       SUM(i.Total) AS total_amount,\n       COUNT(i.InvoiceId) AS invoice_count,\n       AVG(i.Total) AS avg_amount\nFROM Customer c\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nJOIN Invoice i ON c.CustomerId = i.CustomerId\nWHERE e.LastName = 'Smith'\n  AND i.InvoiceDate >= date('now', '-1 year')\nGROUP BY c.CustomerId\nHAVING SUM(i.Total) > 200\nORDER BY total_amount DESC;",
              "success": true
            },
            {
              "question": "Which customers assigned to the support representative with last name 'Smith' have placed invoices totaling more than $200 in the last year, whose most recent invoice was issued within the last 30 days, and whose total invoice amount exceeds their average invoice amount by at least 25%?",
              "sql": "SELECT c.CustomerId, c.FirstName, c.LastName, c.Email\nFROM Customer c\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nJOIN Invoice i ON i.CustomerId = c.CustomerId\nWHERE e.LastName = 'Smith'\n  AND i.InvoiceDate >= date('now', '-1 year')\nGROUP BY c.CustomerId, c.FirstName, c.LastName, c.Email\nHAVING SUM(i.Total) > 200\n   AND MAX(i.InvoiceDate) >= date('now', '-30 days')\n   AND SUM(i.Total) > AVG(i.Total) * 1.25;",
              "success": true
            },
            {
              "question": "List each customer who is assigned to a support representative named Smith, along with that support rep's manager's name, the customer's city and state, and the number of invoices they placed in the last year, provided the customer spent over $200 in total during that period.",
              "sql": "SELECT\n  c.FirstName,\n  c.LastName,\n  m.FirstName || ' ' || m.LastName AS ManagerName,\n  c.City,\n  c.State,\n  COUNT(i.InvoiceId) AS InvoiceCount\nFROM Customer c\nJOIN Employee s ON c.SupportRepId = s.EmployeeId\nLEFT JOIN Employee m ON s.ReportsTo = m.EmployeeId\nJOIN Invoice i ON i.CustomerId = c.CustomerId\nWHERE s.LastName = 'Smith'\n  AND i.InvoiceDate >= datetime('now', '-1 year')\nGROUP BY c.CustomerId, c.FirstName, c.LastName, m.FirstName, m.LastName, c.City, c.State\nHAVING SUM(i.Total) > 200;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "e7334a6ac4ba8205c97694f805eec63e",
          "output": [
            {
              "question": "For each track that has been sold in invoices where the customer lives in California and the support rep works in the same state, report the total number of units sold, the total revenue generated, and the average unit price.",
              "sql": "SELECT t.TrackId, t.Name,\n       SUM(il.Quantity) AS total_units_sold,\n       SUM(il.UnitPrice * il.Quantity) AS total_revenue,\n       AVG(il.UnitPrice) AS avg_unit_price\nFROM InvoiceLine il\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Customer c ON i.CustomerId = c.CustomerId\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nJOIN Track t ON il.TrackId = t.TrackId\nWHERE c.State = 'California' AND e.State = c.State\nGROUP BY t.TrackId, t.Name\nORDER BY total_revenue DESC;",
              "success": true
            },
            {
              "question": "Which tracks were sold on invoices where the customer resides in California, the support representative works in the same state, the invoice total exceeds $100, the track unit price is above $1.00, and the invoice was issued within the past year?",
              "sql": "SELECT DISTINCT t.TrackId, t.Name\nFROM Invoice i\nJOIN Customer c ON i.CustomerId = c.CustomerId\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nJOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nWHERE c.State = 'California'\n  AND e.State = 'California'\n  AND i.Total > 100\n  AND t.UnitPrice > 1.00\n  AND i.InvoiceDate >= date('now', '-1 year')\nORDER BY t.Name;",
              "success": true
            },
            {
              "question": "Which tracks have been sold in invoices where the customer lives in California and the support rep works in the same state, and for each track, list the track name, album title, genre, support rep's full name, and the total revenue generated from those sales?",
              "sql": "SELECT t.Name AS track_name,\n       a.Title AS album_title,\n       g.Name AS genre_name,\n       e.FirstName || ' ' || e.LastName AS support_rep_name,\n       SUM(il.UnitPrice * il.Quantity) AS total_revenue\nFROM InvoiceLine il\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Customer c ON i.CustomerId = c.CustomerId\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nJOIN Track t ON il.TrackId = t.TrackId\nLEFT JOIN Album a ON t.AlbumId = a.AlbumId\nLEFT JOIN Genre g ON t.GenreId = g.GenreId\nWHERE c.State = 'California'\n  AND e.State = c.State\nGROUP BY t.TrackId, a.AlbumId, g.GenreId, e.EmployeeId\nORDER BY total_revenue DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "dea4cdfee83e65af532877ca19b508e8",
          "output": [
            {
              "question": "For each media type that has tracks never purchased, what is the count of such tracks and the total unit price of those tracks?",
              "sql": "SELECT mt.MediaTypeId,\n       mt.Name AS MediaTypeName,\n       COUNT(t.TrackId) AS TrackCount,\n       SUM(t.UnitPrice) AS TotalUnitPrice\nFROM MediaType mt\nJOIN Track t ON t.MediaTypeId = mt.MediaTypeId\nLEFT JOIN InvoiceLine il ON il.TrackId = t.TrackId\nWHERE il.InvoiceLineId IS NULL\nGROUP BY mt.MediaTypeId, mt.Name;",
              "success": true
            },
            {
              "question": "Which media types have tracks that have never been purchased in any invoice line in the past 12 months, and those tracks have a unit price above $1.00?",
              "sql": "SELECT DISTINCT mt.Name\nFROM MediaType mt\nJOIN Track t ON t.MediaTypeId = mt.MediaTypeId\nWHERE t.UnitPrice > 1.00\n  AND NOT EXISTS (\n    SELECT 1\n    FROM InvoiceLine il\n    JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n    WHERE il.TrackId = t.TrackId\n      AND i.InvoiceDate >= datetime('now', '-12 months')\n  );",
              "success": true
            },
            {
              "question": "Which media types contain tracks that have never been purchased, and for each such media type, list the artist name, album title, and genre of those tracks?",
              "sql": "SELECT mt.Name AS MediaType,\n       ar.Name AS Artist,\n       al.Title AS Album,\n       g.Name AS Genre\nFROM Track t\nJOIN MediaType mt ON t.MediaTypeId = mt.MediaTypeId\nJOIN Album al ON t.AlbumId = al.AlbumId\nJOIN Artist ar ON al.ArtistId = ar.ArtistId\nLEFT JOIN Genre g ON t.GenreId = g.GenreId\nLEFT JOIN InvoiceLine il ON t.TrackId = il.TrackId\nWHERE il.InvoiceLineId IS NULL\nORDER BY mt.Name, ar.Name, al.Title, g.Name;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "61d1f20b7101ad02dd8f21a98ce9aebb",
          "output": [
            {
              "question": "Identify all genres that meet the following criteria: (1) the average unit price of tracks in that genre exceeds $1.50, (2) the total number of tracks sold in the last six months is greater than 10, (3) the cumulative revenue from those sales is above $500, and (4) the average length of tracks in that genre is longer than 3 minutes.",
              "sql": "WITH track_stats AS (\n  SELECT GenreId, AVG(UnitPrice) AS avg_price, AVG(Milliseconds) AS avg_ms\n  FROM Track\n  GROUP BY GenreId\n),\nsales_stats AS (\n  SELECT t.GenreId, SUM(il.Quantity) AS total_qty, SUM(il.UnitPrice * il.Quantity) AS total_rev\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  WHERE i.InvoiceDate >= date('now', '-6 months')\n  GROUP BY t.GenreId\n)\nSELECT g.Name\nFROM Genre g\nJOIN track_stats ts ON g.GenreId = ts.GenreId\nJOIN sales_stats ss ON g.GenreId = ss.GenreId\nWHERE ts.avg_price > 1.50\n  AND ss.total_qty > 10\n  AND ss.total_rev > 500\n  AND ts.avg_ms > 180000;",
              "success": true
            },
            {
              "question": "Which genres have an average track price above $1.50, have sold more than 10 tracks in the past six months, and have tracks that have never been added to any playlist?",
              "sql": "WITH avg_price AS (\n    SELECT GenreId, AVG(UnitPrice) AS avg_price\n    FROM Track\n    GROUP BY GenreId\n    HAVING AVG(UnitPrice) > 1.5\n),\nsales AS (\n    SELECT t.GenreId, SUM(il.Quantity) AS total_qty\n    FROM InvoiceLine il\n    JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n    JOIN Track t ON il.TrackId = t.TrackId\n    WHERE i.InvoiceDate >= date('now', '-6 months')\n    GROUP BY t.GenreId\n    HAVING SUM(il.Quantity) > 10\n),\nno_playlist AS (\n    SELECT DISTINCT t.GenreId\n    FROM Track t\n    LEFT JOIN PlaylistTrack pt ON t.TrackId = pt.TrackId\n    WHERE pt.TrackId IS NULL\n)\nSELECT g.Name AS Genre\nFROM Genre g\nJOIN avg_price ap ON g.GenreId = ap.GenreId\nJOIN sales s ON g.GenreId = s.GenreId\nJOIN no_playlist np ON g.GenreId = np.GenreId;",
              "success": true
            },
            {
              "question": "List all genres whose average track unit price exceeds $1.50 and that have sold more than 10 tracks in the last six months, including the genre name, the artist name(s) of the tracks in that genre, the total revenue generated by those tracks in that period, and the number of distinct customers who purchased them.",
              "sql": "WITH recent_sales AS (\n  SELECT il.InvoiceLineId,\n         il.InvoiceId,\n         il.TrackId,\n         il.UnitPrice,\n         il.Quantity,\n         i.CustomerId,\n         i.InvoiceDate\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  WHERE i.InvoiceDate >= date('now', '-6 months')\n)\nSELECT g.Name AS GenreName,\n       group_concat(DISTINCT a.Name) AS ArtistNames,\n       SUM(rs.UnitPrice * rs.Quantity) AS TotalRevenue,\n       COUNT(DISTINCT rs.CustomerId) AS DistinctCustomers\nFROM Genre g\nJOIN Track t ON t.GenreId = g.GenreId\nJOIN Album al ON al.AlbumId = t.AlbumId\nJOIN Artist a ON a.ArtistId = al.ArtistId\nJOIN recent_sales rs ON rs.TrackId = t.TrackId\nGROUP BY g.GenreId, g.Name\nHAVING AVG(t.UnitPrice) > 1.50\n   AND SUM(rs.Quantity) > 10\nORDER BY g.Name;",
              "success": false
            }
          ]
        },
        {
          "inputHash": "f886d5d66ff0d5689ed94e05b64187c9",
          "output": [
            {
              "question": "For customers in California who spent more than the national average invoice total over the past year, list each customer’s total amount spent, the number of invoices they issued, the average invoice amount, and the maximum invoice amount, ordering the results by total spent in descending order.",
              "sql": "WITH recent_invoices AS (\n  SELECT InvoiceId, CustomerId, Total\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-1 year')\n),\nnational_avg AS (\n  SELECT AVG(Total) AS avg_total\n  FROM recent_invoices\n)\nSELECT\n  c.CustomerId,\n  c.FirstName,\n  c.LastName,\n  SUM(r.Total) AS total_spent,\n  COUNT(r.InvoiceId) AS invoice_count,\n  AVG(r.Total) AS avg_invoice_amount,\n  MAX(r.Total) AS max_invoice_amount\nFROM Customer c\nJOIN recent_invoices r ON c.CustomerId = r.CustomerId\nWHERE c.State = 'California'\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nHAVING SUM(r.Total) > (SELECT avg_total FROM national_avg)\nORDER BY total_spent DESC;",
              "success": true
            },
            {
              "question": "Identify California customers who spent more than the average invoice total for the past year, have issued at least five invoices, and whose average invoice amount exceeds $150. How many invoices have each of these customers issued?",
              "sql": "WITH past_year_invoices AS (\n  SELECT *\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-1 year')\n),\noverall_avg AS (\n  SELECT AVG(Total) AS avg_total\n  FROM past_year_invoices\n),\ncustomer_stats AS (\n  SELECT c.CustomerId,\n         c.FirstName,\n         c.LastName,\n         c.Email,\n         COUNT(pi.InvoiceId) AS invoice_count,\n         SUM(pi.Total) AS total_spent,\n         AVG(pi.Total) AS avg_invoice\n  FROM Customer c\n  JOIN past_year_invoices pi ON c.CustomerId = pi.CustomerId\n  WHERE c.State = 'California'\n  GROUP BY c.CustomerId, c.FirstName, c.LastName, c.Email\n)\nSELECT cs.CustomerId,\n       cs.FirstName,\n       cs.LastName,\n       cs.Email,\n       cs.invoice_count\nFROM customer_stats cs\nCROSS JOIN overall_avg oa\nWHERE cs.total_spent > oa.avg_total\n  AND cs.invoice_count >= 5\n  AND cs.avg_invoice > 150;",
              "success": true
            },
            {
              "question": "Which customers from California spent more than the average invoice total for the past year, and for each of those customers, what is the name of their support representative and how many invoices have they issued?",
              "sql": "WITH avg_invoice AS (\n  SELECT AVG(Total) AS avg_total\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-1 year')\n),\ncust_totals AS (\n  SELECT c.CustomerId,\n         c.FirstName || ' ' || c.LastName AS CustomerName,\n         c.SupportRepId,\n         SUM(i.Total) AS total_spent,\n         COUNT(i.InvoiceId) AS invoice_count\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE c.State = 'California'\n    AND i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY c.CustomerId, c.FirstName, c.LastName, c.SupportRepId\n)\nSELECT ct.CustomerId,\n       ct.CustomerName,\n       e.FirstName || ' ' || e.LastName AS SupportRepName,\n       ct.invoice_count\nFROM cust_totals ct\nJOIN avg_invoice ai ON 1=1\nJOIN Employee e ON ct.SupportRepId = e.EmployeeId\nWHERE ct.total_spent > ai.avg_total\nORDER BY ct.total_spent DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "72f0fd068a5da6a56e1de83e3bd13233",
          "output": [
            {
              "question": "For each support representative, calculate the month‑over‑month change in total sales and also report their average, maximum, and minimum monthly sales over the past year. Then identify which representative had the largest month‑over‑month increase in the most recent month.",
              "sql": "WITH monthly_sales AS (\n  SELECT\n    e.EmployeeId AS RepId,\n    e.FirstName || ' ' || e.LastName AS RepName,\n    strftime('%Y-%m', i.InvoiceDate) AS Month,\n    SUM(i.Total) AS TotalSales\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY RepId, RepName, Month\n),\nmom AS (\n  SELECT\n    RepId,\n    RepName,\n    Month,\n    TotalSales,\n    TotalSales - COALESCE(LAG(TotalSales) OVER (PARTITION BY RepId ORDER BY Month), 0) AS MoMChange\n  FROM monthly_sales\n),\nstats AS (\n  SELECT\n    RepId,\n    RepName,\n    AVG(TotalSales) AS AvgMonthlySales,\n    MAX(TotalSales) AS MaxMonthlySales,\n    MIN(TotalSales) AS MinMonthlySales\n  FROM monthly_sales\n  GROUP BY RepId, RepName\n),\nfinal AS (\n  SELECT\n    m.RepId,\n    m.RepName,\n    m.Month,\n    m.TotalSales,\n    m.MoMChange,\n    s.AvgMonthlySales,\n    s.MaxMonthlySales,\n    s.MinMonthlySales\n  FROM mom m\n  JOIN stats s ON m.RepId = s.RepId\n)\nSELECT * FROM final\nORDER BY RepId, Month;\n\n-- Identify the representative with the largest MoM increase in the most recent month\nWITH monthly_sales AS (\n  SELECT\n    e.EmployeeId AS RepId,\n    e.FirstName || ' ' || e.LastName AS RepName,\n    strftime('%Y-%m', i.InvoiceDate) AS Month,\n    SUM(i.Total) AS TotalSales\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY RepId, RepName, Month\n),\nmom AS (\n  SELECT\n    RepId,\n    RepName,\n    Month,\n    TotalSales,\n    TotalSales - COALESCE(LAG(TotalSales) OVER (PARTITION BY RepId ORDER BY Month), 0) AS MoMChange\n  FROM monthly_sales\n),\nmost_recent AS (\n  SELECT MAX(Month) AS RecentMonth FROM monthly_sales\n),\nrecent_mom AS (\n  SELECT\n    m.RepId,\n    m.RepName,\n    m.MoMChange\n  FROM mom m\n  JOIN most_recent r ON m.Month = r.RecentMonth\n)\nSELECT RepId, RepName, MoMChange\nFROM recent_mom\nORDER BY MoMChange DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "For each support representative who has handled invoices totaling more than $10,000 in the past year, calculate the month-over-month change in their total sales, but only consider invoices from customers in the United States. Identify which representative among them achieved the largest percentage increase in sales during the most recent month compared to the previous month.",
              "sql": "WITH monthly_totals AS (\n  SELECT e.EmployeeId,\n         e.FirstName,\n         e.LastName,\n         strftime('%Y-%m', i.InvoiceDate) AS month,\n         SUM(i.Total) AS total\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n    AND c.Country = 'United States'\n  GROUP BY e.EmployeeId, month\n),\nrep_totals AS (\n  SELECT EmployeeId,\n         FirstName,\n         LastName,\n         SUM(total) AS yearly_total\n  FROM monthly_totals\n  GROUP BY EmployeeId\n),\nmonthly_with_lag AS (\n  SELECT mt.*,\n         LAG(total) OVER (PARTITION BY EmployeeId ORDER BY month) AS prev_total\n  FROM monthly_totals mt\n),\npercent_change AS (\n  SELECT m.*,\n         (total - prev_total) / prev_total * 100.0 AS pct_change\n  FROM monthly_with_lag m\n  WHERE prev_total IS NOT NULL\n),\nfiltered AS (\n  SELECT p.*\n  FROM percent_change p\n  JOIN rep_totals r ON p.EmployeeId = r.EmployeeId\n  WHERE r.yearly_total > 10000\n),\nmost_recent AS (\n  SELECT f.*,\n         MAX(month) OVER (PARTITION BY EmployeeId) AS max_month\n  FROM filtered f\n),\nfinal AS (\n  SELECT *\n  FROM most_recent\n  WHERE month = max_month\n)\nSELECT EmployeeId,\n       FirstName,\n       LastName,\n       month,\n       total,\n       prev_total,\n       pct_change\nFROM final\nORDER BY pct_change DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "For each support representative, list the month‑over‑month change in their total sales, the genre that contributed the most revenue in each month, and the manager’s name for that representative. Also identify which representative had the largest sales increase over the most recent two months.",
              "sql": "WITH monthly_sales AS (\n  SELECT\n    e.EmployeeId AS RepId,\n    e.FirstName || ' ' || e.LastName AS RepName,\n    strftime('%Y-%m', i.InvoiceDate) AS Month,\n    SUM(i.Total) AS TotalSales\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  GROUP BY RepId, Month\n),\nmonthly_change AS (\n  SELECT\n    ms.RepId,\n    ms.RepName,\n    ms.Month,\n    ms.TotalSales,\n    COALESCE(LAG(ms.TotalSales) OVER (PARTITION BY ms.RepId ORDER BY ms.Month), 0) AS PrevTotalSales,\n    ms.TotalSales - COALESCE(LAG(ms.TotalSales) OVER (PARTITION BY ms.RepId ORDER BY ms.Month), 0) AS MoMChange\n  FROM monthly_sales ms\n),\n top_genre AS (\n  SELECT\n    e.EmployeeId AS RepId,\n    strftime('%Y-%m', i.InvoiceDate) AS Month,\n    g.Name AS GenreName,\n    SUM(il.UnitPrice * il.Quantity) AS GenreRevenue\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  GROUP BY RepId, Month, GenreName\n),\n top_genre_per_month AS (\n  SELECT\n    tg.RepId,\n    tg.Month,\n    tg.GenreName,\n    tg.GenreRevenue,\n    ROW_NUMBER() OVER (PARTITION BY tg.RepId, tg.Month ORDER BY tg.GenreRevenue DESC) AS rn\n  FROM top_genre tg\n),\n manager AS (\n  SELECT\n    e.EmployeeId AS RepId,\n    m.FirstName || ' ' || m.LastName AS ManagerName\n  FROM Employee e\n  LEFT JOIN Employee m ON e.ReportsTo = m.EmployeeId\n),\n latest_month AS (\n  SELECT MAX(Month) AS LatestMonth FROM monthly_sales\n),\n rep_latest_change AS (\n  SELECT\n    mc.RepName,\n    mc.MoMChange\n  FROM monthly_change mc\n  JOIN latest_month lm ON mc.Month = lm.LatestMonth\n)\nSELECT\n  mc.RepName,\n  mc.Month,\n  mc.MoMChange,\n  tgm.GenreName AS TopGenre,\n  mgr.ManagerName,\n  0 AS IsLargestIncrease\nFROM monthly_change mc\nLEFT JOIN top_genre_per_month tgm\n  ON mc.RepId = tgm.RepId AND mc.Month = tgm.Month AND tgm.rn = 1\nLEFT JOIN manager mgr\n  ON mc.RepId = mgr.RepId\nUNION ALL\nSELECT\n  rep_latest_change.RepName,\n  NULL AS Month,\n  rep_latest_change.MoMChange,\n  NULL AS TopGenre,\n  NULL AS ManagerName,\n  1 AS IsLargestIncrease\nFROM rep_latest_change\nORDER BY RepName, Month;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "0742c8c24f9a6d0d17030d14c7c1e9ce",
          "output": [
            {
              "question": "For customers who have never spent more than $100 on a single invoice in the past year, list each track they purchased and provide the total revenue, the average revenue per purchase, the maximum revenue from a single sale, and the total number of times that track was bought.",
              "sql": "WITH eligible_customers AS (\n  SELECT c.CustomerId\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY c.CustomerId\n  HAVING MAX(i.Total) <= 100\n)\nSELECT\n  t.TrackId,\n  t.Name AS TrackName,\n  SUM(il.UnitPrice * il.Quantity) AS TotalRevenue,\n  AVG(il.UnitPrice * il.Quantity) AS AvgRevenuePerPurchase,\n  MAX(il.UnitPrice * il.Quantity) AS MaxRevenueFromSingleSale,\n  COUNT(*) AS TotalTimesBought\nFROM InvoiceLine il\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nWHERE i.CustomerId IN (SELECT CustomerId FROM eligible_customers)\n  AND i.InvoiceDate >= date('now', '-1 year')\nGROUP BY t.TrackId, t.Name\nORDER BY t.TrackId;",
              "success": true
            },
            {
              "question": "Which tracks were bought by customers who have never had an invoice total over $100 in the last year, and for those tracks, what is the total revenue generated, but only if the track’s unit price is above $0.99, the track belongs to the \"Rock\" genre, the invoice was issued in the last 18 months, and the customer resides in the United States?",
              "sql": "SELECT t.TrackId, t.Name, SUM(il.UnitPrice * il.Quantity) AS total_revenue\nFROM Customer c\nJOIN Invoice i ON i.CustomerId = c.CustomerId\nJOIN InvoiceLine il ON il.InvoiceId = i.InvoiceId\nJOIN Track t ON t.TrackId = il.TrackId\nJOIN Genre g ON g.GenreId = t.GenreId\nWHERE c.Country = 'United States'\n  AND i.InvoiceDate >= date('now', '-18 months')\n  AND t.UnitPrice > 0.99\n  AND g.Name = 'Rock'\n  AND NOT EXISTS (\n      SELECT 1\n      FROM Invoice i2\n      WHERE i2.CustomerId = c.CustomerId\n        AND i2.InvoiceDate >= date('now', '-1 year')\n        AND i2.Total > 100\n  )\nGROUP BY t.TrackId, t.Name\nORDER BY total_revenue DESC;",
              "success": true
            },
            {
              "question": "Which tracks were purchased by customers who have never had an invoice total over $100 in the last year, and for each track, what is the total revenue generated, along with the artist name, album title, and the support representative’s name for those customers?",
              "sql": "SELECT\n  t.Name AS TrackName,\n  a.Title AS AlbumTitle,\n  ar.Name AS ArtistName,\n  e.FirstName || ' ' || e.LastName AS SupportRepName,\n  SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM\n  InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album a ON t.AlbumId = a.AlbumId\n  JOIN Artist ar ON a.ArtistId = ar.ArtistId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\nWHERE\n  NOT EXISTS (\n    SELECT 1\n    FROM Invoice i2\n    WHERE i2.CustomerId = c.CustomerId\n      AND i2.InvoiceDate >= date('now', '-1 year')\n      AND i2.Total > 100\n  )\nGROUP BY\n  t.TrackId,\n  e.EmployeeId\nORDER BY\n  TotalRevenue DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "ed517d4802a0bbc56375fb272eb774d8",
          "output": [
            {
              "question": "Over the last six months, identify each support representative who processed more invoices per month than the overall average across all representatives. For those representatives, report the total number of invoices they handled, the average invoice total, the lowest and highest invoice totals, and the month‑by‑month count of invoices and average totals. Compare each representative’s average invoice total to the overall average invoice total for the period.",
              "sql": "WITH invoice_data AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total,\n         c.SupportRepId\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  WHERE i.InvoiceDate >= date('now', '-6 months')\n),\nrep_monthly AS (\n  SELECT SupportRepId,\n         strftime('%Y-%m', InvoiceDate) AS month,\n         COUNT(*) AS invoice_count,\n         AVG(Total) AS avg_total\n  FROM invoice_data\n  GROUP BY SupportRepId, month\n),\nrep_stats AS (\n  SELECT SupportRepId,\n         SUM(invoice_count) AS total_invoices,\n         AVG(avg_total) AS avg_invoice_total,\n         MIN(avg_total) AS min_invoice_total,\n         MAX(avg_total) AS max_invoice_total,\n         SUM(invoice_count) / 6.0 AS avg_invoices_per_month\n  FROM rep_monthly\n  GROUP BY SupportRepId\n),\noverall AS (\n  SELECT\n    COUNT(*) / 6.0 AS overall_avg_invoices_per_month,\n    AVG(Total) AS overall_avg_invoice_total\n  FROM invoice_data\n),\nrep_filtered AS (\n  SELECT r.SupportRepId,\n         r.total_invoices,\n         r.avg_invoice_total,\n         r.min_invoice_total,\n         r.max_invoice_total,\n         r.avg_invoices_per_month,\n         o.overall_avg_invoices_per_month,\n         o.overall_avg_invoice_total\n  FROM rep_stats r\n  JOIN overall o\n  WHERE r.avg_invoices_per_month > o.overall_avg_invoices_per_month\n)\nSELECT\n  e.EmployeeId AS SupportRepId,\n  e.FirstName || ' ' || e.LastName AS SupportRepName,\n  rf.total_invoices,\n  rf.avg_invoice_total,\n  rf.min_invoice_total,\n  rf.max_invoice_total,\n  rf.avg_invoices_per_month,\n  rf.overall_avg_invoices_per_month,\n  rf.overall_avg_invoice_total,\n  (SELECT json_group_array(\n      json_object(\n        'month', month,\n        'invoice_count', invoice_count,\n        'avg_total', avg_total\n      )\n    )\n   FROM rep_monthly rm\n   WHERE rm.SupportRepId = rf.SupportRepId\n  ) AS month_breakdown\nFROM rep_filtered rf\nJOIN Employee e ON rf.SupportRepId = e.EmployeeId;",
              "success": true
            },
            {
              "question": "Which support representatives, whose title is \"Sales Representative\" and who are assigned to customers located in the United States, handled more invoices per month than the average across all representatives in the last six months, and whose average invoice total exceeds $100, how does their average invoice total compare to the overall average invoice total for all invoices in that period?",
              "sql": "WITH rep_invoices AS (\n    SELECT\n        e.EmployeeId,\n        e.FirstName || ' ' || e.LastName AS RepName,\n        COUNT(i.InvoiceId) AS InvoiceCount,\n        SUM(i.Total) AS TotalSum\n    FROM Employee e\n    JOIN Customer c ON c.SupportRepId = e.EmployeeId\n    JOIN Invoice i ON i.CustomerId = c.CustomerId\n    WHERE e.Title = 'Sales Representative'\n      AND c.Country = 'United States'\n      AND i.InvoiceDate >= date('now', '-6 months')\n    GROUP BY e.EmployeeId\n),\noverall AS (\n    SELECT\n        COUNT(i.InvoiceId) AS TotalInvoices,\n        SUM(i.Total) AS TotalSum\n    FROM Invoice i\n    WHERE i.InvoiceDate >= date('now', '-6 months')\n),\nrep_avg AS (\n    SELECT\n        r.EmployeeId,\n        r.RepName,\n        r.InvoiceCount,\n        r.TotalSum,\n        r.InvoiceCount / 6.0 AS AvgInvoicesPerMonth,\n        r.TotalSum / r.InvoiceCount AS AvgInvoiceTotal\n    FROM rep_invoices r\n),\noverall_stats AS (\n    SELECT\n        o.TotalInvoices,\n        o.TotalSum,\n        o.TotalInvoices / (SELECT COUNT(*) FROM Employee WHERE Title = 'Sales Representative') / 6.0 AS AvgInvoicesPerMonth,\n        o.TotalSum / o.TotalInvoices AS AvgInvoiceTotal\n    FROM overall o\n)\nSELECT\n    ra.RepName,\n    ra.AvgInvoiceTotal,\n    os.AvgInvoiceTotal AS OverallAvgInvoiceTotal,\n    ra.AvgInvoiceTotal - os.AvgInvoiceTotal AS Difference\nFROM rep_avg ra\nCROSS JOIN overall_stats os\nWHERE ra.AvgInvoicesPerMonth > os.AvgInvoicesPerMonth\n  AND ra.AvgInvoiceTotal > 100;",
              "success": true
            },
            {
              "question": "For the last six months, list each support representative who processed more invoices per month than the overall average, and for each, show how their average invoice total compares to the overall average, along with the average number of tracks per invoice they handled and the average number of distinct customers they support.",
              "sql": "WITH invoices_last6 AS (\n  SELECT InvoiceId, CustomerId, InvoiceDate, Total\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-6 months')\n),\ninvoice_tracks AS (\n  SELECT InvoiceId, COUNT(*) AS track_count\n  FROM InvoiceLine\n  GROUP BY InvoiceId\n),\nrep_invoice_stats AS (\n  SELECT\n    e.EmployeeId AS RepId,\n    e.FirstName || ' ' || e.LastName AS RepName,\n    COUNT(i.InvoiceId) AS invoice_count,\n    AVG(i.Total) AS avg_invoice_total,\n    AVG(it.track_count) AS avg_tracks_per_invoice\n  FROM invoices_last6 i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  LEFT JOIN invoice_tracks it ON i.InvoiceId = it.InvoiceId\n  GROUP BY e.EmployeeId, e.FirstName, e.LastName\n),\nrep_customer_counts AS (\n  SELECT\n    SupportRepId AS RepId,\n    COUNT(DISTINCT CustomerId) AS distinct_customer_count\n  FROM Customer\n  GROUP BY SupportRepId\n),\noverall_stats AS (\n  SELECT\n    COUNT(*) AS total_invoices,\n    AVG(Total) AS overall_avg_invoice_total\n  FROM invoices_last6\n),\noverall_avg_invoices_per_month AS (\n  SELECT\n    total_invoices / 6.0 AS overall_avg_invoices_per_month,\n    overall_avg_invoice_total\n  FROM overall_stats\n)\nSELECT\n  r.RepId,\n  r.RepName,\n  r.invoice_count / 6.0 AS avg_invoices_per_month,\n  oai.overall_avg_invoices_per_month,\n  r.avg_invoice_total,\n  oai.overall_avg_invoice_total,\n  r.avg_tracks_per_invoice,\n  rc.distinct_customer_count\nFROM rep_invoice_stats r\nJOIN overall_avg_invoices_per_month oai ON 1=1\nLEFT JOIN rep_customer_counts rc ON r.RepId = rc.RepId\nWHERE (r.invoice_count / 6.0) > oai.overall_avg_invoices_per_month;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "c560603ea3aba2c8416ee47c30414660",
          "output": [
            {
              "question": "Rank customers in each state by their total invoice amount for the current year, showing the top 5 in each state and the margin between each customer's total and the top spender in that state. Additionally, for each state, provide the average number of invoices per customer and the average invoice total across all customers in that state.",
              "sql": "WITH customer_totals AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    c.State,\n    SUM(i.Total) AS TotalAmount,\n    COUNT(i.InvoiceId) AS InvoiceCount\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now')\n  GROUP BY c.CustomerId, c.FirstName, c.LastName, c.State\n),\nstate_metrics AS (\n  SELECT\n    State,\n    COUNT(DISTINCT CustomerId) AS NumCustomers,\n    SUM(InvoiceCount) AS TotalInvoices,\n    SUM(TotalAmount) AS TotalAmountState\n  FROM customer_totals\n  GROUP BY State\n),\nranked AS (\n  SELECT\n    ct.*,\n    ROW_NUMBER() OVER (PARTITION BY ct.State ORDER BY ct.TotalAmount DESC) AS Rank,\n    MAX(ct.TotalAmount) OVER (PARTITION BY ct.State) AS TopTotal\n  FROM customer_totals ct\n)\nSELECT\n  r.State,\n  r.CustomerId,\n  r.FirstName,\n  r.LastName,\n  r.TotalAmount,\n  r.Rank,\n  (r.TopTotal - r.TotalAmount) AS Margin,\n  sm.NumCustomers,\n  sm.TotalInvoices,\n  sm.TotalAmountState,\n  sm.TotalInvoices * 1.0 / sm.NumCustomers AS AvgInvoicesPerCustomer,\n  sm.TotalAmountState * 1.0 / sm.TotalInvoices AS AvgInvoiceTotal\nFROM ranked r\nJOIN state_metrics sm ON r.State = sm.State\nWHERE r.Rank <= 5\nORDER BY r.State, r.Rank;",
              "success": true
            },
            {
              "question": "Rank customers in each state by their total invoice amount for the current year, showing the top 5 in each state and the margin between each customer's total and the top spender in that state, but only for states where the combined invoice total of all customers in that state exceeds $50,000, and only include customers who have placed at least 3 invoices during the current year.",
              "sql": "WITH customer_totals AS (\n  SELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    c.State,\n    SUM(i.Total) AS total,\n    COUNT(*) AS invoice_count\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now')\n  GROUP BY c.CustomerId, c.FirstName, c.LastName, c.State\n),\nstate_totals AS (\n  SELECT\n    State,\n    SUM(total) AS state_total,\n    MAX(total) AS top_total\n  FROM customer_totals\n  GROUP BY State\n),\nranked AS (\n  SELECT\n    ct.State,\n    ct.CustomerId,\n    ct.FirstName,\n    ct.LastName,\n    ct.total,\n    st.top_total,\n    ROW_NUMBER() OVER (PARTITION BY ct.State ORDER BY ct.total DESC) AS rank\n  FROM customer_totals ct\n  JOIN state_totals st ON ct.State = st.State\n  WHERE ct.invoice_count >= 3\n    AND st.state_total > 50000\n)\nSELECT\n  State,\n  CustomerId,\n  FirstName,\n  LastName,\n  total,\n  rank,\n  (top_total - total) AS margin\nFROM ranked\nWHERE rank <= 5\nORDER BY State, rank;",
              "success": true
            },
            {
              "question": "For each state, list the top five customers for the current year ranked by their total invoice amount. For every customer, include the name and title of their support representative, the count of distinct tracks they purchased during that year, and the difference between their total and the highest total in that state.",
              "sql": "WITH customer_stats AS (\n  SELECT\n    c.CustomerId,\n    c.State,\n    c.FirstName || ' ' || c.LastName AS CustomerName,\n    e.FirstName || ' ' || e.LastName AS RepName,\n    e.Title AS RepTitle,\n    SUM(i.Total) AS TotalAmount,\n    COUNT(DISTINCT il.TrackId) AS DistinctTracks\n  FROM Customer c\n  JOIN Invoice i ON i.CustomerId = c.CustomerId\n  JOIN InvoiceLine il ON il.InvoiceId = i.InvoiceId\n  JOIN Employee e ON e.EmployeeId = c.SupportRepId\n  WHERE strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now')\n  GROUP BY c.CustomerId, c.State, c.FirstName, c.LastName, e.FirstName, e.LastName, e.Title\n),\nranked AS (\n  SELECT\n    cs.*,\n    MAX(TotalAmount) OVER (PARTITION BY State) AS MaxStateTotal,\n    ROW_NUMBER() OVER (PARTITION BY State ORDER BY TotalAmount DESC) AS rn\n  FROM customer_stats cs\n)\nSELECT\n  State,\n  CustomerName,\n  RepName,\n  RepTitle,\n  TotalAmount,\n  DistinctTracks,\n  TotalAmount - MaxStateTotal AS Difference\nFROM ranked\nWHERE rn <= 5\nORDER BY State, TotalAmount DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "d2805d2c5a30e617c1fe7d2c239f685e",
          "output": [
            {
              "question": "For each customer, calculate the cumulative invoice total over time. For each month, report the total number of invoices, the average invoice amount, and the highest invoice amount, and indicate the month when the cumulative total first surpasses $5,000.",
              "sql": "WITH monthly AS (\n  SELECT\n    i.CustomerId,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    COUNT(*) AS invoice_count,\n    AVG(i.Total) AS avg_invoice,\n    MAX(i.Total) AS max_invoice,\n    SUM(i.Total) OVER (PARTITION BY i.CustomerId ORDER BY strftime('%Y-%m', i.InvoiceDate) ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumulative_total\n  FROM Invoice i\n  GROUP BY i.CustomerId, month\n)\nSELECT\n  CustomerId,\n  month,\n  invoice_count,\n  avg_invoice,\n  max_invoice,\n  cumulative_total,\n  MIN(CASE WHEN cumulative_total > 5000 THEN month END) OVER (PARTITION BY CustomerId) AS first_over_5000_month\nFROM monthly\nORDER BY CustomerId, month;",
              "success": true
            },
            {
              "question": "Show the running total of invoice totals for each customer over time, for customers whose company name contains \"Music\" and who have made at least 15 invoices in the last 24 months, and highlight any points where the running total crosses $5,000.",
              "sql": "WITH recent_counts AS (\n  SELECT CustomerId\n  FROM Invoice\n  WHERE InvoiceDate >= date('now', '-24 months')\n  GROUP BY CustomerId\n  HAVING COUNT(*) >= 15\n),\nfiltered_customers AS (\n  SELECT c.CustomerId, c.FirstName, c.LastName, c.Company\n  FROM Customer c\n  JOIN recent_counts rc ON c.CustomerId = rc.CustomerId\n  WHERE c.Company LIKE '%Music%'\n),\ninv AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total,\n         c.FirstName, c.LastName, c.Company\n  FROM Invoice i\n  JOIN filtered_customers c ON i.CustomerId = c.CustomerId\n),\nrunning AS (\n  SELECT\n    InvoiceId,\n    CustomerId,\n    FirstName,\n    LastName,\n    Company,\n    InvoiceDate,\n    Total,\n    SUM(Total) OVER (PARTITION BY CustomerId ORDER BY InvoiceDate\n                     ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total\n  FROM inv\n)\nSELECT\n  InvoiceId,\n  CustomerId,\n  FirstName,\n  LastName,\n  Company,\n  InvoiceDate,\n  Total,\n  running_total,\n  CASE\n    WHEN running_total > 5000\n     AND COALESCE(LAG(running_total) OVER (PARTITION BY CustomerId ORDER BY InvoiceDate), 0) <= 5000\n    THEN 1 ELSE 0\n  END AS crossed_5000\nFROM running\nORDER BY CustomerId, InvoiceDate;",
              "success": true
            },
            {
              "question": "For each customer, list the running total of all invoice amounts over time, along with the name of the support representative assigned to that customer and the total number of distinct artists whose tracks they have purchased up to each invoice date, and indicate any invoice where the running total first exceeds $5,000.",
              "sql": "WITH InvoiceWithRep AS (\n  SELECT i.InvoiceId,\n         i.CustomerId,\n         i.InvoiceDate,\n         i.Total,\n         e.FirstName || ' ' || e.LastName AS SupportRepName\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n),\nRunningTotals AS (\n  SELECT iw.*,\n         SUM(iw.Total) OVER (PARTITION BY iw.CustomerId ORDER BY iw.InvoiceDate, iw.InvoiceId) AS RunningTotal\n  FROM InvoiceWithRep iw\n),\nArtistCounts AS (\n  SELECT rt.CustomerId,\n         rt.InvoiceId,\n         rt.InvoiceDate,\n         rt.Total,\n         rt.RunningTotal,\n         rt.SupportRepName,\n         (SELECT COUNT(DISTINCT a.ArtistId)\n          FROM Invoice i2\n          JOIN InvoiceLine il2 ON i2.InvoiceId = il2.InvoiceId\n          JOIN Track t2 ON il2.TrackId = t2.TrackId\n          JOIN Album a ON t2.AlbumId = a.AlbumId\n          WHERE i2.CustomerId = rt.CustomerId\n            AND i2.InvoiceDate <= rt.InvoiceDate) AS DistinctArtistCount,\n         LAG(rt.RunningTotal) OVER (PARTITION BY rt.CustomerId ORDER BY rt.InvoiceDate, rt.InvoiceId) AS PrevRunningTotal\n  FROM RunningTotals rt\n)\nSELECT ac.CustomerId,\n       ac.InvoiceId,\n       ac.InvoiceDate,\n       ac.Total,\n       ac.RunningTotal,\n       ac.SupportRepName,\n       ac.DistinctArtistCount,\n       CASE WHEN ac.RunningTotal > 5000\n                 AND (ac.PrevRunningTotal IS NULL OR ac.PrevRunningTotal <= 5000)\n            THEN 'Yes' ELSE 'No' END AS FirstExceeds5000\nFROM ArtistCounts ac\nORDER BY ac.CustomerId, ac.InvoiceDate, ac.InvoiceId;",
              "success": false
            }
          ]
        },
        {
          "inputHash": "1f630f3ea1c1eb27e91ca1f81c815429",
          "output": [
            {
              "question": "For each customer, identify their most recent invoice and report the invoice date, the number of tracks purchased on that invoice, the average unit price of those tracks, and the support representative’s name. Additionally, compute the total amount the customer has spent across all invoices, the total number of tracks purchased in all invoices, and the overall average unit price of tracks across all invoices. Order the results by the most recent invoice date in descending order.",
              "sql": "WITH recent AS (\n  SELECT i.InvoiceId,\n         i.CustomerId,\n         i.InvoiceDate,\n         ROW_NUMBER() OVER (PARTITION BY i.CustomerId ORDER BY i.InvoiceDate DESC) AS rn\n  FROM Invoice i\n),\nrecent_invoice AS (\n  SELECT r.CustomerId,\n         r.InvoiceDate,\n         SUM(il.Quantity) AS TracksOnInvoice,\n         AVG(il.UnitPrice) AS AvgUnitPriceOnInvoice\n  FROM recent r\n  JOIN InvoiceLine il ON r.InvoiceId = il.InvoiceId\n  WHERE r.rn = 1\n  GROUP BY r.CustomerId, r.InvoiceDate\n),\nall_totals AS (\n  SELECT i.CustomerId,\n         SUM(i.Total) AS TotalSpent,\n         SUM(il.Quantity) AS TotalTracks,\n         SUM(il.UnitPrice * il.Quantity) / NULLIF(SUM(il.Quantity),0) AS AvgUnitPriceAll\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  GROUP BY i.CustomerId\n)\nSELECT c.CustomerId,\n       r.InvoiceDate,\n       r.TracksOnInvoice,\n       r.AvgUnitPriceOnInvoice,\n       e.FirstName || ' ' || e.LastName AS SupportRepName,\n       t.TotalSpent,\n       t.TotalTracks,\n       t.AvgUnitPriceAll\nFROM Customer c\nLEFT JOIN recent_invoice r ON c.CustomerId = r.CustomerId\nLEFT JOIN all_totals t ON c.CustomerId = t.CustomerId\nLEFT JOIN Employee e ON c.SupportRepId = e.EmployeeId\nORDER BY r.InvoiceDate DESC;",
              "success": false
            },
            {
              "question": "For each customer who has spent more than $200 in their most recent invoice, list that invoice along with the number of tracks purchased, the average unit price of those tracks, and the name of their support representative, but only include invoices dated within the last 365 days, and order the results by invoice date descending.",
              "sql": "WITH recent_invoices AS (\n    SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total, c.SupportRepId\n    FROM Invoice i\n    JOIN Customer c ON i.CustomerId = c.CustomerId\n    WHERE i.InvoiceDate >= date('now', '-365 days')\n),\nlatest_per_customer AS (\n    SELECT ri.*, ROW_NUMBER() OVER (PARTITION BY ri.CustomerId ORDER BY ri.InvoiceDate DESC) AS rn\n    FROM recent_invoices ri\n)\nSELECT\n    l.CustomerId,\n    l.InvoiceId,\n    l.InvoiceDate,\n    l.Total,\n    SUM(il.Quantity) AS num_tracks,\n    AVG(il.UnitPrice) AS avg_unit_price,\n    e.FirstName || ' ' || e.LastName AS support_rep\nFROM latest_per_customer l\nJOIN InvoiceLine il ON il.InvoiceId = l.InvoiceId\nJOIN Employee e ON e.EmployeeId = l.SupportRepId\nWHERE l.rn = 1\n  AND l.Total > 200\nGROUP BY l.CustomerId, l.InvoiceId, l.InvoiceDate, l.Total, support_rep\nORDER BY l.InvoiceDate DESC;",
              "success": true
            },
            {
              "question": "For each customer, list their most recent invoice, the total amount, the number of tracks purchased, the average unit price of those tracks, the support representative's full name and title, the number of distinct artists whose tracks appear on that invoice, and the set of genres represented, ordered by the invoice date descending.",
              "sql": "WITH recent_invoices AS (\n  SELECT i.*,\n         ROW_NUMBER() OVER (PARTITION BY i.CustomerId ORDER BY i.InvoiceDate DESC) AS rn\n  FROM Invoice i\n)\nSELECT\n  c.CustomerId,\n  c.FirstName || ' ' || c.LastName AS CustomerName,\n  ri.InvoiceId,\n  ri.InvoiceDate,\n  ri.Total,\n  SUM(il.Quantity) AS TrackCount,\n  AVG(il.UnitPrice) AS AvgUnitPrice,\n  e.FirstName || ' ' || e.LastName AS SupportRepFullName,\n  e.Title AS SupportRepTitle,\n  COUNT(DISTINCT a.ArtistId) AS ArtistCount,\n  (SELECT GROUP_CONCAT(sub.Name)\n   FROM (\n     SELECT DISTINCT g.Name AS Name\n     FROM InvoiceLine il2\n     JOIN Track t2 ON t2.TrackId = il2.TrackId\n     LEFT JOIN Genre g ON g.GenreId = t2.GenreId\n     WHERE il2.InvoiceId = ri.InvoiceId\n   ) AS sub\n  ) AS Genres\nFROM recent_invoices ri\nJOIN Customer c ON c.CustomerId = ri.CustomerId\nJOIN InvoiceLine il ON il.InvoiceId = ri.InvoiceId\nJOIN Track t ON t.TrackId = il.TrackId\nJOIN Album al ON al.AlbumId = t.AlbumId\nJOIN Artist a ON a.ArtistId = al.ArtistId\nJOIN Employee e ON e.EmployeeId = c.SupportRepId\nWHERE ri.rn = 1\nGROUP BY\n  c.CustomerId,\n  c.FirstName,\n  c.LastName,\n  ri.InvoiceId,\n  ri.InvoiceDate,\n  ri.Total,\n  e.FirstName,\n  e.LastName,\n  e.Title\nORDER BY ri.InvoiceDate DESC;",
              "success": false
            }
          ]
        },
        {
          "inputHash": "714cf7472941cfb190662cacab86bb8c",
          "output": [
            {
              "question": "For each customer who has purchased tracks from a genre whose average unit price exceeds the overall average, list the total number of qualifying invoices in the last 60 days, the total amount spent on those invoices, and the average number of days since each invoice.",
              "sql": "WITH overall_avg AS (\n  SELECT AVG(UnitPrice) AS avg_price FROM Track\n),\nqualifying_genres AS (\n  SELECT GenreId\n  FROM Track\n  GROUP BY GenreId\n  HAVING AVG(UnitPrice) > (SELECT avg_price FROM overall_avg)\n),\nqualifying_invoices AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total\n  FROM Invoice i\n  WHERE i.InvoiceDate >= date('now', '-60 days')\n    AND EXISTS (\n      SELECT 1\n      FROM InvoiceLine il\n      JOIN Track t ON il.TrackId = t.TrackId\n      WHERE il.InvoiceId = i.InvoiceId\n        AND t.GenreId IN (SELECT GenreId FROM qualifying_genres)\n    )\n)\nSELECT c.CustomerId,\n       c.FirstName,\n       c.LastName,\n       COUNT(DISTINCT qi.InvoiceId) AS invoice_count,\n       SUM(qi.Total) AS total_spent,\n       AVG(julianday('now') - julianday(qi.InvoiceDate)) AS avg_days_since\nFROM qualifying_invoices qi\nJOIN Customer c ON qi.CustomerId = c.CustomerId\nGROUP BY c.CustomerId, c.FirstName, c.LastName\nORDER BY c.CustomerId;",
              "success": true
            },
            {
              "question": "Identify customers who have had an invoice in the last 60 days that contains tracks from a genre whose average unit price is higher than the overall average, whose invoice total is greater than $50, and who have placed more than three invoices in the past year; for each such customer, calculate how many days have passed since their most recent qualifying invoice.",
              "sql": "WITH overall_avg AS (\n    SELECT AVG(UnitPrice) AS avg_price FROM Track\n),\nqualifying_genres AS (\n    SELECT GenreId\n    FROM Track\n    GROUP BY GenreId\n    HAVING AVG(UnitPrice) > (SELECT avg_price FROM overall_avg)\n),\nqualifying_invoices AS (\n    SELECT DISTINCT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total\n    FROM Invoice i\n    JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n    JOIN Track t ON il.TrackId = t.TrackId\n    WHERE t.GenreId IN (SELECT GenreId FROM qualifying_genres)\n      AND i.Total > 50\n      AND i.InvoiceDate >= date('now', '-60 days')\n),\ncustomer_invoice_counts AS (\n    SELECT CustomerId, COUNT(*) AS invoice_count\n    FROM Invoice\n    WHERE InvoiceDate >= date('now', '-365 days')\n    GROUP BY CustomerId\n    HAVING invoice_count > 3\n)\nSELECT\n    c.CustomerId,\n    c.FirstName,\n    c.LastName,\n    CAST(julianday('now') - julianday(MAX(q.InvoiceDate)) AS INTEGER) AS days_since_last_qualifying_invoice\nFROM Customer c\nJOIN qualifying_invoices q ON c.CustomerId = q.CustomerId\nJOIN customer_invoice_counts cc ON c.CustomerId = cc.CustomerId\nGROUP BY c.CustomerId, c.FirstName, c.LastName;",
              "success": true
            },
            {
              "question": "Find all customers who made a purchase within the last 60 days that included at least one track from a genre whose average price exceeds the overall average track price. For each such customer, report the number of days since that purchase, the name of the support representative assigned to them, the name of the artist who performed the most expensive track on that invoice, and the total count of distinct albums represented by the tracks on that invoice.",
              "sql": "WITH overall_avg AS (\n    SELECT avg(UnitPrice) AS avg_price FROM Track\n),\ngenre_above_avg AS (\n    SELECT GenreId\n    FROM Track\n    GROUP BY GenreId\n    HAVING avg(UnitPrice) > (SELECT avg_price FROM overall_avg)\n),\nqualifying_invoices AS (\n    SELECT DISTINCT i.InvoiceId\n    FROM Invoice i\n    JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n    JOIN Track t ON il.TrackId = t.TrackId\n    WHERE i.InvoiceDate >= date('now', '-60 days')\n      AND t.GenreId IN (SELECT GenreId FROM genre_above_avg)\n),\ninvoice_max_track AS (\n    SELECT *\n    FROM (\n        SELECT il.InvoiceId, t.TrackId, t.UnitPrice, t.AlbumId,\n               ROW_NUMBER() OVER (PARTITION BY il.InvoiceId ORDER BY t.UnitPrice DESC, t.TrackId ASC) AS rn\n        FROM InvoiceLine il\n        JOIN Track t ON il.TrackId = t.TrackId\n        WHERE il.InvoiceId IN (SELECT InvoiceId FROM qualifying_invoices)\n    )\n    WHERE rn = 1\n),\ninvoice_artist AS (\n    SELECT im.InvoiceId, a.Name AS artist_name\n    FROM invoice_max_track im\n    JOIN Album al ON im.AlbumId = al.AlbumId\n    JOIN Artist a ON al.ArtistId = a.ArtistId\n),\ninvoice_album_count AS (\n    SELECT i.InvoiceId, COUNT(DISTINCT t.AlbumId) AS album_count\n    FROM Invoice i\n    JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n    JOIN Track t ON il.TrackId = t.TrackId\n    WHERE i.InvoiceId IN (SELECT InvoiceId FROM qualifying_invoices)\n    GROUP BY i.InvoiceId\n)\nSELECT\n    i.InvoiceId,\n    CAST((julianday('now') - julianday(i.InvoiceDate)) AS INTEGER) AS days_since_purchase,\n    e.FirstName || ' ' || e.LastName AS support_rep_name,\n    ia.artist_name,\n    iac.album_count\nFROM Invoice i\nJOIN qualifying_invoices qi ON i.InvoiceId = qi.InvoiceId\nJOIN Customer c ON i.CustomerId = c.CustomerId\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nJOIN invoice_artist ia ON i.InvoiceId = ia.InvoiceId\nJOIN invoice_album_count iac ON i.InvoiceId = iac.InvoiceId\nORDER BY i.InvoiceDate DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "b383e9b9a7d51a107a5c0061c45e46c8",
          "output": [
            {
              "question": "How many customers are in each country, and what is the average total amount of invoices per customer in that country?",
              "sql": "SELECT\n  c.Country,\n  COUNT(DISTINCT c.CustomerId) AS num_customers,\n  COALESCE(SUM(i.Total), 0) / COUNT(DISTINCT c.CustomerId) AS avg_total_per_customer\nFROM Customer c\nLEFT JOIN Invoice i ON c.CustomerId = i.CustomerId\nGROUP BY c.Country;",
              "success": true
            },
            {
              "question": "How many customers in the database have made at least one purchase in the last 30 days?",
              "sql": "SELECT COUNT(DISTINCT CustomerId) AS CustomerCount\nFROM Invoice\nWHERE InvoiceDate >= date('now', '-30 days');",
              "success": true
            },
            {
              "question": "How many customers are assigned to each support representative, and what is the representative’s full name?",
              "sql": "SELECT e.FirstName || ' ' || e.LastName AS SupportRepName, COUNT(c.CustomerId) AS CustomerCount\nFROM Customer c\nJOIN Employee e ON c.SupportRepId = e.EmployeeId\nGROUP BY e.EmployeeId, e.FirstName, e.LastName\nORDER BY CustomerCount DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "99e04243a4c9114af4038f1e8195ac56",
          "output": [
            {
              "question": "What is the total number of artists represented in our catalog, and what is the average number of albums per artist?",
              "sql": "SELECT\n  (SELECT COUNT(*) FROM Artist) AS total_artists,\n  (SELECT AVG(album_count) FROM (\n    SELECT ArtistId, COUNT(*) AS album_count\n    FROM Album\n    GROUP BY ArtistId\n  )) AS avg_albums_per_artist;",
              "success": true
            },
            {
              "question": "How many artists have at least one album that contains more than 10 tracks?",
              "sql": "SELECT COUNT(DISTINCT a.ArtistId) AS ArtistCount\nFROM Album a\nJOIN Track t ON a.AlbumId = t.AlbumId\nGROUP BY a.AlbumId\nHAVING COUNT(t.TrackId) > 10;",
              "success": true
            },
            {
              "question": "How many artists have at least one album that contains more than ten tracks and have sold more than $5,000 in total across all invoices?",
              "sql": "WITH album_track_counts AS (\n    SELECT Album.ArtistId, Album.AlbumId, COUNT(*) AS track_count\n    FROM Album\n    JOIN Track ON Track.AlbumId = Album.AlbumId\n    GROUP BY Album.ArtistId, Album.AlbumId\n),\nartist_has_long_album AS (\n    SELECT DISTINCT ArtistId\n    FROM album_track_counts\n    WHERE track_count > 10\n),\nartist_sales AS (\n    SELECT Artist.ArtistId, SUM(InvoiceLine.UnitPrice * InvoiceLine.Quantity) AS total_sales\n    FROM Artist\n    JOIN Album ON Album.ArtistId = Artist.ArtistId\n    JOIN Track ON Track.AlbumId = Album.AlbumId\n    JOIN InvoiceLine ON InvoiceLine.TrackId = Track.TrackId\n    GROUP BY Artist.ArtistId\n)\nSELECT COUNT(*) AS artist_count\nFROM artist_has_long_album AS a\nJOIN artist_sales AS s ON a.ArtistId = s.ArtistId\nWHERE s.total_sales > 5000;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "d335b266a60a54b83f0e140162048e4d",
          "output": [
            {
              "question": "How many tracks are in each genre, and which genre has the most tracks?",
              "sql": "WITH GenreCounts AS (\n  SELECT g.GenreId, g.Name AS Genre, COUNT(t.TrackId) AS TrackCount\n  FROM Genre g\n  LEFT JOIN Track t ON g.GenreId = t.GenreId\n  GROUP BY g.GenreId, g.Name\n)\nSELECT gc.Genre,\n       gc.TrackCount,\n       CASE WHEN gc.TrackCount = (SELECT MAX(TrackCount) FROM GenreCounts) THEN 'Yes' ELSE 'No' END AS IsMax\nFROM GenreCounts gc\nORDER BY gc.TrackCount DESC;",
              "success": true
            },
            {
              "question": "What is the total number of tracks we have for the genre 'Rock'?",
              "sql": "SELECT COUNT(*) AS total_tracks\nFROM Track t\nJOIN Genre g ON t.GenreId = g.GenreId\nWHERE g.Name = 'Rock';",
              "success": true
            },
            {
              "question": "What is the total number of tracks we have, grouped by artist name and genre name?",
              "sql": "SELECT a.Name AS ArtistName,\n       g.Name AS GenreName,\n       COUNT(*) AS TrackCount\nFROM Track t\nJOIN Album al ON t.AlbumId = al.AlbumId\nJOIN Artist a ON al.ArtistId = a.ArtistId\nLEFT JOIN Genre g ON t.GenreId = g.GenreId\nGROUP BY a.Name, g.Name\nORDER BY a.Name, g.Name;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "d16a7d9556eec588c4dbc70f5561611f",
          "output": [
            {
              "question": "Which artist generated the highest total sales revenue across all invoices, and what is the average revenue per invoice for that artist compared to the overall average revenue per invoice across all artists?",
              "sql": "WITH ArtistRevenue AS (\n  SELECT a.ArtistId,\n         a.Name,\n         SUM(il.UnitPrice * il.Quantity) AS TotalRevenue,\n         COUNT(DISTINCT il.InvoiceId) AS InvoiceCount\n  FROM Artist a\n  JOIN Album al ON al.ArtistId = a.ArtistId\n  JOIN Track t ON t.AlbumId = al.AlbumId\n  JOIN InvoiceLine il ON il.TrackId = t.TrackId\n  GROUP BY a.ArtistId, a.Name\n),\nMaxArtist AS (\n  SELECT * FROM ArtistRevenue\n  WHERE TotalRevenue = (SELECT MAX(TotalRevenue) FROM ArtistRevenue)\n),\nOverallAvg AS (\n  SELECT AVG(Total) AS OverallAvgRevenuePerInvoice\n  FROM Invoice\n)\nSELECT ma.Name AS ArtistName,\n       ma.TotalRevenue,\n       ma.TotalRevenue / ma.InvoiceCount AS AvgRevenuePerInvoiceArtist,\n       oa.OverallAvgRevenuePerInvoice\nFROM MaxArtist ma\nCROSS JOIN OverallAvg oa;",
              "success": true
            },
            {
              "question": "Which artist has generated the highest total sales revenue across all invoices for tracks priced above $0.99, sold in the last 12 months, and belonging to the 'Rock' genre?",
              "sql": "SELECT a.Name AS ArtistName, SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\nFROM InvoiceLine il\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Album al ON t.AlbumId = al.AlbumId\nJOIN Artist a ON al.ArtistId = a.ArtistId\nJOIN Genre g ON t.GenreId = g.GenreId\nWHERE t.UnitPrice > 0.99\n  AND date(i.InvoiceDate) >= date('now', '-12 months')\n  AND g.Name = 'Rock'\nGROUP BY a.ArtistId, a.Name\nORDER BY TotalRevenue DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "Which artist has generated the highest total sales revenue across all invoices, and what are the total number of tracks sold and the average unit price per track for that artist, grouped by the country of the customers who purchased the tracks?",
              "sql": "SELECT a.Name AS artist_name,\n       c.Country,\n       SUM(il.Quantity) AS total_tracks_sold,\n       AVG(il.UnitPrice) AS avg_unit_price\nFROM Invoice i\nJOIN InvoiceLine il ON il.InvoiceId = i.InvoiceId\nJOIN Track t ON t.TrackId = il.TrackId\nJOIN Album al ON al.AlbumId = t.AlbumId\nJOIN Artist a ON a.ArtistId = al.ArtistId\nJOIN Customer c ON c.CustomerId = i.CustomerId\nWHERE a.ArtistId = (\n    SELECT a2.ArtistId\n    FROM Artist a2\n    JOIN Album al2 ON al2.ArtistId = a2.ArtistId\n    JOIN Track t2 ON t2.AlbumId = al2.AlbumId\n    JOIN InvoiceLine il2 ON il2.TrackId = t2.TrackId\n    GROUP BY a2.ArtistId\n    ORDER BY SUM(il2.UnitPrice * il2.Quantity) DESC\n    LIMIT 1\n)\nGROUP BY a.Name, c.Country\nORDER BY c.Country;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "57332397a3b5d644ba5adce3bb5014a3",
          "output": [
            {
              "question": "Which music genres generated the highest revenue, how many tracks were sold in each genre, what is the average unit price of tracks in that genre, and what percentage of total sales revenue does each genre represent, sorted by revenue descending?",
              "sql": "WITH total AS (\n  SELECT SUM(il.UnitPrice * il.Quantity) AS total_revenue\n  FROM InvoiceLine il\n)\nSELECT\n  COALESCE(g.Name, 'Unknown') AS Genre,\n  SUM(il.UnitPrice * il.Quantity) AS Revenue,\n  SUM(il.Quantity) AS TracksSold,\n  AVG(il.UnitPrice) AS AvgUnitPrice,\n  (SUM(il.UnitPrice * il.Quantity) / total.total_revenue) * 100 AS PercentRevenue\nFROM InvoiceLine il\nJOIN Track t ON il.TrackId = t.TrackId\nLEFT JOIN Genre g ON t.GenreId = g.GenreId\nCROSS JOIN total\nGROUP BY Genre\nORDER BY Revenue DESC;",
              "success": true
            },
            {
              "question": "How are sales distributed across different music genres, expressed as total revenue and percentage of overall sales, for invoices issued in the United States during the past year?",
              "sql": "WITH genre_sales AS (\n  SELECT g.Name AS Genre,\n         SUM(il.UnitPrice * il.Quantity) AS Revenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE i.BillingCountry = 'United States'\n    AND i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY g.Name\n),\ntotal AS (\n  SELECT SUM(Revenue) AS TotalRevenue FROM genre_sales\n)\nSELECT gs.Genre,\n       gs.Revenue,\n       ROUND((gs.Revenue / t.TotalRevenue) * 100, 2) AS Percentage\nFROM genre_sales gs\nCROSS JOIN total t\nORDER BY gs.Revenue DESC;",
              "success": true
            },
            {
              "question": "Show the total revenue and percentage of overall sales for each music genre, broken down by customer country, and list the artist whose tracks contributed the most revenue in each genre.",
              "sql": "WITH revenue AS (\n  SELECT\n    g.GenreId,\n    g.Name AS GenreName,\n    c.Country,\n    SUM(il.UnitPrice * il.Quantity) AS Revenue\n  FROM InvoiceLine il\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album a ON t.AlbumId = a.AlbumId\n  JOIN Artist ar ON a.ArtistId = ar.ArtistId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  GROUP BY g.GenreId, g.Name, c.Country\n),\ntotal_rev AS (\n  SELECT SUM(Revenue) AS TotalRevenue FROM revenue\n),\nartist_rev AS (\n  SELECT\n    g.GenreId,\n    ar.ArtistId,\n    ar.Name AS ArtistName,\n    SUM(il.UnitPrice * il.Quantity) AS ArtistRevenue\n  FROM InvoiceLine il\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album a ON t.AlbumId = a.AlbumId\n  JOIN Artist ar ON a.ArtistId = ar.ArtistId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY g.GenreId, ar.ArtistId, ar.Name\n),\ntop_artist AS (\n  SELECT\n    GenreId,\n    ArtistName,\n    ArtistRevenue,\n    ROW_NUMBER() OVER (PARTITION BY GenreId ORDER BY ArtistRevenue DESC) AS rn\n  FROM artist_rev\n)\nSELECT\n  r.GenreName,\n  r.Country,\n  r.Revenue AS TotalRevenue,\n  ROUND(r.Revenue / tr.TotalRevenue * 100, 2) AS PercentageOfOverallSales,\n  ta.ArtistName AS TopArtist\nFROM revenue r\nJOIN total_rev tr\nJOIN top_artist ta ON r.GenreId = ta.GenreId AND ta.rn = 1\nORDER BY r.GenreName, r.Country;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "3e0f52132b3dd69772e5a78f073989b5",
          "output": [
            {
              "question": "What is the total commission owed to each sales representative, the number of invoices they have processed, and the average invoice amount for those invoices, assuming they receive 10% of the total invoice value?",
              "sql": "SELECT\n    e.EmployeeId,\n    e.FirstName,\n    e.LastName,\n    ROUND(SUM(i.Total) * 0.10, 2) AS CommissionOwed,\n    COUNT(i.InvoiceId) AS InvoiceCount,\n    ROUND(AVG(i.Total), 2) AS AvgInvoiceAmount\nFROM\n    Employee e\nJOIN\n    Customer c ON c.SupportRepId = e.EmployeeId\nJOIN\n    Invoice i ON i.CustomerId = c.CustomerId\nGROUP BY\n    e.EmployeeId, e.FirstName, e.LastName\nORDER BY\n    CommissionOwed DESC;",
              "success": true
            },
            {
              "question": "What is the total commission owed to each sales representative if they receive 10% of the total invoices for the customers they support, but only for invoices dated in 2023 and for customers who have made at least three invoices?",
              "sql": "WITH customer_counts AS (\n  SELECT CustomerId\n  FROM Invoice\n  GROUP BY CustomerId\n  HAVING COUNT(*) >= 3\n)\nSELECT e.EmployeeId,\n       e.FirstName,\n       e.LastName,\n       SUM(i.Total) * 0.10 AS Commission\nFROM Employee e\nJOIN Customer c ON c.SupportRepId = e.EmployeeId\nJOIN Invoice i ON i.CustomerId = c.CustomerId\nJOIN customer_counts cc ON cc.CustomerId = c.CustomerId\nWHERE i.InvoiceDate >= '2023-01-01' AND i.InvoiceDate < '2024-01-01'\nGROUP BY e.EmployeeId, e.FirstName, e.LastName\nORDER BY Commission DESC;",
              "success": true
            },
            {
              "question": "Determine, for each sales representative, the total commission owed (10% of the combined invoice totals for the customers they support), the full name of their manager, and the total number of distinct tracks sold to those customers.",
              "sql": "SELECT\n  rep.FirstName || ' ' || rep.LastName AS SalesRepName,\n  COALESCE(mgr.FirstName || ' ' || mgr.LastName, 'No Manager') AS ManagerName,\n  ROUND(COALESCE(SUM(inv.Total),0) * 0.10, 2) AS CommissionOwed,\n  COUNT(DISTINCT il.TrackId) AS DistinctTrackCount\nFROM Employee rep\nLEFT JOIN Employee mgr ON rep.ReportsTo = mgr.EmployeeId\nLEFT JOIN Customer cust ON cust.SupportRepId = rep.EmployeeId\nLEFT JOIN Invoice inv ON inv.CustomerId = cust.CustomerId\nLEFT JOIN InvoiceLine il ON il.InvoiceId = inv.InvoiceId\nGROUP BY rep.EmployeeId, rep.FirstName, rep.LastName, mgr.FirstName, mgr.LastName;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "464e575c101e97cda45750bef75cd906",
          "output": [
            {
              "question": "For each artist, list the albums that sold more than 500 copies in the last 12 months, and provide the total units sold, the total revenue generated, and the average unit price across those sales.",
              "sql": "SELECT\n  ar.ArtistId,\n  ar.Name AS ArtistName,\n  al.AlbumId,\n  al.Title AS AlbumTitle,\n  SUM(il.Quantity) AS UnitsSold,\n  SUM(il.Quantity * il.UnitPrice) AS TotalRevenue,\n  SUM(il.Quantity * il.UnitPrice) / SUM(il.Quantity) AS AvgUnitPrice\nFROM\n  InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist ar ON al.ArtistId = ar.ArtistId\nWHERE\n  i.InvoiceDate >= date('now', '-12 months')\nGROUP BY\n  ar.ArtistId, ar.Name, al.AlbumId, al.Title\nHAVING\n  SUM(il.Quantity) > 500\nORDER BY\n  ar.Name,\n  al.Title;",
              "success": true
            },
            {
              "question": "Which albums sold more than 500 copies in the last 12 months, and what were the total units sold, for tracks in the 'Rock' genre sold to customers in the United States?",
              "sql": "SELECT a.Title, SUM(il.Quantity) AS TotalUnitsSold\nFROM Album a\nJOIN Track t ON t.AlbumId = a.AlbumId\nJOIN InvoiceLine il ON il.TrackId = t.TrackId\nJOIN Invoice i ON i.InvoiceId = il.InvoiceId\nJOIN Customer c ON c.CustomerId = i.CustomerId\nJOIN Genre g ON g.GenreId = t.GenreId\nWHERE g.Name = 'Rock'\n  AND c.Country = 'United States'\n  AND i.InvoiceDate >= date('now', '-12 months')\nGROUP BY a.AlbumId, a.Title\nHAVING SUM(il.Quantity) > 500;",
              "success": true
            },
            {
              "question": "Which albums sold more than 500 copies in the last 12 months, and what were the total units sold, along with the artist name, the number of distinct customers who purchased the album, and the average unit price of the tracks in that album?",
              "sql": "SELECT\n  a.Title,\n  ar.Name AS ArtistName,\n  SUM(il.Quantity) AS TotalUnitsSold,\n  COUNT(DISTINCT i.CustomerId) AS DistinctCustomers,\n  (SELECT AVG(UnitPrice) FROM Track t2 WHERE t2.AlbumId = a.AlbumId) AS AvgTrackPrice\nFROM Album a\nJOIN Artist ar ON a.ArtistId = ar.ArtistId\nJOIN Track t ON t.AlbumId = a.AlbumId\nJOIN InvoiceLine il ON il.TrackId = t.TrackId\nJOIN Invoice i ON i.InvoiceId = il.InvoiceId\nWHERE i.InvoiceDate >= date('now', '-12 months')\nGROUP BY a.AlbumId, a.Title, ar.Name\nHAVING SUM(il.Quantity) > 500\nORDER BY TotalUnitsSold DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "eb79d73bd63d9bb9b5ccb99988cd9880",
          "output": [
            {
              "question": "For the artist who earned the highest total invoice revenue in the most recent fiscal year, list each month’s total revenue, the number of invoices, the average invoice amount, and the total tracks sold, and compare each of these metrics to the same artist’s corresponding monthly figures in the prior fiscal year.",
              "sql": "WITH recent_year AS (\n  SELECT CAST(MAX(strftime('%Y', InvoiceDate)) AS INTEGER) AS year\n  FROM Invoice\n),\nartist_revenue AS (\n  SELECT a.ArtistId, a.Name,\n         SUM(il.UnitPrice * il.Quantity) AS revenue\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  JOIN recent_year ry ON CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) = ry.year\n  GROUP BY a.ArtistId, a.Name\n),\ntop_artist AS (\n  SELECT ArtistId, Name\n  FROM artist_revenue\n  ORDER BY revenue DESC\n  LIMIT 1\n),\nmetrics AS (\n  SELECT\n    CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) AS year,\n    strftime('%m', i.InvoiceDate) AS month,\n    SUM(il.UnitPrice * il.Quantity) AS total_revenue,\n    COUNT(DISTINCT i.InvoiceId) AS invoice_count,\n    SUM(il.Quantity) AS tracks_sold\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  JOIN top_artist ta ON a.ArtistId = ta.ArtistId\n  WHERE CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) IN (SELECT year FROM recent_year)\n     OR CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) = (SELECT year FROM recent_year) - 1\n  GROUP BY year, month\n),\nrecent_metrics AS (\n  SELECT month, total_revenue, invoice_count, tracks_sold\n  FROM metrics\n  WHERE year = (SELECT year FROM recent_year)\n),\nprior_metrics AS (\n  SELECT month, total_revenue AS prior_total_revenue, invoice_count AS prior_invoice_count, tracks_sold AS prior_tracks_sold\n  FROM metrics\n  WHERE year = (SELECT year FROM recent_year) - 1\n)\nSELECT\n  ta.Name AS artist_name,\n  r.month,\n  r.total_revenue AS recent_total_revenue,\n  r.invoice_count AS recent_invoice_count,\n  ROUND(r.total_revenue / NULLIF(r.invoice_count,0), 2) AS recent_avg_invoice,\n  r.tracks_sold AS recent_tracks_sold,\n  p.prior_total_revenue,\n  p.prior_invoice_count,\n  ROUND(p.prior_total_revenue / NULLIF(p.prior_invoice_count,0), 2) AS prior_avg_invoice,\n  p.prior_tracks_sold\nFROM recent_metrics r\nLEFT JOIN prior_metrics p ON r.month = p.month\nCROSS JOIN top_artist ta\nORDER BY r.month;",
              "success": true
            },
            {
              "question": "Which artist has generated the highest total revenue from invoices in the last fiscal year, broken down by month, for customers located in the United States who have made at least five purchases, considering only tracks in the 'Rock' genre, and how does that compare to the previous year's monthly totals for the same customer segment?",
              "sql": "WITH params AS (\n    SELECT strftime('%Y', date('now', '-1 year')) AS year_last,\n           strftime('%Y', date('now', '-2 year')) AS year_prev\n),\nus_customers AS (\n    SELECT CustomerId\n    FROM Customer\n    WHERE Country = 'United States'\n),\ncustomer_invoice_counts AS (\n    SELECT i.CustomerId\n    FROM Invoice i\n    JOIN us_customers c ON i.CustomerId = c.CustomerId\n    GROUP BY i.CustomerId\n    HAVING COUNT(*) >= 5\n),\nfiltered_invoices AS (\n    SELECT i.InvoiceId, i.InvoiceDate, i.CustomerId\n    FROM Invoice i\n    JOIN customer_invoice_counts c ON i.CustomerId = c.CustomerId\n),\nrock_tracks AS (\n    SELECT t.TrackId, t.AlbumId\n    FROM Track t\n    JOIN Genre g ON t.GenreId = g.GenreId\n    WHERE g.Name = 'Rock'\n),\ninvoice_line_details AS (\n    SELECT il.InvoiceId,\n           il.TrackId,\n           il.UnitPrice,\n           il.Quantity,\n           t.AlbumId,\n           a.ArtistId,\n           ar.Name AS ArtistName,\n           strftime('%Y', fi.InvoiceDate) AS year,\n           strftime('%m', fi.InvoiceDate) AS month,\n           il.UnitPrice * il.Quantity AS revenue\n    FROM InvoiceLine il\n    JOIN filtered_invoices fi ON il.InvoiceId = fi.InvoiceId\n    JOIN rock_tracks rt ON il.TrackId = rt.TrackId\n    JOIN Track t ON il.TrackId = t.TrackId\n    JOIN Album a ON t.AlbumId = a.AlbumId\n    JOIN Artist ar ON a.ArtistId = ar.ArtistId\n),\nartist_year_month_revenue AS (\n    SELECT ArtistId,\n           ArtistName,\n           year,\n           month,\n           SUM(revenue) AS revenue\n    FROM invoice_line_details\n    GROUP BY ArtistId, ArtistName, year, month\n),\ntop_artist AS (\n    SELECT ArtistId, ArtistName\n    FROM artist_year_month_revenue\n    WHERE year = (SELECT year_last FROM params)\n    GROUP BY ArtistId, ArtistName\n    ORDER BY SUM(revenue) DESC\n    LIMIT 1\n)\nSELECT t.ArtistName,\n       r.year,\n       r.month,\n       MAX(CASE WHEN r.year = (SELECT year_last FROM params) THEN r.revenue END) AS revenue_last_year,\n       MAX(CASE WHEN r.year = (SELECT year_prev FROM params) THEN r.revenue END) AS revenue_prev_year\nFROM artist_year_month_revenue r\nJOIN top_artist t ON r.ArtistId = t.ArtistId\nGROUP BY r.year, r.month, t.ArtistName\nORDER BY r.year, r.month;",
              "success": false
            },
            {
              "question": "Which artist has generated the highest total revenue from invoices in the last fiscal year, broken down by month, compared to the previous year’s monthly totals, and for each month also list the country of the customer who made the most purchases and the name of the support employee who handled those invoices?",
              "sql": "WITH\n    last_year_cte AS (\n        SELECT MAX(strftime('%Y', InvoiceDate)) AS last_year\n        FROM Invoice\n    ),\n    revenue_cte AS (\n        SELECT\n            strftime('%Y', i.InvoiceDate) AS year,\n            strftime('%m', i.InvoiceDate) AS month,\n            a.ArtistId,\n            SUM(il.UnitPrice * il.Quantity) AS revenue\n        FROM Invoice i\n        JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n        JOIN Track t ON il.TrackId = t.TrackId\n        JOIN Album a ON t.AlbumId = a.AlbumId\n        GROUP BY year, month, a.ArtistId\n    ),\n    artist_totals AS (\n        SELECT\n            r.ArtistId,\n            a.Name AS artist_name,\n            SUM(r.revenue) AS total_revenue\n        FROM revenue_cte r\n        JOIN last_year_cte ly ON r.year = ly.last_year\n        JOIN Artist a ON r.ArtistId = a.ArtistId\n        GROUP BY r.ArtistId, a.Name\n        ORDER BY total_revenue DESC\n        LIMIT 1\n    ),\n    monthly_revenue AS (\n        SELECT\n            r.month,\n            SUM(CASE WHEN r.year = ly.last_year THEN r.revenue ELSE 0 END) AS revenue_this_year,\n            SUM(CASE WHEN r.year = CAST(ly.last_year AS INTEGER) - 1 THEN r.revenue ELSE 0 END) AS revenue_last_year\n        FROM revenue_cte r\n        JOIN artist_totals at ON r.ArtistId = at.ArtistId\n        JOIN last_year_cte ly\n        GROUP BY r.month\n        ORDER BY r.month\n    ),\n    top_customer_cte AS (\n        SELECT\n            strftime('%m', i.InvoiceDate) AS month,\n            i.CustomerId,\n            SUM(i.Total) AS total_spent,\n            ROW_NUMBER() OVER (PARTITION BY strftime('%m', i.InvoiceDate) ORDER BY SUM(i.Total) DESC) AS rn\n        FROM Invoice i\n        JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n        JOIN Track t ON il.TrackId = t.TrackId\n        JOIN Album a ON t.AlbumId = a.AlbumId\n        JOIN artist_totals at ON a.ArtistId = at.ArtistId\n        GROUP BY month, i.CustomerId\n    ),\n    top_customer_info AS (\n        SELECT\n            tc.month,\n            c.Country AS top_country,\n            e.FirstName || ' ' || e.LastName AS support_employee\n        FROM top_customer_cte tc\n        JOIN Customer c ON tc.CustomerId = c.CustomerId\n        JOIN Employee e ON c.SupportRepId = e.EmployeeId\n        WHERE tc.rn = 1\n    )\nSELECT\n    mr.month,\n    mr.revenue_this_year,\n    mr.revenue_last_year,\n    tci.top_country,\n    tci.support_employee\nFROM monthly_revenue mr\nLEFT JOIN top_customer_info tci ON mr.month = tci.month\nORDER BY mr.month;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "bd00918114b7db7ecded9d94fbe6f102",
          "output": [
            {
              "question": "For each genre, compute the average, maximum, and minimum revenue per quarter for the current year, count the number of invoices contributing to each quarter’s revenue, and determine which genre had the highest average quarterly revenue and which genre experienced the greatest year‑over‑year percentage growth in total revenue.",
              "sql": "WITH per_genre_quarter AS (\n  SELECT\n    g.GenreId,\n    g.Name AS GenreName,\n    CASE\n      WHEN strftime('%m', i.InvoiceDate) BETWEEN '01' AND '03' THEN 1\n      WHEN strftime('%m', i.InvoiceDate) BETWEEN '04' AND '06' THEN 2\n      WHEN strftime('%m', i.InvoiceDate) BETWEEN '07' AND '09' THEN 3\n      ELSE 4\n    END AS Quarter,\n    SUM(il.UnitPrice * il.Quantity) AS Revenue,\n    COUNT(DISTINCT i.InvoiceId) AS InvoiceCount\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  WHERE strftime('%Y', i.InvoiceDate) = strftime('%Y', 'now')\n  GROUP BY g.GenreId, Quarter\n),\ngenre_quarter_stats AS (\n  SELECT\n    GenreId,\n    GenreName,\n    AVG(Revenue) AS AvgQuarterRevenue,\n    MAX(Revenue) AS MaxQuarterRevenue,\n    MIN(Revenue) AS MinQuarterRevenue,\n    SUM(InvoiceCount) AS TotalInvoices\n  FROM per_genre_quarter\n  GROUP BY GenreId, GenreName\n),\nyearly_revenue AS (\n  SELECT\n    g.GenreId,\n    g.Name AS GenreName,\n    strftime('%Y', i.InvoiceDate) AS Year,\n    SUM(il.UnitPrice * il.Quantity) AS TotalRevenue\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY g.GenreId, Year\n),\ncurrent_year_rev AS (\n  SELECT GenreId, GenreName, TotalRevenue\n  FROM yearly_revenue\n  WHERE Year = strftime('%Y', 'now')\n),\nprevious_year_rev AS (\n  SELECT GenreId, TotalRevenue AS PrevRevenue\n  FROM yearly_revenue\n  WHERE Year = strftime('%Y', 'now') - 1\n),\nfinal_stats AS (\n  SELECT\n    gqs.GenreName,\n    gqs.AvgQuarterRevenue,\n    gqs.MaxQuarterRevenue,\n    gqs.MinQuarterRevenue,\n    gqs.TotalInvoices,\n    COALESCE(cyr.TotalRevenue, 0) AS CurrentYearRevenue,\n    COALESCE(pyr.PrevRevenue, 0) AS PreviousYearRevenue,\n    CASE\n      WHEN pyr.PrevRevenue IS NULL OR pyr.PrevRevenue = 0 THEN NULL\n      ELSE ((cyr.TotalRevenue - pyr.PrevRevenue) / pyr.PrevRevenue) * 100\n    END AS YoYGrowthPercent\n  FROM genre_quarter_stats gqs\n  LEFT JOIN current_year_rev cyr ON gqs.GenreId = cyr.GenreId\n  LEFT JOIN previous_year_rev pyr ON gqs.GenreId = pyr.GenreId\n)\nSELECT\n  GenreName,\n  AvgQuarterRevenue,\n  MaxQuarterRevenue,\n  MinQuarterRevenue,\n  TotalInvoices,\n  CurrentYearRevenue,\n  PreviousYearRevenue,\n  YoYGrowthPercent,\n  ROW_NUMBER() OVER (ORDER BY AvgQuarterRevenue DESC) AS RankAvgQuarterRevenue,\n  ROW_NUMBER() OVER (ORDER BY YoYGrowthPercent DESC) AS RankYoYGrowth\nFROM final_stats\nORDER BY GenreName;",
              "success": true
            },
            {
              "question": "For the current year, compute the total sales revenue per genre for each quarter, but only include invoices whose billing country is \"United Kingdom\" and where the customer has made at least three purchases in the last 12 months. Also determine which genre had the largest year‑over‑year growth in revenue among these filtered invoices.",
              "sql": "WITH eligible_invoices AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total\n  FROM Invoice i\n  WHERE i.BillingCountry = 'United Kingdom'\n    AND i.InvoiceDate >= date('now', '-12 months')\n),\ncustomer_counts AS (\n  SELECT CustomerId, COUNT(*) AS cnt\n  FROM eligible_invoices\n  GROUP BY CustomerId\n),\nfiltered_invoices AS (\n  SELECT ei.*\n  FROM eligible_invoices ei\n  JOIN customer_counts cc ON ei.CustomerId = cc.CustomerId\n  WHERE cc.cnt >= 3\n),\ninvoice_lines AS (\n  SELECT fi.InvoiceId, fi.InvoiceDate, t.GenreId, g.Name AS GenreName,\n         il.UnitPrice * il.Quantity AS revenue\n  FROM filtered_invoices fi\n  JOIN InvoiceLine il ON fi.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n),\nrevenue_quarter AS (\n  SELECT \n    strftime('%Y', InvoiceDate) AS year,\n    ((strftime('%m', InvoiceDate) - 1) / 3 + 1) AS quarter,\n    GenreId,\n    GenreName,\n    SUM(revenue) AS total_revenue\n  FROM invoice_lines\n  WHERE strftime('%Y', InvoiceDate) = strftime('%Y', 'now')\n  GROUP BY year, quarter, GenreId, GenreName\n)\nSELECT year, quarter, GenreName, total_revenue\nFROM revenue_quarter\nORDER BY year, quarter, total_revenue DESC;\n\nWITH eligible_invoices AS (\n  SELECT i.InvoiceId, i.CustomerId, i.InvoiceDate, i.Total\n  FROM Invoice i\n  WHERE i.BillingCountry = 'United Kingdom'\n    AND i.InvoiceDate >= date('now', '-12 months')\n),\ncustomer_counts AS (\n  SELECT CustomerId, COUNT(*) AS cnt\n  FROM eligible_invoices\n  GROUP BY CustomerId\n),\nfiltered_invoices AS (\n  SELECT ei.*\n  FROM eligible_invoices ei\n  JOIN customer_counts cc ON ei.CustomerId = cc.CustomerId\n  WHERE cc.cnt >= 3\n),\ninvoice_lines AS (\n  SELECT fi.InvoiceId, fi.InvoiceDate, t.GenreId, g.Name AS GenreName,\n         il.UnitPrice * il.Quantity AS revenue\n  FROM filtered_invoices fi\n  JOIN InvoiceLine il ON fi.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n),\nrevenue_year AS (\n  SELECT \n    strftime('%Y', InvoiceDate) AS year,\n    GenreId,\n    GenreName,\n    SUM(revenue) AS total_revenue\n  FROM invoice_lines\n  GROUP BY year, GenreId, GenreName\n),\ncurrent_year AS (\n  SELECT * FROM revenue_year WHERE year = strftime('%Y', 'now')\n),\nprevious_year AS (\n  SELECT * FROM revenue_year WHERE year = strftime('%Y', 'now', '-1 year')\n),\ngrowth AS (\n  SELECT \n    c.GenreId,\n    c.GenreName,\n    c.total_revenue AS current_year,\n    p.total_revenue AS previous_year,\n    (c.total_revenue - p.total_revenue) AS revenue_growth,\n    ((c.total_revenue - p.total_revenue) / NULLIF(p.total_revenue,0)) AS growth_percent\n  FROM current_year c\n  LEFT JOIN previous_year p ON c.GenreId = p.GenreId\n)\nSELECT GenreName, revenue_growth, growth_percent\nFROM growth\nORDER BY revenue_growth DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "For the current year, what is the total sales revenue per genre for each quarter, broken down by the country of the customer and the artist whose tracks were sold, and which genre experienced the greatest year‑over‑year revenue growth within each country?",
              "sql": "WITH sales AS (\n  SELECT\n    i.CustomerId,\n    c.Country AS CustomerCountry,\n    a.ArtistId,\n    a.Name AS ArtistName,\n    t.GenreId,\n    g.Name AS GenreName,\n    CAST(strftime('%Y', i.InvoiceDate) AS INTEGER) AS Year,\n    ((CAST(strftime('%m', i.InvoiceDate) AS INTEGER)-1)/3 + 1) AS Quarter,\n    SUM(il.UnitPrice * il.Quantity) AS Revenue\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY i.CustomerId, c.Country, a.ArtistId, a.Name, t.GenreId, g.Name, Year, Quarter\n),\ncurrent_year AS (\n  SELECT * FROM sales WHERE Year = CAST(strftime('%Y', 'now') AS INTEGER)\n),\nprevious_year AS (\n  SELECT * FROM sales WHERE Year = CAST(strftime('%Y', 'now') AS INTEGER) - 1\n),\nrevenue_by_quarter AS (\n  SELECT\n    cy.CustomerCountry,\n    cy.ArtistName,\n    cy.GenreName,\n    cy.Quarter,\n    SUM(cy.Revenue) AS TotalRevenue\n  FROM current_year cy\n  GROUP BY cy.CustomerCountry, cy.ArtistName, cy.GenreName, cy.Quarter\n),\nrevenue_by_genre_country AS (\n  SELECT\n    cy.CustomerCountry,\n    cy.GenreName,\n    SUM(cy.Revenue) AS CurrentRevenue,\n    py.Revenue AS PreviousRevenue\n  FROM current_year cy\n  LEFT JOIN previous_year py\n    ON cy.CustomerCountry = py.CustomerCountry\n   AND cy.GenreName = py.GenreName\n  GROUP BY cy.CustomerCountry, cy.GenreName, py.Revenue\n),\ngrowth AS (\n  SELECT\n    CustomerCountry,\n    GenreName,\n    CASE WHEN PreviousRevenue IS NULL OR PreviousRevenue = 0 THEN NULL\n         ELSE (CurrentRevenue - PreviousRevenue) / PreviousRevenue\n    END AS YoYGrowth\n  FROM revenue_by_genre_country\n),\nmax_growth AS (\n  SELECT\n    CustomerCountry,\n    GenreName,\n    YoYGrowth\n  FROM growth g\n  WHERE YoYGrowth = (\n    SELECT MAX(YoYGrowth) FROM growth WHERE CustomerCountry = g.CustomerCountry\n  )\n)\nSELECT\n  r.CustomerCountry,\n  r.ArtistName,\n  r.GenreName,\n  r.Quarter,\n  r.TotalRevenue\nFROM revenue_by_quarter r\nORDER BY r.CustomerCountry, r.ArtistName, r.GenreName, r.Quarter;\n\n-- Genre with greatest YoY growth per country\nSELECT\n  mg.CustomerCountry,\n  mg.GenreName,\n  mg.YoYGrowth\nFROM max_growth mg\nORDER BY mg.CustomerCountry;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "c4fa0ba1bc1abb03132fe59ef56244b6",
          "output": [
            {
              "question": "For each state, report the number of customers who spent more than $500 in the past year, the average commission paid to their assigned sales representative (10% of total spend), the maximum and minimum commission among those customers, and the total commission paid for that state.",
              "sql": "WITH customer_spend AS (\n  SELECT c.CustomerId,\n         c.State,\n         SUM(i.Total) AS TotalSpend\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY c.CustomerId, c.State\n),\neligible AS (\n  SELECT State,\n         COUNT(*) AS CustomerCount,\n         AVG(0.1 * TotalSpend) AS AvgCommission,\n         MAX(0.1 * TotalSpend) AS MaxCommission,\n         MIN(0.1 * TotalSpend) AS MinCommission,\n         SUM(0.1 * TotalSpend) AS TotalCommission\n  FROM customer_spend\n  WHERE TotalSpend > 500\n  GROUP BY State\n)\nSELECT State,\n       CustomerCount,\n       AvgCommission,\n       MaxCommission,\n       MinCommission,\n       TotalCommission\nFROM eligible\nORDER BY State;",
              "success": true
            },
            {
              "question": "How many customers in each state have spent more than $500 in the past year, have placed at least three invoices, and whose assigned sales representative holds the title \"Sales Representative\", and what is the average commission paid to those sales representatives based on a 10% commission rate?",
              "sql": "WITH qualifying_customers AS (\n  SELECT c.CustomerId,\n         c.SupportRepId,\n         c.State\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  WHERE e.Title = 'Sales Representative'\n    AND i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY c.CustomerId, c.SupportRepId, c.State\n  HAVING SUM(i.Total) > 500\n     AND COUNT(i.InvoiceId) >= 3\n),\nrep_commissions AS (\n  SELECT qc.SupportRepId,\n         qc.State,\n         0.10 * SUM(i.Total) AS commission\n  FROM qualifying_customers qc\n  JOIN Invoice i ON qc.CustomerId = i.CustomerId\n  GROUP BY qc.SupportRepId, qc.State\n)\nSELECT rc.State,\n       COUNT(DISTINCT qc.CustomerId) AS customer_count,\n       AVG(rc.commission) AS avg_commission\nFROM qualifying_customers qc\nJOIN rep_commissions rc ON qc.SupportRepId = rc.SupportRepId\n                         AND qc.State = rc.State\nGROUP BY rc.State;",
              "success": true
            },
            {
              "question": "For each state, how many customers who have spent more than $500 in the past year, and what is the average commission paid to their assigned sales representative (using a 10% commission rate), including the representative's title and the most common genre of music purchased by those customers?",
              "sql": "WITH CustomerSpending AS (\n  SELECT\n    c.CustomerId,\n    c.State,\n    c.SupportRepId,\n    SUM(i.Total) AS TotalSpent\n  FROM Customer c\n  JOIN Invoice i ON c.CustomerId = i.CustomerId\n  WHERE i.InvoiceDate >= date('now', '-1 year')\n  GROUP BY c.CustomerId, c.State, c.SupportRepId\n  HAVING SUM(i.Total) > 500\n),\nCustomerCommission AS (\n  SELECT\n    cs.CustomerId,\n    cs.State,\n    cs.SupportRepId,\n    cs.TotalSpent,\n    cs.TotalSpent * 0.10 AS Commission\n  FROM CustomerSpending cs\n),\nStateStats AS (\n  SELECT\n    cc.State,\n    COUNT(DISTINCT cc.CustomerId) AS CustomerCount,\n    AVG(cc.Commission) AS AvgCommission\n  FROM CustomerCommission cc\n  GROUP BY cc.State\n),\nRepTitlePerState AS (\n  SELECT\n    cc.State,\n    e.Title,\n    COUNT(*) AS RepCount\n  FROM CustomerCommission cc\n  JOIN Employee e ON cc.SupportRepId = e.EmployeeId\n  GROUP BY cc.State, e.Title\n),\nTopRepTitle AS (\n  SELECT\n    State,\n    Title AS RepTitle\n  FROM (\n    SELECT\n      State,\n      Title,\n      ROW_NUMBER() OVER (PARTITION BY State ORDER BY RepCount DESC) AS rn\n    FROM RepTitlePerState\n  )\n  WHERE rn = 1\n),\nGenrePerState AS (\n  SELECT\n    cs.State,\n    g.Name AS GenreName,\n    COUNT(*) AS GenreCount\n  FROM CustomerSpending cs\n  JOIN Invoice i ON cs.CustomerId = i.CustomerId\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Genre g ON t.GenreId = g.GenreId\n  GROUP BY cs.State, g.Name\n),\nTopGenrePerState AS (\n  SELECT\n    State,\n    GenreName\n  FROM (\n    SELECT\n      State,\n      GenreName,\n      ROW_NUMBER() OVER (PARTITION BY State ORDER BY GenreCount DESC) AS rn\n    FROM GenrePerState\n  )\n  WHERE rn = 1\n)\nSELECT\n  ss.State,\n  ss.CustomerCount,\n  ss.AvgCommission,\n  trt.RepTitle,\n  tgp.GenreName AS MostCommonGenre\nFROM StateStats ss\nLEFT JOIN TopRepTitle trt ON ss.State = trt.State\nLEFT JOIN TopGenrePerState tgp ON ss.State = tgp.State;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "2a1d216cc36b4dc96ccc0143a540e2fc",
          "output": [
            {
              "question": "For each playlist whose combined track length exceeds 10,000 seconds, list the playlist name, total playtime in seconds, number of tracks, average track length in seconds, the percentage of all tracks this playlist contains, and the count of distinct genres represented within that playlist.",
              "sql": "WITH total_tracks AS (\n  SELECT COUNT(*) AS total FROM Track\n),\nplaylist_stats AS (\n  SELECT\n    p.PlaylistId,\n    p.Name,\n    SUM(t.Milliseconds)/1000.0 AS total_seconds,\n    COUNT(pt.TrackId) AS track_count,\n    SUM(t.Milliseconds)/1000.0 / COUNT(pt.TrackId) AS avg_seconds,\n    COUNT(DISTINCT t.GenreId) AS distinct_genre_count\n  FROM Playlist p\n  JOIN PlaylistTrack pt ON p.PlaylistId = pt.PlaylistId\n  JOIN Track t ON pt.TrackId = t.TrackId\n  GROUP BY p.PlaylistId, p.Name\n  HAVING SUM(t.Milliseconds)/1000.0 > 10000\n)\nSELECT\n  ps.Name,\n  ps.total_seconds,\n  ps.track_count,\n  ps.avg_seconds,\n  (ps.track_count * 100.0 / tt.total) AS pct_of_all_tracks,\n  ps.distinct_genre_count\nFROM playlist_stats ps\nCROSS JOIN total_tracks tt\nORDER BY ps.total_seconds DESC;",
              "success": true
            },
            {
              "question": "Which playlists contain tracks that together exceed 10,000 seconds of total playtime, where every track in each playlist has been purchased at least five times across all invoices, and what percentage of the total track count in those playlists does each playlist represent?",
              "sql": "WITH track_purchase_counts AS (\n    SELECT tl.TrackId, COUNT(*) AS purchase_count\n    FROM InvoiceLine tl\n    GROUP BY tl.TrackId\n),\nplaylist_tracks AS (\n    SELECT pt.PlaylistId, pt.TrackId, t.Milliseconds\n    FROM PlaylistTrack pt\n    JOIN Track t ON pt.TrackId = t.TrackId\n),\nplaylist_track_counts AS (\n    SELECT pt.PlaylistId,\n           COUNT(*) AS track_count,\n           SUM(pt.Milliseconds) AS total_ms,\n           MIN(COALESCE(tpc.purchase_count,0)) AS min_purchase\n    FROM playlist_tracks pt\n    LEFT JOIN track_purchase_counts tpc ON pt.TrackId = tpc.TrackId\n    GROUP BY pt.PlaylistId\n    HAVING MIN(COALESCE(tpc.purchase_count,0)) >= 5\n       AND SUM(pt.Milliseconds) > 10000000\n)\nSELECT p.PlaylistId,\n       p.Name,\n       ptc.total_ms / 1000.0 AS total_seconds,\n       ptc.track_count,\n       ROUND(100.0 * ptc.track_count / total_all.total_tracks, 2) AS pct_of_total_tracks\nFROM playlist_track_counts ptc\nJOIN Playlist p ON ptc.PlaylistId = p.PlaylistId\nCROSS JOIN (\n    SELECT SUM(track_count) AS total_tracks\n    FROM playlist_track_counts\n) total_all;",
              "success": true
            },
            {
              "question": "Which playlists contain tracks whose combined playtime exceeds 10,000 seconds? For each of those playlists, what percentage of the database’s total track count does the playlist represent, how many distinct artists appear in the playlist, and what are the three most common genres by track count within the playlist?",
              "sql": "WITH total_tracks AS (\n    SELECT COUNT(*) AS total FROM Track\n),\nplaylist_stats AS (\n    SELECT\n        p.PlaylistId,\n        p.Name AS PlaylistName,\n        SUM(t.Milliseconds)/1000.0 AS TotalPlaytimeSeconds,\n        COUNT(t.TrackId) AS TrackCount,\n        COUNT(DISTINCT a.ArtistId) AS DistinctArtistCount\n    FROM Playlist p\n    JOIN PlaylistTrack pt ON p.PlaylistId = pt.PlaylistId\n    JOIN Track t ON pt.TrackId = t.TrackId\n    JOIN Album al ON t.AlbumId = al.AlbumId\n    JOIN Artist a ON al.ArtistId = a.ArtistId\n    GROUP BY p.PlaylistId, p.Name\n),\ngenre_counts AS (\n    SELECT\n        p.PlaylistId,\n        COALESCE(g.Name, 'Unknown') AS GenreName,\n        COUNT(*) AS GenreTrackCount,\n        ROW_NUMBER() OVER (PARTITION BY p.PlaylistId ORDER BY COUNT(*) DESC, COALESCE(g.Name, 'Unknown')) AS rn\n    FROM Playlist p\n    JOIN PlaylistTrack pt ON p.PlaylistId = pt.PlaylistId\n    JOIN Track t ON pt.TrackId = t.TrackId\n    LEFT JOIN Genre g ON t.GenreId = g.GenreId\n    GROUP BY p.PlaylistId, COALESCE(g.Name, 'Unknown')\n),\ntop_genres AS (\n    SELECT\n        gc.PlaylistId,\n        GROUP_CONCAT(gc.GenreName, ', ') AS TopGenres\n    FROM genre_counts gc\n    WHERE gc.rn <= 3\n    GROUP BY gc.PlaylistId\n)\nSELECT\n    ps.PlaylistId,\n    ps.PlaylistName,\n    ps.TotalPlaytimeSeconds,\n    (ps.TrackCount * 100.0 / tt.total) AS PercentOfTotalTracks,\n    ps.DistinctArtistCount,\n    tg.TopGenres\nFROM playlist_stats ps\nJOIN total_tracks tt ON 1=1\nJOIN top_genres tg ON ps.PlaylistId = tg.PlaylistId\nWHERE ps.TotalPlaytimeSeconds > 10000\nORDER BY ps.TotalPlaytimeSeconds DESC;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "a7ffc26e99de69e094b234d800baa0e0",
          "output": [
            {
              "question": "Compute, for each artist, the monthly total sales, the running cumulative sales, the average monthly sales, and the number of distinct tracks sold. Then identify, for each year, the artist with the highest average monthly sales, and list the top three artists by cumulative sales for the entire period.",
              "sql": "WITH Monthly AS (\n  SELECT a.ArtistId, a.Name AS ArtistName,\n         strftime('%Y-%m', i.InvoiceDate) AS YearMonth,\n         SUM(il.UnitPrice * il.Quantity) AS MonthlyTotal\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  GROUP BY a.ArtistId, a.Name, YearMonth\n),\nMonthlyStats AS (\n  SELECT m.*,\n         SUM(MonthlyTotal) OVER (PARTITION BY ArtistId ORDER BY YearMonth\n                                 ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS CumulativeTotal,\n         AVG(MonthlyTotal) OVER (PARTITION BY ArtistId) AS AvgMonthlySales\n  FROM Monthly m\n),\nDistinctTracks AS (\n  SELECT a.ArtistId,\n         COUNT(DISTINCT t.TrackId) AS DistinctTracks\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  GROUP BY a.ArtistId\n)\nSELECT ms.ArtistId, ms.ArtistName, ms.YearMonth, ms.MonthlyTotal,\n       ms.CumulativeTotal, ms.AvgMonthlySales,\n       dt.DistinctTracks\nFROM MonthlyStats ms\nJOIN DistinctTracks dt ON ms.ArtistId = dt.ArtistId\nORDER BY ms.ArtistId, ms.YearMonth;\n\n-- Artist with highest average monthly sales per year\nWITH YearlyAvg AS (\n  SELECT a.ArtistId, a.Name AS ArtistName,\n         strftime('%Y', i.InvoiceDate) AS Year,\n         AVG(il.UnitPrice * il.Quantity) AS AvgMonthlySalesYear\n  FROM InvoiceLine il\n  JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album al ON t.AlbumId = al.AlbumId\n  JOIN Artist a ON al.ArtistId = a.ArtistId\n  GROUP BY a.ArtistId, a.Name, Year\n),\nRanked AS (\n  SELECT *, ROW_NUMBER() OVER (PARTITION BY Year ORDER BY AvgMonthlySalesYear DESC) AS rn\n  FROM YearlyAvg\n)\nSELECT ArtistId, ArtistName, Year, AvgMonthlySalesYear\nFROM Ranked\nWHERE rn = 1\nORDER BY Year;\n\n-- Top three artists by cumulative sales\nSELECT a.ArtistId, a.Name AS ArtistName,\n       SUM(il.UnitPrice * il.Quantity) AS TotalSales\nFROM InvoiceLine il\nJOIN Invoice i ON il.InvoiceId = i.InvoiceId\nJOIN Track t ON il.TrackId = t.TrackId\nJOIN Album al ON t.AlbumId = al.AlbumId\nJOIN Artist a ON al.ArtistId = a.ArtistId\nGROUP BY a.ArtistId, a.Name\nORDER BY TotalSales DESC\nLIMIT 3;",
              "success": true
            },
            {
              "question": "For the past year, what is the running total of sales per artist who has released at least three albums, broken down by month, and which of those artists has the highest cumulative sales at each month?",
              "sql": "WITH artist_album_counts AS (\n  SELECT ArtistId, COUNT(DISTINCT AlbumId) AS album_count\n  FROM Album\n  GROUP BY ArtistId\n  HAVING COUNT(DISTINCT AlbumId) >= 3\n),\nmonthly_sales AS (\n  SELECT\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    a.ArtistId,\n    ar.Name AS artist_name,\n    SUM(il.UnitPrice * il.Quantity) AS month_sales\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album a ON t.AlbumId = a.AlbumId\n  JOIN Artist ar ON a.ArtistId = ar.ArtistId\n  JOIN artist_album_counts ac ON ar.ArtistId = ac.ArtistId\n  GROUP BY month, a.ArtistId, ar.Name\n),\ncumulative_sales AS (\n  SELECT\n    month,\n    ArtistId,\n    artist_name,\n    month_sales,\n    SUM(month_sales) OVER (PARTITION BY ArtistId ORDER BY month ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS cumulative_sales\n  FROM monthly_sales\n),\nranked AS (\n  SELECT\n    month,\n    artist_name,\n    cumulative_sales,\n    ROW_NUMBER() OVER (PARTITION BY month ORDER BY cumulative_sales DESC) AS rn\n  FROM cumulative_sales\n)\nSELECT\n  month,\n  artist_name,\n  cumulative_sales,\n  CASE WHEN rn = 1 THEN 1 ELSE 0 END AS is_top_artist\nFROM ranked\nORDER BY month, artist_name;",
              "success": true
            },
            {
              "question": "Calculate the month‑by‑month running total of sales for each artist, showing for each month the total sales, the average unit price of the tracks sold, the most frequently purchased genre, and the customer country that contributed the highest sales for that artist in that month; also indicate which artist had the highest cumulative sales at the end of each month.",
              "sql": "WITH sales AS (\n  SELECT\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    a.ArtistId,\n    ar.Name AS artist_name,\n    i.Total AS invoice_total,\n    il.UnitPrice,\n    il.Quantity,\n    t.GenreId,\n    g.Name AS genre_name,\n    c.Country AS customer_country\n  FROM Invoice i\n  JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  JOIN Track t ON il.TrackId = t.TrackId\n  JOIN Album a ON t.AlbumId = a.AlbumId\n  JOIN Artist ar ON a.ArtistId = ar.ArtistId\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  LEFT JOIN Genre g ON t.GenreId = g.GenreId\n),\nmonthly AS (\n  SELECT\n    month,\n    ArtistId,\n    artist_name,\n    SUM(invoice_total) AS total_sales,\n    AVG(UnitPrice) AS avg_unit_price,\n    (SELECT genre_name FROM (\n        SELECT s2.genre_name, SUM(s2.Quantity) AS cnt\n        FROM sales s2\n        WHERE s2.month = s.month AND s2.ArtistId = s.ArtistId\n        GROUP BY s2.genre_name\n        ORDER BY cnt DESC, s2.genre_name ASC\n        LIMIT 1\n    )) AS most_frequent_genre,\n    (SELECT customer_country FROM (\n        SELECT s2.customer_country, SUM(s2.invoice_total) AS sum_sales\n        FROM sales s2\n        WHERE s2.month = s.month AND s2.ArtistId = s.ArtistId\n        GROUP BY s2.customer_country\n        ORDER BY sum_sales DESC, s2.customer_country ASC\n        LIMIT 1\n    )) AS top_country\n  FROM sales s\n  GROUP BY month, ArtistId, artist_name\n),\ncumulative AS (\n  SELECT\n    month,\n    ArtistId,\n    artist_name,\n    total_sales,\n    avg_unit_price,\n    most_frequent_genre,\n    top_country,\n    SUM(total_sales) OVER (PARTITION BY ArtistId ORDER BY month) AS cumulative_sales\n  FROM monthly\n),\ntop_artist AS (\n  SELECT month, artist_name\n  FROM (\n    SELECT month, artist_name, cumulative_sales,\n           ROW_NUMBER() OVER (PARTITION BY month ORDER BY cumulative_sales DESC, artist_name) AS rn\n    FROM cumulative\n  )\n  WHERE rn = 1\n)\nSELECT\n  c.month,\n  c.artist_name,\n  c.total_sales,\n  c.avg_unit_price,\n  c.most_frequent_genre,\n  c.top_country,\n  t.artist_name AS top_artist_month\nFROM cumulative c\nLEFT JOIN top_artist t ON c.month = t.month\nORDER BY c.month, c.artist_name;",
              "success": true
            }
          ]
        },
        {
          "inputHash": "2ce80f1159748b8e83d7ac8b517248a1",
          "output": [
            {
              "question": "For each artist, list their albums ranked by total revenue, show each album’s revenue, the percentage of the artist’s total revenue it represents, the cumulative revenue of the top three albums, and also provide the artist’s average, maximum, and minimum album revenue, as well as the total number of albums the artist has released.",
              "sql": "WITH album_rev AS (\n  SELECT\n    a.AlbumId,\n    a.Title AS AlbumTitle,\n    a.ArtistId,\n    SUM(il.UnitPrice * il.Quantity) AS AlbumRevenue\n  FROM Album a\n  JOIN Track t ON t.AlbumId = a.AlbumId\n  JOIN InvoiceLine il ON il.TrackId = t.TrackId\n  GROUP BY a.AlbumId, a.Title, a.ArtistId\n),\nartist_stats AS (\n  SELECT\n    ArtistId,\n    SUM(AlbumRevenue) AS ArtistTotalRevenue,\n    AVG(AlbumRevenue) AS AvgAlbumRevenue,\n    MAX(AlbumRevenue) AS MaxAlbumRevenue,\n    MIN(AlbumRevenue) AS MinAlbumRevenue,\n    COUNT(*) AS AlbumCount\n  FROM album_rev\n  GROUP BY ArtistId\n),\ntop3_rev AS (\n  SELECT\n    ArtistId,\n    SUM(AlbumRevenue) AS Top3Revenue\n  FROM (\n    SELECT\n      ArtistId,\n      AlbumRevenue,\n      ROW_NUMBER() OVER (PARTITION BY ArtistId ORDER BY AlbumRevenue DESC) AS rn\n    FROM album_rev\n  ) sub\n  WHERE rn <= 3\n  GROUP BY ArtistId\n)\nSELECT\n  ast.ArtistId,\n  a.Name AS ArtistName,\n  ar.AlbumId,\n  ar.AlbumTitle,\n  ar.AlbumRevenue,\n  ROUND(100.0 * ar.AlbumRevenue / ast.ArtistTotalRevenue, 2) AS PercentOfArtistRevenue,\n  tr.Top3Revenue AS CumulativeTop3Revenue,\n  ROUND(ast.AvgAlbumRevenue, 2) AS AvgAlbumRevenue,\n  ROUND(ast.MaxAlbumRevenue, 2) AS MaxAlbumRevenue,\n  ROUND(ast.MinAlbumRevenue, 2) AS MinAlbumRevenue,\n  ast.AlbumCount\nFROM album_rev ar\nJOIN artist_stats ast ON ar.ArtistId = ast.ArtistId\nJOIN top3_rev tr ON ar.ArtistId = tr.ArtistId\nJOIN Artist a ON ar.ArtistId = a.ArtistId\nORDER BY ast.ArtistId, ar.AlbumRevenue DESC;",
              "success": false
            },
            {
              "question": "For invoices dated within the last 12 months and billed to the United States, rank each artist's albums by total revenue, display the percentage of each album's revenue relative to the artist's total revenue in that period, and include a running subtotal of the top 3 albums, but only for artists whose total revenue in that period exceeds $10,000.",
              "sql": "WITH album_rev AS (\n    SELECT\n        ar.ArtistId,\n        ar.Name AS artist_name,\n        al.AlbumId,\n        al.Title AS album_title,\n        SUM(il.UnitPrice * il.Quantity) AS album_revenue\n    FROM InvoiceLine il\n    JOIN Invoice i ON il.InvoiceId = i.InvoiceId\n    JOIN Track t ON il.TrackId = t.TrackId\n    JOIN Album al ON t.AlbumId = al.AlbumId\n    JOIN Artist ar ON al.ArtistId = ar.ArtistId\n    WHERE i.InvoiceDate >= date('now', '-12 months')\n      AND i.BillingCountry = 'United States'\n    GROUP BY ar.ArtistId, al.AlbumId\n),\nartist_rev AS (\n    SELECT\n        ArtistId,\n        artist_name,\n        SUM(album_revenue) AS artist_total_revenue\n    FROM album_rev\n    GROUP BY ArtistId, artist_name\n),\nfiltered AS (\n    SELECT\n        ar.ArtistId,\n        ar.artist_name,\n        ar.album_title,\n        ar.album_revenue,\n        ar2.artist_total_revenue\n    FROM album_rev ar\n    JOIN artist_rev ar2 ON ar.ArtistId = ar2.ArtistId\n    WHERE ar2.artist_total_revenue > 10000\n),\nranked AS (\n    SELECT\n        ArtistId,\n        artist_name,\n        album_title,\n        album_revenue,\n        artist_total_revenue,\n        ROW_NUMBER() OVER (PARTITION BY ArtistId ORDER BY album_revenue DESC) AS rn\n    FROM filtered\n),\nfinal AS (\n    SELECT\n        artist_name,\n        album_title,\n        album_revenue,\n        ROUND(100.0 * album_revenue / artist_total_revenue, 2) AS revenue_percentage,\n        CASE WHEN rn <= 3 THEN SUM(album_revenue) OVER (PARTITION BY ArtistId ORDER BY rn) END AS running_subtotal_top3\n    FROM ranked\n)\nSELECT *\nFROM final\nORDER BY artist_name, album_revenue DESC;",
              "success": true
            },
            {
              "question": "Rank the albums within each artist by total revenue and show the percentage that each album contributes to that artist's overall sales, including a running subtotal for the top 3 albums. For each of those top 3 albums, also list the customer who bought the most units of that album, the customer's country, and the name of the employee who served that customer.",
              "sql": "WITH album_rev AS (\n  SELECT a.ArtistId,\n         a.AlbumId,\n         a.Title AS AlbumTitle,\n         SUM(il.UnitPrice * il.Quantity) AS AlbumRevenue\n  FROM Album a\n  JOIN Track t ON t.AlbumId = a.AlbumId\n  JOIN InvoiceLine il ON il.TrackId = t.TrackId\n  GROUP BY a.ArtistId, a.AlbumId, a.Title\n),\nartist_tot AS (\n  SELECT ArtistId,\n         SUM(AlbumRevenue) AS ArtistTotalRevenue\n  FROM album_rev\n  GROUP BY ArtistId\n),\nranked AS (\n  SELECT ar.ArtistId,\n         ar.AlbumId,\n         ar.AlbumTitle,\n         ar.AlbumRevenue,\n         at.ArtistTotalRevenue,\n         (ar.AlbumRevenue * 100.0 / at.ArtistTotalRevenue) AS RevenuePercentage,\n         ROW_NUMBER() OVER (PARTITION BY ar.ArtistId ORDER BY ar.AlbumRevenue DESC) AS AlbumRank,\n         SUM(ar.AlbumRevenue) OVER (PARTITION BY ar.ArtistId ORDER BY ar.AlbumRevenue DESC\n                                    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningSubtotal\n  FROM album_rev ar\n  JOIN artist_tot at ON at.ArtistId = ar.ArtistId\n),\ntop_customer AS (\n  SELECT t.AlbumId,\n         i.CustomerId,\n         SUM(il.Quantity) AS TotalUnits,\n         ROW_NUMBER() OVER (PARTITION BY t.AlbumId ORDER BY SUM(il.Quantity) DESC) AS CustomerRank\n  FROM InvoiceLine il\n  JOIN Track t ON t.TrackId = il.TrackId\n  JOIN Invoice i ON i.InvoiceId = il.InvoiceId\n  GROUP BY t.AlbumId, i.CustomerId\n)\nSELECT r.ArtistId,\n       a.Name AS ArtistName,\n       r.AlbumTitle,\n       r.AlbumRevenue,\n       r.ArtistTotalRevenue,\n       r.RevenuePercentage,\n       r.AlbumRank,\n       r.RunningSubtotal,\n       tc.CustomerId AS TopCustomerId,\n       c.Country AS TopCustomerCountry,\n       e.FirstName || ' ' || e.LastName AS TopEmployeeName\nFROM ranked r\nJOIN Artist a ON a.ArtistId = r.ArtistId\nLEFT JOIN top_customer tc ON tc.AlbumId = r.AlbumId AND tc.CustomerRank = 1\nLEFT JOIN Customer c ON c.CustomerId = tc.CustomerId\nLEFT JOIN Employee e ON e.EmployeeId = c.SupportRepId\nWHERE r.AlbumRank <= 3\nORDER BY r.ArtistId, r.AlbumRank;",
              "success": false
            }
          ]
        },
        {
          "inputHash": "f6f04501be5cb43992add2571faa683c",
          "output": [
            {
              "question": "For each state, compute the 3‑month moving average of total invoice amounts, the total count of invoices, and the average invoice value, then identify the state that shows the greatest growth rate in its moving average over the last three months.",
              "sql": "WITH monthly AS (\n  SELECT\n    BillingState AS state,\n    strftime('%Y-%m', InvoiceDate) AS month,\n    SUM(Total) AS monthly_total,\n    COUNT(*) AS monthly_count,\n    AVG(Total) AS monthly_avg\n  FROM Invoice\n  GROUP BY state, month\n),\nmoving AS (\n  SELECT\n    state,\n    month,\n    monthly_total,\n    monthly_count,\n    monthly_avg,\n    AVG(monthly_total) OVER (PARTITION BY state ORDER BY month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg\n  FROM monthly\n),\nlast_month AS (\n  SELECT\n    state,\n    month,\n    moving_avg,\n    LAG(moving_avg, 2) OVER (PARTITION BY state ORDER BY month) AS moving_avg_3_months_ago\n  FROM moving\n),\nstate_stats AS (\n  SELECT\n    BillingState AS state,\n    COUNT(*) AS total_invoices,\n    AVG(Total) AS avg_invoice_value\n  FROM Invoice\n  GROUP BY state\n),\nfinal AS (\n  SELECT\n    lm.state,\n    lm.month,\n    lm.moving_avg,\n    lm.moving_avg_3_months_ago,\n    CASE\n      WHEN lm.moving_avg_3_months_ago IS NULL OR lm.moving_avg_3_months_ago = 0 THEN NULL\n      ELSE (lm.moving_avg - lm.moving_avg_3_months_ago) / lm.moving_avg_3_months_ago\n    END AS growth_rate,\n    ss.total_invoices,\n    ss.avg_invoice_value\n  FROM last_month lm\n  JOIN state_stats ss ON lm.state = ss.state\n  WHERE lm.month = (SELECT MAX(month) FROM moving WHERE state = lm.state)\n)\nSELECT\n  state,\n  growth_rate,\n  total_invoices,\n  avg_invoice_value\nFROM final\nORDER BY growth_rate DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "For each customer state that has at least 15 customers and whose combined invoice total in the most recent quarter exceeds $5,000, calculate the 3‑month moving average of invoice totals for invoices dated within the last 18 months, and identify which of those states shows the greatest upward trend over the final quarter of that period.",
              "sql": "WITH\n  -- Determine the most recent quarter\n  recent_quarter AS (\n    SELECT\n      strftime('%Y', MAX(InvoiceDate)) AS year,\n      ((strftime('%m', MAX(InvoiceDate)) - 1)/3 + 1) AS quarter\n    FROM Invoice\n  ),\n  -- States that meet the customer count and quarter total criteria\n  qualifying_states AS (\n    SELECT\n      c.State,\n      COUNT(DISTINCT c.CustomerId) AS cust_count,\n      SUM(i.Total) AS quarter_total\n    FROM Customer c\n    JOIN Invoice i ON c.CustomerId = i.CustomerId\n    JOIN recent_quarter rq ON\n      strftime('%Y', i.InvoiceDate) = rq.year\n      AND ((strftime('%m', i.InvoiceDate) - 1)/3 + 1) = rq.quarter\n    GROUP BY c.State\n    HAVING cust_count >= 15 AND quarter_total > 5000\n  ),\n  -- Generate the list of the last 18 months (inclusive)\n  months AS (\n    SELECT date('now', '-18 months', 'start of month') AS month_start\n    UNION ALL\n    SELECT date(month_start, '+1 month')\n    FROM months\n    WHERE month_start < date('now', 'start of month')\n  ),\n  -- Aggregate invoice totals per state per month\n  state_month_totals AS (\n    SELECT\n      q.State,\n      m.month_start,\n      COALESCE(SUM(i.Total), 0) AS month_total\n    FROM qualifying_states q\n    CROSS JOIN months m\n    LEFT JOIN Customer c2 ON c2.State = q.State\n    LEFT JOIN Invoice i ON i.CustomerId = c2.CustomerId\n      AND date(i.InvoiceDate, 'start of month') = m.month_start\n    GROUP BY q.State, m.month_start\n  ),\n  -- Compute 3‑month moving average per state\n  moving_avg AS (\n    SELECT\n      State,\n      month_start,\n      month_total,\n      AVG(month_total) OVER (\n        PARTITION BY State\n        ORDER BY month_start\n        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n      ) AS mov_avg\n    FROM state_month_totals\n  ),\n  -- Calculate trend difference between final and first quarter\n  trend AS (\n    SELECT\n      State,\n      AVG(CASE WHEN month_start >= date('now', '-3 months', 'start of month')\n               AND month_start <= date('now', 'start of month')\n               THEN mov_avg END) AS final_quarter_avg,\n      AVG(CASE WHEN month_start >= date('now', '-18 months', 'start of month')\n               AND month_start < date(date('now', '-18 months', 'start of month'), '+3 month')\n               THEN mov_avg END) AS first_quarter_avg,\n      (AVG(CASE WHEN month_start >= date('now', '-3 months', 'start of month')\n                AND month_start <= date('now', 'start of month')\n                THEN mov_avg END) -\n       AVG(CASE WHEN month_start >= date('now', '-18 months', 'start of month')\n                AND month_start < date(date('now', '-18 months', 'start of month'), '+3 month')\n                THEN mov_avg END)) AS trend_diff\n    FROM moving_avg\n    GROUP BY State\n  )\nSELECT\n  State,\n  trend_diff\nFROM trend\nORDER BY trend_diff DESC\nLIMIT 1;",
              "success": true
            },
            {
              "question": "Across all customer states, compute for each state the 3‑month moving average of total invoice amounts and the average number of tracks sold per invoice. Then determine which state exhibits the steepest upward trend in invoice totals over the most recent quarter, and report the name of the support representative responsible for customers in that state.",
              "sql": "WITH invoice_monthly AS (\n  SELECT\n    c.State,\n    strftime('%Y-%m', i.InvoiceDate) AS month,\n    SUM(i.Total) AS total_amount,\n    SUM(il.Quantity) AS total_tracks,\n    COUNT(DISTINCT i.InvoiceId) AS invoice_count,\n    CAST(strftime('%Y%m', i.InvoiceDate) AS INTEGER) AS month_int\n  FROM Invoice i\n  JOIN Customer c ON i.CustomerId = c.CustomerId\n  LEFT JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId\n  GROUP BY c.State, month\n),\nstate_metrics AS (\n  SELECT\n    State,\n    AVG(total_amount) OVER (PARTITION BY State ORDER BY month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg,\n    SUM(total_tracks) / SUM(invoice_count) AS avg_tracks_per_invoice\n  FROM invoice_monthly\n),\nlast3 AS (\n  SELECT\n    State,\n    month_int,\n    total_amount\n  FROM invoice_monthly\n  WHERE month_int >= (SELECT MAX(month_int) - 2 FROM invoice_monthly)\n),\nslope_calc AS (\n  SELECT\n    State,\n    (COUNT(*) * SUM(total_amount * month_int) - SUM(month_int) * SUM(total_amount)) /\n    (COUNT(*) * SUM(month_int * month_int) - SUM(month_int) * SUM(month_int)) AS slope\n  FROM last3\n  GROUP BY State\n),\nrep_counts AS (\n  SELECT\n    c.State,\n    e.FirstName || ' ' || e.LastName AS rep_name,\n    COUNT(*) AS customer_count\n  FROM Customer c\n  JOIN Employee e ON c.SupportRepId = e.EmployeeId\n  GROUP BY c.State, rep_name\n)\nSELECT\n  sm.State,\n  sm.moving_avg,\n  sm.avg_tracks_per_invoice,\n  sc.slope,\n  rc.rep_name\nFROM state_metrics sm\nJOIN slope_calc sc ON sm.State = sc.State\nJOIN rep_counts rc ON rc.State = sm.State\nORDER BY sc.slope DESC\nLIMIT 1;",
              "success": true
            }
          ]
        }
      ]
    }
  }
}
