---
title: Training Data Overview
description: Generate question/SQL pairs for fine-tuning and evaluation
---

The synthesis module helps you generate training data for fine-tuning models or evaluating Text2SQL performance. It produces `ExtractedPair` objects containing natural language questions paired with their SQL queries.

## Use Cases

- **Fine-tuning** - Generate training pairs to improve model accuracy on your schema
- **Evaluation** - Create test sets to measure query generation quality
- **Data augmentation** - Expand existing pairs with variations and paraphrases

## Core Concepts

### ExtractedPair

Every producer outputs the same structure:

```typescript
interface ExtractedPair {
  question: string;    // Natural language question
  sql: string;         // SQL query that answers the question
  context?: string[];  // Preceding messages (for multi-turn)
  success: boolean;    // Whether the query is valid/executed successfully
}
```

### PairProducer

All extractors and synthesizers implement this abstract class:

```typescript
abstract class PairProducer<T extends ExtractedPair> {
  abstract produce(): AsyncGenerator<T[], void, unknown>;
}
```

The streaming pattern yields chunks of pairs, allowing for efficient memory usage and real-time processing.

### toPairs()

Helper function to iterate any producer's AsyncGenerator:

```typescript
import { toPairs, SqlExtractor } from '@deepagents/text2sql';

const pairs = await toPairs(new SqlExtractor(sqls, adapter));
```

Implementation:

```typescript
export async function toPairs<T extends ExtractedPair>(
  producer: PairProducer<T>,
): Promise<T[]> {
  const pairs: T[] = [];
  for await (const chunk of producer.produce()) {
    pairs.push(...chunk);
  }
  return pairs;
}
```

Or pass the producer directly to `toPairs()`:

```typescript
const pairs = await toPairs(new SqlExtractor(sqls, adapter));
```

## Extractors vs Synthesizers vs Generators

| Type | Input | Output | Use Case |
|------|-------|--------|----------|
| **Extractors** | Chat history, SQL logs | Pairs harvested from real usage | Production data mining |
| **Synthesizers** | Schema or seed pairs | Newly generated pairs | Bootstrapping, augmentation |
| **Generators** | Schema | Personas or Teachings | Pipeline setup |

### Extractors

Harvest pairs from existing artifacts:

- [MessageExtractor](/docs/text2sql/from-history) - Parse chat history for db_query tool calls
- [SqlExtractor](/docs/text2sql/from-sql) - Generate questions for existing SQL queries
- Contextual extractors - Handle multi-turn conversations with context

### Synthesizers

Generate new pairs from scratch:

- [SchemaSynthesizer](/docs/text2sql/from-schema) - Generate pairs from database schema
- [BreadthEvolver](/docs/text2sql/breadth-evolver) - Paraphrase questions (in-breadth evolution, keeps same SQL)
- [DepthEvolver](/docs/text2sql/depth-evolver) - Evolve to more complex questions (in-depth evolution, changes both Q and SQL)

### Generators

Generate supporting artifacts for the pipeline:

- [PersonaGenerator](/docs/text2sql/persona-generator) - Generate user personas from schema
- [TeachingsGenerator](/docs/text2sql/teachings-generator) - Generate domain teachings from schema

## Evol-Instruct Methodology

The synthesis module implements Microsoft's Evol-Instruct methodology for instruction tuning:

- **BreadthEvolver** - In-breadth evolution: Creates paraphrased variations of questions while keeping the same SQL query. This increases dataset diversity without changing the underlying query complexity.

- **DepthEvolver** - In-depth evolution: Transforms questions into more complex versions that require changes to both the question and SQL query. This progressively increases dataset difficulty and model capabilities.

This two-pronged approach ensures both breadth (variety) and depth (complexity) in your training data.

## Decorators

Decorators wrap producers to add functionality:

### ValidatedProducer

Validate SQL and optionally execute queries:

```typescript
import { ValidatedProducer, MessageExtractor } from '@deepagents/text2sql';

const validated = new ValidatedProducer(
  new MessageExtractor(messages),
  adapter,
  { execute: true }
);

const pairs = await toPairs(validated);
// Only includes pairs where SQL validated/executed successfully
```

### FilteredProducer

Filter pairs by criteria:

```typescript
import { FilteredProducer, SqlExtractor } from '@deepagents/text2sql';

const filtered = new FilteredProducer(
  new SqlExtractor(sqls, adapter),
  {
    successOnly: true,
    tables: ['orders', 'customers'], // Only pairs using these tables
  }
);
```

### DeduplicatedProducer

Remove duplicate pairs:

```typescript
import { DeduplicatedProducer, MessageExtractor } from '@deepagents/text2sql';

const deduped = new DeduplicatedProducer(
  new MessageExtractor(messages),
  { mode: 'sql' } // Dedupe by SQL only (ignore question variations)
);
```

## Composing Producers

Decorators can be chained:

```typescript
const producer = new DeduplicatedProducer(
  new FilteredProducer(
    new ValidatedProducer(
      new MessageExtractor(messages),
      adapter
    ),
    { successOnly: true }
  ),
  { mode: 'exact' }
);

const pairs = await toPairs(producer);
```

## Output Format

Export pairs for training:

```typescript
const pairs = await toPairs(new SqlExtractor(sqls, adapter));

// JSONL format (common for fine-tuning)
const jsonl = pairs
  .filter(p => p.success)
  .map(p => JSON.stringify({
    question: p.question,
    sql: p.sql
  }))
  .join('\n');

// CSV format
const csv = pairs
  .map(p => `"${p.question}","${p.sql}"`)
  .join('\n');
```

## Next Steps

- [From History](/docs/text2sql/from-history) - Extract pairs from chat logs
- [From SQL](/docs/text2sql/from-sql) - Generate questions for existing queries
- [From Schema](/docs/text2sql/from-schema) - Synthesize pairs from database schema
- [Breadth Evolution](/docs/text2sql/breadth-evolver) - Create paraphrased variations
- [Depth Evolution](/docs/text2sql/depth-evolver) - Generate more complex questions
- [Persona Generator](/docs/text2sql/persona-generator) - Generate user personas
- [Teachings Generator](/docs/text2sql/teachings-generator) - Generate domain teachings
